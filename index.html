<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chillinguito Lake Como - v11 FINAL</title>
    <script type="text/javascript" src="https://gc.kes.v2.scr.kaspersky-labs.com/7EA5E9BB-55E1-4C31-9C21-4943DDFED2E4/main.js?attr=E3BGBaqnRElHG-mh94sARHsVHELra2DdjQ1nHNbiPRFriwvVMOpzfceSsXnF62YctmcySgOAMdurYEkqASnfIdOxzzrLzODKcv3Ocg_Tqw6jy3jt8enDLg-r_6pt72T3MYZpq67Gk4B-4zNJihadnT0Pb1j7eBYwnPA8E0aA4uDTrfB2SMDxAl23TGcKNsB99Zjz0V6Qq_o35qYc1NA9T0H52_7vAOtY_x2wMdLJgYLsfp2oJvMukN_pAK2_a7DByYSMDWKeJLTEIBskBiFRQ9SHg45sL5GYOS2HT4QdrCoBmzYaVmBH0G2_-qNt7vBdKtM5HePr_jkQgYFVzn4KcSeLtiilo1Op3WLLbs0ub6gdzAFMqR4bkThdESOxfXVLEkE-qb4O68OlplrtWYrLefpgyDW-56IbjFMO_CGt49vC0pzQpNwgzifs-PR_JckvYWK0KW91-GbYuFT1frXY02guM-TtZ8aw4d3SXhigT18QvKfnsWlKqTto9N8fUEZly8ppSuFPbsHRHLVuB13saz3OC7fViB02nxxnD68bWWZv27G5S4tL06-x7ouY2KBeKeL8JRPhFeR11eDJ8V9_kvBVMlLX2NydiIVnsSLlhzhN4WtC1-2J3GP0F19sJk70GMN2g_-HLzHAf5-7l6F7lAld7peFkxfR_Mq2BfiDEyWtfFt13mjpAirIiC_PKtQySseCcyq3PKyMLlvbTCluszJHsWf3HIejjaeDf0ogwwshla0tsFR6vhvMCUnDjtlQgVkoeRtiTRaSvqZ3lXv0-gev0ibynUp96KMuz3MRBmfCkMUf0cJCjhjUa0NNdE6_IVuzcCYijG-p1eKNDFWrehEMIc9i58ECV-NqvTTWBrw7uh4OYemi9Ic8zLEDCaRyFzqIud4L8kk0YNS358OYKiU8mXj2juNtPihA3k8eLscE03eB3ANu7zFy_6wuxIIoU72AnAA4ZjolVVvjZJlOT18NBQnIJsmgM9B5gpYquoxmjm6yzpfhYDCI1vjcRmUO_8QRKob2MR9LY2qI1eVXLiFfVC8UMW7slR3dT1ElyHYQrbRj9wgm1y6Y2z2peEmddaKCGjDzfGhtGy35woqILUpdjFAMvcze506D1xUfpiOkY2f-665LsIText7SEtzA-uMjWSD44OphsGEebD0hoW7_nU-m-VHDCZ8LQEYWmZLRZ1q47z22dBphkLW1aLAtXDdOm6J0xNoe-aW_MGwq2fY4tpZIMfZ0TehDIAoI7ToUYB4NpTT3OKxBUP7C55HA-Oae7raUhiapXUNLSu_1SHdQUHy9Hk_5uOQQCfPwqWWJza81HMJmLWTF7D2taeP9zytMqrP4fLwU7S5wyyg6xkQiB6rS01pgltJFz8JkvLeGljnMHv4Yu-PxbcksJgMOR4QcrERsnkjLFAeDQlSXzKDjW5bTUy0aIrF79PZxJE006E5Srwinsy45C4kF0vX4sReUySuu9ZZT_TChfOZE-z4EdltF-F1U5xzBUM3bzUeAS5kN0uWNqYlk6-fBj7LfZu0r8bXMpBytFhJDi6pfJP1BAuuZLzmQDLRHL1E0vA5m78_IRLPmMTM58WscHtrth2IWNXBnFb34f8pybOh-dPOrA05vkS_wFvPb2szGXECDxEl4EhiaMMz24_L1kGQrFuvmJHX-5s_43r51HPHRWs9muxkq7MTX9ETJwKVX4QJPgi1sDJBQAwn6iQs8KjeYLKz6B7tzRuLOLDus5jeoVapaRZotQGm2iOVRM4L_iYivGJcVxY3-g7opOTzKCVY366i1CYhYCORVDHl6hqZZQRqyyUmFZbD_CFSb_59fs0KfZ8WwJrN2ejhS5SGc19tWZ53CId8rVU0rMIySCDgVLO0RYhHO_fhtnoywwj7uHe4eKC7xEtNYOYp11Ok65LB2vsH_7kqVoe3bWVWW7FvmMoMnVfiE3edp9JdbD0dsZKPJY-JLOqpez0mV5IoY2TAXdOYpIkzd7wWxV-ULNqIuRH11jZU24PQ1vL_hIt2kDQ4PVn6z1j7hGRgQiVClpAnE8F3OnVTXjOPEhbgexc_JSFSvyvWcAGMexIoQC-V4zg8UMy6XGKlUSjZwxNNeYV6s_ihq0sbW9MwcvOYhbsOcT0wzyBs4bwDuZ6oACBIUGvIrvuSeDe35ljVBbXEk3eXRKGdl8JOdEgU7u6998kjjWng519344SEewOCEfs3PmPJBp5X4F1ysieoLj3GqWoba0-GgQiJGt3aLXu-A27un2kOIlUlqMLund22I2hZD719lfwwOmH1DE5VgGe7xWwMUYVeFrcDFppeh9jm6P5jfdfNIkRPyn5Nq11DT3Hg8F25jt6TG8Xu3-0NZtnYqMfdJ" charset="UTF-8"></script><script type="text/javascript" src="https://gc.kes.v2.scr.kaspersky-labs.com/7EA5E9BB-55E1-4C31-9C21-4943DDFED2E4/main.js?attr=SyZ-6RCmlILFtBs8u74iELEkHZ4IPvdXR9dvowxG--BJS8iAKTg102AZLHJGLvpr3DlaZauO2mYyHskXfWH7XWXjTb6kSBXQ9_QfoQuY7FG4xDv-IzuDIFxeAuBu9e7apiv-QUJO-BxwK7OQ5nHDMwPcJ-5Sp8u1d3LV2umWNK-72lZXiWN2ts0HHTbWgpyPBAx0c4cYnxpo013kDuePlkAzkKPeudkTBGAWunk8hy-1WrVSxa95lcrMPWOK0OiIgYo-dn4cBAVzivggL9OQVf3puD-jyctYdeiOEzTHYIkU6uYdEfB8_eWbbcxLspkYG1jZu-o1wBvG0ZHufajjOSI4t1cP4OkW7mxDkJZa2Kze0APFZ_glM5Oii93HtDHkLcRch54sIechFSWkAdBQsrqGt1RWUaOkR0WhAdnAcOC7Rlh7YrnDAT9HE8q86a1mlECKZjSBr-AZdFBYl6m1x716zJtGitOorzHZYbkD025Rwi5CC0ysHq55x5LJRay07BiTbrpYUiE_aqrWOk2WqB9auNGFcKeu1AdUHVcvN1P41gcEGfOw9B3s4U8hzEPvE_Ga6T3r9SyHpJafrgjlRRJpCBhkuFQQ7FU2VmGqmiKjDqMtQsMlg72SBEj5AsZC6ttMQD9cIGBnY67Y7L-3r1xOju6TX2SXyaFpI8SAk0YyX_MgMhx_TjkcFWpsbNJUb40xK_gsyj6N8zts1VuU_UNvF6E13CNml8MICQb9S1ZzcQVrTq7Wu9EyYAoPvtoTAmltgASTOyShKFpmhjX0w96YSrGdphZaiWuUEk8GL3v8PoZavASRkl-1yTqcwHYUypswbqvkz84u3OQPKAHOa3AY9guBzLUEPnxO6Tm_kUvcGaSr_IpDSP8lWHGxMjeZJyc1p5JdwU-vqAEUPcjMKSOTp-w1fUnxJUObWyBXbUuI-z4qoo3Ws_NGpE6le4Oc-3_Y-lLxivMywXjV2llFuxEARA0Ld5sylrVsxacYWaaOpylbCe7tnxke7RTw2Rd3lyO7fXiAvUxrAaSukQIdbcSMDXTl28GhOSileYTv5p-2Y8k2iL5rJPZE4OpNyDoXoZIlGivWtf911fqe--dEnGO2ru-PlOqdE7k9TDSuuc67evzz2V3tIqB814HJfDcE9dso2ho1f4ajSui2OJcsmUj6684F3WRAWTFKF1uG88LCARsGMX1ghJbgwtOzsED2l81emhvQ7YTATiufm40uafBDKEy2tB6yNb9Cg15iw7dtwEFwRAxsbhdqBfLgLBqoE4aef2oYIDB7wTo8S37xn6j0_WYkz_3QK4Pi93ezPxaJQP1JjdmWdl51u8LcD5V4UZRCGXTKJtO7_0nL4cwk27kwU9qcq293MYRzzLzp-Bk_Z2I68jE-9V1R3-lX26hFm3eXL_9oj_WtjPgAw-UjCLJm2fWn_ssCmjwNQLcjZ7NEFZH6oSBm-nLvmNK2twreqwboPjDILUuBzRdZXzCWDFDxGf-qKfcSprdwK5bP35EPrX4APIjCnrfqt2CvsvwYztG-akMwFPSE27P4vkOs7TbQ0oFgM6X8-xDbnmH2ZhsukGQgWSSxoCWym65NYSdIwlHVqWqoja8H4IY2P6H0hwvlgZ4lRMidD-viHVQj1856T-wEq_JPz6mOyuAyK-_jypK6ZRtdKBRq0N8kYTulczM3-y2GQkFYdFCohet6fBCy6h9AmG0kV36vYUzvJS30x1-wRdpGVwOfpYsAoXCKt1MJC_wgRcDCddFkCU3gkoj326d-_VayBOlHzFkmwyi0lR_JQBkA7fWRPJQLXJ_f4GRp6CLyvy47e2Nwqyvccqg3TVAn0OwGHSaTTjvNYnj5W8vPDZmPzSq9VTpzpdcUwtNQFwr1TYjDAoPQbqtmRttD-jpkBBCRNoLt8LBfGhe1Q55txuypFE5kMI-JbCYfG3acaALwO_HGegE2ZJh6dgmXFZoiDacNEsjVPqhXb9BzLu6lvt8KRE_5HvHaBu4QkFg16SuDho5Purki83T8sUVpizr4M1akEglWIqa1HOhzESwCKFaGPOXCI9Xdvo4HjP9YoFVoIiWR3REnkAZ8qjyNrH0Ouv7dzJYq8KwI9fdv6BBpAlYSyl4Gl-qhlJzfW-m_XwWJugsYiYi0MyXV_mCGJXfYnVrC0liOVVt-96aPchHPJxL6_XmJLzVj5q6pJaxN821rIhbhO9G06tJ70fW-QGofoss_yePZrH_-TmI14azJUA04UExUA_h9kHFH3K8cljegEPgLIqP1ESkV0672YSx2EPLsm5UjebJXoJEyoFdCS0NYdWEXsSWHvWt5pVw" charset="UTF-8"></script>
    <script type="text/javascript" src="https://gc.kes.v2.scr.kaspersky-labs.com/7EA5E9BB-55E1-4C31-9C21-4943DDFED2E4/main.js" charset="UTF-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root {
            --primary: #2196F3;
            --primary-dark: #1976D2;
            --success: #4CAF50;
            --danger: #f44336;
            --warning: #ff9800;
            --light: #f5f5f5;
            --border: #e0e0e0;
            --text: #333;
            --text-secondary: #666;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--light);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        body.locked {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .auth-screen {
            background: white;
            border-radius: 16px;
            padding: 32px 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            text-align: center;
            width: 100%;
            max-width: 380px;
            margin: auto;
        }
        
        .auth-screen h1 {
            color: var(--primary);
            margin: 0 0 8px 0;
            font-size: 28px;
            letter-spacing: -0.5px;
            white-space: nowrap;
        }
        
        .auth-screen p {
            color: var(--text-secondary);
            margin: 0 0 24px 0;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .auth-screen .icon {
            font-size: 48px;
            margin-bottom: 16px;
            display: block;
        }
        
        .user-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 24px;
        }
        
        .user-btn {
            padding: 12px 8px;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: white;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
            min-height: 70px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .user-btn:hover {
            border-color: var(--primary);
            background: rgba(33, 150, 243, 0.05);
        }
        
        .user-btn.selected {
            border-color: var(--primary);
            background: rgba(33, 150, 243, 0.1);
            color: var(--primary);
        }
        
        .user-icon {
            font-size: 24px;
            display: block;
        }
        
        .totp-input {
            display: flex;
            gap: 6px;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .totp-digit {
            width: 42px;
            height: 42px;
            border: 2px solid var(--border) !important;
            border-radius: 8px;
            text-align: center;
            font-size: 20px !important;
            font-weight: 600;
            color: var(--primary);
            padding: 0 !important;
        }
        
        .totp-digit:focus {
            outline: none;
            border-color: var(--primary) !important;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }
        
        .unlock-btn {
            width: 100%;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
            min-height: 44px;
        }
        
        .unlock-btn:hover {
            background: var(--primary-dark);
        }
        
        .unlock-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .error-message {
            color: var(--danger);
            margin-top: 8px;
            font-size: 13px;
            min-height: 18px;
        }
        
        .auth-info {
            background: rgba(33, 150, 243, 0.1);
            padding: 12px;
            border-radius: 8px;
            margin-top: 16px;
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        
        @media (max-width: 480px) {
            .auth-screen {
                padding: 20px 16px;
                max-width: 90vw;
            }
            
            .auth-screen h1 {
                font-size: 24px;
                margin-bottom: 6px;
            }
            
            .auth-screen p {
                font-size: 12px;
                margin-bottom: 18px;
            }
            
            .auth-screen .icon {
                font-size: 40px;
                margin-bottom: 12px;
            }
            
            .user-btn {
                min-height: 60px;
                font-size: 13px;
                gap: 4px;
            }
            
            .user-icon {
                font-size: 20px;
            }
            
            .totp-digit {
                width: 36px;
                height: 36px;
                font-size: 18px !important;
            }
            
            .unlock-btn {
                font-size: 15px;
            }
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 12px;
        }

        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 16px 0;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        header p {
            font-size: 13px;
            opacity: 0.9;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .header-status {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .status-badge {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4CAF50;
            display: inline-block;
        }

        .status-dot.offline {
            background: #999;
        }

        .user-badge {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 12px;
            border-radius: 20px;
            font-weight: 500;
            font-size: 14px;
            min-height: 40px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            min-height: 40px;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .sync-status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 600;
            color: white;
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 12px;
            border-radius: 20px;
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4CAF50;
        }

        .sync-dot.syncing {
            background: #ff9800;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            background: transparent;
            flex-wrap: nowrap;
            overflow-x: auto;
            padding: 0;
            -webkit-overflow-scrolling: touch;
            border-bottom: none;
        }

        .tab-btn {
            padding: 10px 16px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
            flex-shrink: 0;
            min-height: 44px;
            display: flex;
            align-items: center;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 14px;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        input[type="date"] {
            width: 100%;
            padding: 12px 14px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }

        @media (min-width: 600px) {
            .form-row {
                grid-template-columns: 1fr 1fr;
            }
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            min-height: 44px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--light);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: #f0f0f0;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
            padding: 8px 14px;
            font-size: 14px;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
            gap: 12px;
        }

        .expense-item {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 16px;
            background: var(--light);
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .expense-receipt {
            margin-top: 10px;
            max-width: 200px;
        }

        .expense-receipt img {
            width: 100%;
            border-radius: 6px;
        }

        .expense-info {
            flex: 1;
        }

        .expense-description {
            font-weight: 500;
            font-size: 15px;
            margin-bottom: 4px;
        }

        .expense-details {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .expense-amount {
            font-weight: 600;
            color: var(--primary);
            font-size: 18px;
        }

        .settlement-banner {
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-weight: 600;
            text-align: center;
            font-size: 18px;
        }

        .settlement-banner.paid {
            background: rgba(76, 175, 80, 0.1);
            color: #2e7d32;
            border-left: 4px solid #4CAF50;
        }

        .settlement-banner.owed {
            background: rgba(244, 67, 54, 0.1);
            color: #c62828;
            border-left: 4px solid #f44336;
        }

        .settlement-box {
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-weight: 500;
            text-align: center;
        }

        .settlement-box.owed {
            background: rgba(244, 67, 54, 0.1);
            color: #c62828;
            border-left: 4px solid #f44336;
        }

        .settlement-summary {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .summary-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--primary);
            text-align: center;
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-box {
            background: var(--light);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-box-large {
            background: var(--light);
            padding: 24px;
            border-radius: 12px;
            text-align: center;
            grid-column: 1 / -1;
            border: 2px solid var(--primary);
        }

        .stat-box-large .stat-label {
            font-size: 14px;
        }

        .stat-box-large .stat-value {
            font-size: 36px;
        }

        .stats-secondary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
        }

        .progress-bar-container {
            width: 100%;
            background: #e0e0e0;
            border-radius: 10px;
            height: 20px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 11px;
            font-weight: 600;
        }

        .no-data {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .category-badge {
            display: inline-block;
            padding: 4px 8px;
            background: var(--primary);
            color: white;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-right: 8px;
        }

        .user-badge-inline {
            display: inline-block;
            padding: 2px 6px;
            background: rgba(33, 150, 243, 0.2);
            color: var(--primary);
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 6px;
        }

        .calendar-container {
            background: white;
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            min-height: 500px;
            width: 100%;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .calendar-header h2 {
            color: var(--primary);
            font-size: 18px;
            margin: 0;
            flex: 1;
            text-align: center;
        }

        .calendar-nav {
            display: flex;
            gap: 6px;
        }

        .calendar-nav button {
            padding: 8px 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            min-height: 40px;
            flex-shrink: 0;
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 4px;
        }

        .weekday {
            text-align: center;
            font-weight: 600;
            color: var(--text-secondary);
            padding: 8px 0px;
            font-size: 11px;
            text-transform: uppercase;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            min-height: 320px;
        }

        .calendar-day {
            aspect-ratio: 1.2 / 1;
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 2px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 11px;
            position: relative;
            min-height: 50px;
            overflow: hidden;
        }

        .calendar-day:active:not(.other-month) {
            transform: scale(0.95);
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        .calendar-day.other-month {
            background: var(--light);
            color: var(--text-secondary);
            opacity: 0.3;
            cursor: default;
            border-color: transparent;
        }

        .calendar-day-number {
            font-weight: 700;
            font-size: 11px;
            line-height: 1;
            margin-bottom: 1px;
        }

        .calendar-day-status {
            font-size: 8px;
            text-transform: uppercase;
            font-weight: 700;
            line-height: 1;
        }

        .calendar-day.occupied {
            background: #FF6B6B;
            border-color: #D32F2F;
            color: white;
        }

        .calendar-day.available {
            background: #51CF66;
            border-color: #2F9E44;
            color: white;
        }

        .calendar-day.cleaning {
            background: #FFA94D;
            border-color: #F76707;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            padding: 24px;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--primary);
            font-size: 18px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-secondary);
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .day-status-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .status-option {
            padding: 16px 12px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: white;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            min-height: 60px;
            transition: all 0.2s;
        }

        .status-option.selected {
            border-color: var(--primary);
            background: rgba(33, 150, 243, 0.1);
        }

        .export-section {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        .notification-banner {
            background: #4CAF50;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            animation: slideIn 0.3s ease-out;
        }

        .notification-banner.warning {
            background: #FF9800;
        }

        .notification-banner.error {
            background: #f44336;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .lang-btn, .theme-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s;
            min-height: 40px;
        }

        .lang-btn.active {
            background: white;
            color: var(--primary);
            font-weight: 600;
        }

        [data-theme="dark"] {
            --primary: #64B5F6;
            --primary-dark: #42A5F5;
            --text: #e0e0e0;
            --text-secondary: #b0b0b0;
            --light: #2a2a2a;
            --border: #404040;
            --background: #121212;
        }

        [data-theme="dark"] body {
            background: var(--background);
        }

        [data-theme="dark"] .card,
        [data-theme="dark"] .settlement-summary,
        [data-theme="dark"] .calendar-container,
        [data-theme="dark"] .modal-content,
        [data-theme="dark"] .export-section,
        [data-theme="dark"] .auth-screen {
            background: #1e1e1e;
        }

        [data-theme="dark"] input, [data-theme="dark"] select, [data-theme="dark"] textarea {
            background: #2a2a2a;
            color: var(--text);
            border-color: var(--border);
        }

        [data-theme="dark"] .user-btn {
            background: #2a2a2a;
            color: var(--text);
            border-color: var(--border);
        }

        [data-theme="dark"] .user-btn.selected {
            background: rgba(100, 181, 246, 0.1);
            border-color: #64B5F6;
            color: #64B5F6;
        }

        .filter-section {
            background: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .filter-input {
            flex: 1;
            min-width: 120px;
        }

        .filter-input input, .filter-input select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
        }

        .payment-input-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            align-items: flex-end;
        }

        .payment-input-group input {
            flex: 1;
            min-width: 120px;
        }

        .payment-input-group button {
            flex-shrink: 0;
        }

        .settlement-payments {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .payment-history {
            margin-top: 10px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .payment-item {
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .camera-btn {
            width: 100%;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .camera-btn:hover {
            background: var(--primary-dark);
        }

        #cameraInput, #guestDocumentInput, #guestGalleryInput, #guestPhotoInput, #documentInput {
            display: none;
        }

        /* GUEST STYLES */
        .guest-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .guest-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .guest-info h3 {
            margin: 0 0 4px 0;
            color: var(--primary);
            font-size: 16px;
        }

        .guest-dates {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .guest-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .guest-status.upcoming {
            background: rgba(255, 152, 0, 0.2);
            color: #f57c00;
        }

        .guest-status.current {
            background: rgba(76, 175, 80, 0.2);
            color: #388e3c;
        }

        .guest-status.completed {
            background: rgba(158, 158, 158, 0.2);
            color: #616161;
        }

        .guest-documents {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .doc-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: var(--light);
            border-radius: 6px;
            margin-bottom: 6px;
            font-size: 13px;
        }

        .doc-item-name {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .doc-item-actions {
            display: flex;
            gap: 6px;
        }

        .doc-btn {
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .doc-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .guest-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .guest-actions button {
            flex: 1;
            padding: 8px 12px;
            font-size: 14px;
        }

        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }

        .gallery-item {
            position: relative;
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
        }

        .gallery-item img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            display: block;
        }

        .gallery-item-remove {
            position: absolute;
            top: 0;
            right: 0;
            background: rgba(244, 67, 54, 0.9);
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 16px;
            padding: 0;
            display: none;
        }

        .gallery-item:hover .gallery-item-remove {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .accompanied-guests-section {
            background: rgba(33, 150, 243, 0.05);
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            border: 1px solid rgba(33, 150, 243, 0.2);
        }

        .accompanied-guests-section h4 {
            color: var(--primary);
            margin-bottom: 12px;
            font-size: 14px;
        }

        .guest-info-row {
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            border: 1px solid var(--border);
        }

        .tourist-tax-section {
            background: rgba(255, 193, 7, 0.05);
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            border: 1px solid rgba(255, 193, 7, 0.2);
        }

        .tourist-tax-section h4 {
            color: #f57f17;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .tourist-tax-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            align-items: center;
        }

        .tourist-tax-amount {
            font-weight: 600;
            color: var(--primary);
            font-size: 18px;
        }

        .tourist-tax-paid {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tourist-tax-paid input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

            @media (max-width: 480px) {
        /* AUTH SCREEN - LAKE COMO DESIGN */
        #authScreen {
            background: linear-gradient(135deg, rgba(30, 58, 138, 0.4), rgba(100, 181, 246, 0.4)),
                        url('https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=1400&q=90') center/cover;
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .auth-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
        
        .auth-container {
            background: white;
            border-radius: 24px;
            padding: 48px 36px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
            width: 100%;
            max-width: 450px;
            text-align: center;
        }
        
        .auth-icon {
            font-size: 56px;
            margin-bottom: 20px;
            display: block;
        }
        
        .auth-container h1 {
            color: #2196F3;
            font-size: 40px;
            font-weight: 700;
            margin: 0 0 12px 0;
            letter-spacing: -0.5px;
        }
        
        .auth-container p {
            color: #666;
            font-size: 15px;
            margin: 0 0 32px 0;
            line-height: 1.5;
        }
        
        .auth-step {
            margin-bottom: 28px;
        }
        
        .user-grid {
            display: flex;
            gap: 16px;
            margin-bottom: 28px;
            justify-content: center;
        }
        
        .user-choice {
            padding: 14px 28px;
            border: 2px solid #ddd;
            border-radius: 24px;
            background: white;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-width: 140px;
            color: #333;
        }
        
        .user-choice:hover {
            border-color: #2196F3;
            background: rgba(33, 150, 243, 0.05);
        }
        
        .user-choice.active {
            border-color: #2196F3;
            background: rgba(33, 150, 243, 0.1);
            color: #2196F3;
        }
        
        .user-choice span:first-child {
            font-size: 20px;
        }
        
        .auth-step label {
            display: none;
        }
        
        .code-input {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin: 24px 0 32px 0;
            flex-wrap: wrap;
        }
        
        .code-box {
            width: 48px;
            height: 48px;
            font-size: 22px !important;
            font-weight: 600;
            text-align: center;
            border: 2px solid #ddd !important;
            border-radius: 10px;
            color: #333;
            background: white !important;
            padding: 0 !important;
            transition: all 0.2s ease;
        }
        
        .code-box:focus {
            outline: none;
            border-color: #2196F3 !important;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }
        
        .unlock-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            border: none;
            border-radius: 24px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 56px;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
            margin-bottom: 16px;
        }
        
        .unlock-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
        }
        
        .unlock-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .error-message {
            color: #f44336;
            font-size: 13px;
            margin-bottom: 16px;
            min-height: 18px;
        }
        
        .auth-info {
            background: rgba(255, 193, 7, 0.08);
            border: 1px solid rgba(255, 193, 7, 0.2);
            padding: 14px;
            border-radius: 12px;
            font-size: 13px;
            color: #555;
            line-height: 1.5;
        }
        
        @media (max-width: 480px) {
            .auth-container {
                padding: 32px 24px;
                max-width: 95vw;
                border-radius: 20px;
            }
            
            .auth-icon {
                font-size: 44px;
                margin-bottom: 16px;
            }
            
            .auth-container h1 {
                font-size: 32px;
            }
            
            .auth-container p {
                font-size: 14px;
                margin-bottom: 24px;
            }
            
            .user-choice {
                min-width: 120px;
                padding: 12px 20px;
                font-size: 14px;
            }
            
            .code-box {
                width: 44px;
                height: 44px;
                font-size: 20px !important;
            }
            
            .unlock-btn {
                font-size: 16px;
                padding: 14px;
            }
        }
        
    

        @media (max-width: 600px) {
            .calendar-container { padding: 8px; }
            .calendar-day { aspect-ratio: 1.1 / 1; min-height: 44px; padding: 1px; }
            .filter-section { flex-direction: column; }
            .filter-input { min-width: 100%; }
            .header-status { gap: 6px; }
            .guest-header { flex-direction: column; }
            .guest-info-row { grid-template-columns: 1fr; }
            .tourist-tax-row { grid-template-columns: 1fr; }
        }
        @media (max-width: 500px) {
            .auth-screen {
                padding: 24px;
                max-width: 90vw;
            }
            
            .auth-screen h1 {
                font-size: 22px;
                margin-bottom: 6px;
            }
            
            .auth-screen p {
                font-size: 13px;
                margin-bottom: 16px;
            }
            
            .auth-screen .icon {
                font-size: 40px;
                margin-bottom: 12px;
            }
            
            .user-selector {
                gap: 8px;
            }
            
            .user-btn {
                min-width: 90px;
                min-height: 65px;
                padding: 12px;
                font-size: 14px;
            }
            
            .totp-digit {
                width: 38px;
                height: 38px;
                font-size: 18px;
            }
            
            .unlock-btn {
                padding: 10px;
                font-size: 15px;
            }
        }
        
    </style>
</head>
<body id="appBody">
    <!-- AUTH SCREEN -->
<div id="authScreen" class="auth-screen">
    <div class="auth-container">
        <div class="auth-icon">üè†</div>
        <h1 id="authTitle">Chillinguito</h1>
        <p id="authSubtitle">Select your account & enter 2FA code</p>
        
        <div class="auth-step">
            <div class="user-grid">
                <button class="user-choice" data-user="davide">
                    <span>üë®</span>
                    <span>Davide</span>
                </button>
                <button class="user-choice" data-user="mattia">
                    <span>üë®</span>
                    <span>Mattia</span>
                </button>
            </div>
        </div>

        <div class="auth-step">
            <label id="authCodeLabel">Enter 6-digit code:</label>
            <div class="code-input">
                <input type="text" class="code-box" maxlength="1" inputmode="numeric">
                <input type="text" class="code-box" maxlength="1" inputmode="numeric">
                <input type="text" class="code-box" maxlength="1" inputmode="numeric">
                <input type="text" class="code-box" maxlength="1" inputmode="numeric">
                <input type="text" class="code-box" maxlength="1" inputmode="numeric">
                <input type="text" class="code-box" maxlength="1" inputmode="numeric">
            </div>
        </div>

        <button id="unlockBtn" class="unlock-btn">Unlock</button>
        <div id="errorMsg" class="error-message"></div>
        <div id="authInfo" class="auth-info">üí° Both users use the same code from Microsoft Authenticator</div>
    </div>
</div>

    <!-- MAIN APP -->
    <div id="mainApp">
        <header>
            <div class="container">
                <div class="header-top">
                    <div>
                        <h1 id="appTitle">üè† Chillinguito Lake Como</h1>
                        <p id="appSubtitle">Expense Tracker & Guest Manager</p>
                    </div>
                    
                    <div class="header-status">
                        <div id="syncStatusIndicator" class="sync-status-indicator">
                            <div class="sync-dot" id="syncDot"></div>
                            <span id="syncStatus">Syncing...</span>
                        </div>

                        <div id="dbStatusIndicator" class="status-badge">
                            <span class="status-dot" id="dbStatusDot"></span>
                            <span id="dbStatus">DB Connected</span>
                        </div>

                        <div id="otherUserStatusIndicator" class="status-badge">
                            <span class="status-dot" id="otherUserDot"></span>
                            <span id="otherUserStatus">Mattia online</span>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <div class="user-badge" id="userBadge">
                            <span id="userIcon">üë®</span>
                            <span id="userName">Davide</span>
                        </div>
                        <button class="lang-btn active" onclick="setLanguage('en')" id="langEnBtn">üá¨üáß EN</button>
                        <button class="lang-btn" onclick="setLanguage('it')" id="langItBtn">üáÆüáπ IT</button>
                        <button class="theme-btn" onclick="toggleTheme()">üåô</button>
                        <button class="logout-btn" onclick="logout()" id="logoutBtn">üîí Logout</button>
                    </div>
                </div>
            </div>
        </header>

        <div class="container">
            <div id="notificationContainer"></div>

            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('add-expense')" id="tabAddExpense">Add Expense</button>
                <button class="tab-btn" onclick="switchTab('expenses-list')" id="tabExpensesList">All Expenses</button>
                <button class="tab-btn" onclick="switchTab('settlement')" id="tabSettlement">Settlement</button>
                <button class="tab-btn" onclick="switchTab('guests')" id="tabGuests">üë• Guests</button>
                <button class="tab-btn" onclick="switchTab('calendar')" id="tabCalendar">Calendar</button>
                <button class="tab-btn" onclick="switchTab('export')" id="tabExport">Export</button>
            </div>

            <!-- ADD EXPENSE TAB -->
            <div id="add-expense" class="tab-content active">
                <div class="card">
                    <h2 id="addExpenseTitle" style="margin-bottom: 20px;">Add New Expense</h2>
                    <form onsubmit="addExpense(event)">
                        <div class="form-group">
                            <label for="description" id="descLabel">Description</label>
                            <input type="text" id="description" placeholder="e.g., Cleaning supplies, Groceries" required>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="amount" id="amountLabel">Amount (EUR)</label>
                                <input type="number" id="amount" placeholder="0.00" step="0.01" min="0" required>
                            </div>
                            <div class="form-group">
                                <label for="category" id="categoryLabel">Category</label>
                                <select id="category" required>
                                    <option value=""></option>
                                    <option value="Cleaning" id="catCleaning">Cleaning & Maintenance</option>
                                    <option value="Utilities" id="catUtilities">Utilities (Water, Gas, Electric)</option>
                                    <option value="Groceries" id="catGroceries">Groceries & Food</option>
                                    <option value="Repairs" id="catRepairs">Repairs & Equipment</option>
                                    <option value="Other" id="catOther">Other</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="paidBy" id="paidByLabel">Paid By</label>
                                <select id="paidBy" required>
                                    <option value=""></option>
                                    <option value="Davide">Davide</option>
                                    <option value="Mattia">Mattia</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="splitBetween" id="splitLabel">Split Between</label>
                                <select id="splitBetween" required>
                                    <option value=""></option>
                                    <option value="Both" id="splitBoth">Both (50/50)</option>
                                    <option value="Davide" id="splitDavide">Davide Only</option>
                                    <option value="Mattia" id="splitMattia">Mattia Only</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="date" id="dateLabel">Date</label>
                            <input type="date" id="date" required style="width: 100%;">
                        </div>

                        <div class="form-group">
                            <label for="notes" id="notesLabel">Notes (optional)</label>
                            <textarea id="notes" placeholder="Add notes..." rows="3"></textarea>
                        </div>

                        <div class="form-group">
                            <button type="button" class="camera-btn" onclick="openCamera()" id="cameraBtn">üì∑ Take Receipt Photo</button>
                            <input type="file" id="cameraInput" accept="image/" capture="environment" onchange="handleCameraCapture()">
                            <div id="receiptPreview" style="margin-top: 10px;"></div>
                        </div>

                        <button type="submit" class="btn-primary" id="addExpenseBtn" style="width: 100%; padding: 12px;">Add Expense</button>
                    </form>
                </div>
            </div>

            <!-- EXPENSES LIST TAB -->
            <div id="expenses-list" class="tab-content">
                <div class="filter-section">
                    <div class="filter-input">
                        <input type="text" id="searchInput" placeholder="Search by description..." onkeyup="filterExpenses()">
                    </div>
                    <div class="filter-input">
                        <select id="filterCategory" onchange="filterExpenses()">
                            <option value="">All Categories</option>
                            <option value="Cleaning">Cleaning</option>
                            <option value="Utilities">Utilities</option>
                            <option value="Groceries">Groceries</option>
                            <option value="Repairs">Repairs</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="filter-input">
                        <select id="filterMonth" onchange="filterExpenses()">
                            <option value="">All Months</option>
                        </select>
                    </div>
                    <div class="filter-input">
                        <select id="filterYear" onchange="filterExpenses()">
                            <option value="">All Years</option>
                        </select>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h2 id="allExpensesTitle">All Expenses</h2>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn-secondary" onclick="clearAllExpenses()" id="clearAllBtn" style="color: var(--danger);">Clear All</button>
                        </div>
                    </div>
                    <div id="expensesList"></div>
                </div>
            </div>

            <!-- SETTLEMENT TAB -->
            <div id="settlement" class="tab-content">
                <div class="settlement-summary">
                    <div class="settlement-banner" id="settlementBanner"></div>
                    
                    <div class="summary-title" id="settlementTitle">Current Settlement Status</div>
                    
                    <div class="stats">
                        <div class="stat-box-large">
                            <div class="stat-label" id="totalLabel">Total Expenses</div>
                            <div class="stat-value" id="totalExpenses">EUR 0.00</div>
                        </div>
                    </div>

                    <div class="stats-secondary">
                        <div class="stat-box">
                            <div class="stat-label" id="davidePaidLabel">Davide Paid</div>
                            <div class="stat-value" id="davidePaid">EUR 0.00</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label" id="mattiaPaidLabel">Mattia Paid</div>
                            <div class="stat-value" id="mattiaPaid">EUR 0.00</div>
                        </div>
                    </div>

                    <div style="margin-top: 20px;">
                        <h3 id="whoOwesLabel" style="margin-bottom: 15px; color: var(--primary);">üí∏ Who Owes Whom</h3>
                        <div id="settlementDetails"></div>
                    </div>

                    <div class="settlement-payments">
                        <h4 id="recordPaymentLabel" style="margin-bottom: 15px; color: var(--primary);">üí∞ Record Partial Payment</h4>
                        
                        <div id="progressContainer">
                            <div style="margin-bottom: 8px; display: flex; justify-content: space-between; font-size: 12px; color: var(--text-secondary);">
                                <span id="progressLabel">Payment Progress</span>
                                <span id="progressPercent">0%</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                            </div>
                        </div>

                        <div class="payment-input-group">
                            <input type="number" id="paymentAmount" placeholder="Amount (EUR)" step="0.01" min="0">
                            <select id="paymentFrom" style="flex: 1; min-width: 120px;">
                                <option value="davide" id="davidePayOpt">Davide pays</option>
                                <option value="mattia" id="mattiaPayOpt">Mattia pays</option>
                            </select>
                            <button type="button" class="btn-primary" onclick="recordPayment()" id="recordPaymentBtn" style="flex-shrink: 0;">Record</button>
                        </div>
                        <div id="paymentHistory" class="payment-history"></div>
                    </div>
                </div>
            </div>

            <!-- GUESTS TAB -->
            <div id="guests" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2 id="guestsTitle">üë• Guests Management</h2>
                        <button class="btn-primary" onclick="openAddGuestModal()" id="addGuestBtn">‚ûï Add Guest</button>
                    </div>

                    <div class="filter-section">
                        <div class="filter-input">
                            <input type="text" id="guestSearchInput" placeholder="Search by guest name..." onkeyup="filterGuests()">
                        </div>
                        <div class="filter-input">
                            <input type="date" id="guestDateFilter" onchange="filterGuests()">
                        </div>
                        <div class="filter-input">
                            <select id="guestStatusFilter" onchange="filterGuests()">
                                <option value="">All Status</option>
                                <option value="upcoming">Upcoming</option>
                                <option value="current">Current</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                    </div>

                    <div id="guestsList"></div>
                </div>
            </div>

            <!-- CALENDAR TAB -->
            <div id="calendar" class="tab-content">
                <div class="calendar-container">
                    <div class="calendar-header">
                        <h2 id="calendarTitle">Airbnb Calendar</h2>
                        <div class="calendar-nav">
                            <button onclick="previousMonth()" id="prevBtn">Previous</button>
                            <span id="currentMonth" style="padding: 0 20px; font-weight: 600; min-width: 150px; text-align: center;"></span>
                            <button onclick="nextMonth()" id="nextBtn">Next</button>
                        </div>
                    </div>

                    <div class="calendar-weekdays">
                        <div class="weekday" id="weekdaySun">Sun</div>
                        <div class="weekday" id="weekdayMon">Mon</div>
                        <div class="weekday" id="weekdayTue">Tue</div>
                        <div class="weekday" id="weekdayWed">Wed</div>
                        <div class="weekday" id="weekdayThu">Thu</div>
                        <div class="weekday" id="weekdayFri">Fri</div>
                        <div class="weekday" id="weekdaySat">Sat</div>
                    </div>

                    <div id="calendarDays" class="calendar-days"></div>
                </div>
            </div>

            <!-- EXPORT TAB -->
            <div id="export" class="tab-content">
                <div class="export-section">
                    <h2 id="exportTitle" style="margin-bottom: 20px;">Monthly Summary & Export</h2>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 id="expensePeriodLabel" style="margin-bottom: 10px;">Expense Period</h4>
                        <select id="expensePeriod" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 15px;">
                            <option value="1">Current Month</option>
                            <option value="3">Last 3 Months</option>
                            <option value="6">Last 6 Months</option>
                            <option value="9">Last 9 Months</option>
                            <option value="12">Last 12 Months</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h4 id="cleaningPeriodLabel" style="margin-bottom: 10px;">Cleaning Dates Period</h4>
                        <select id="cleaningPeriod" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 15px;">
                            <option value="1">Current Month</option>
                            <option value="3">Next 3 Months</option>
                            <option value="6">Next 6 Months</option>
                            <option value="9">Next 9 Months</option>
                            <option value="12">Next 12 Months</option>
                        </select>
                    </div>

                    <button class="btn-primary" id="downloadReportBtn" style="width: 100%; margin-top: 20px; font-size: 18px;" onclick="generateAndDownloadReport()">üìä Download Report</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modalContainer"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // ============ STATE ============
        const TOTP_SECRET = 'JBSWY3DPEHPK3PXP';
        let currentUser = null;
        let selectedUsername = null;
        let listenersSetup = false;
        let currentTheme = localStorage.getItem('theme') || 'light';
        let currentLanguage = localStorage.getItem('language') || 'en';
        let currentCalendarDate = new Date();
        let filteredExpenses = [];
        let filteredGuests = [];
        let receiptBase64 = null;
        let dbConnected = false;
        let otherUserOnline = false;
        let currentEditingGuestId = null;
        let guestPhotos = [];

        const firebaseConfig = {
            apiKey: "AIzaSyCwF7bvS12h3AM14gmAEKV16BjH4Bq6TWU",
            authDomain: "airbnb-expense-tracker-7f531.firebaseapp.com",
            databaseURL: "https://airbnb-expense-tracker-7f531-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "airbnb-expense-tracker-7f531",
            storageBucket: "airbnb-expense-tracker-7f531.firebasestorage.app",
            messagingSenderId: "466998817774",
            appId: "1:466998817774:web:f4b244ac7cfa1723dbd4ff"
        };

        let firebaseApp = null;
        let db = null;
        let isFirebaseReady = false;

        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            isFirebaseReady = true;
            console.log('‚úÖ Firebase ready');
        } catch (e) {
            console.warn('Firebase init warning:', e.message);
        }

        // ============ TRANSLATIONS ============
        const translations = {
    en: {
        authTitle: "Chillinguito",
        authSubtitle: "Select your account & enter 2FA code",
        authCodeLabel: "Enter 6-digit code:",
        unlockBtn: "Unlock",
        authInfo: "üí° Both users use the same code from Microsoft Authenticator",
        appTitle: "üè† Chillinguito Lake Como",
        appSubtitle: "Expense Tracker & Guest Manager",
        langEnBtn: "üá¨üáß EN",
        langItBtn: "üáÆüáπ IT",
        logoutBtn: "üîí Logout",
        tabAddExpense: "Add Expense",
        tabExpensesList: "All Expenses",
        tabSettlement: "Settlement",
        tabGuests: "üë• Guests",
        tabCalendar: "Calendar",
        tabExport: "Export",
        addExpenseTitle: "Add New Expense",
        descLabel: "Description",
        amountLabel: "Amount (EUR)",
        categoryLabel: "Category",
        paidByLabel: "Paid By",
        splitLabel: "Split Between",
        dateLabel: "Date",
        notesLabel: "Notes (optional)",
        cameraBtn: "üì∑ Take Receipt Photo",
        addExpenseBtn: "Add Expense",
        catCleaning: "Cleaning & Maintenance",
        catUtilities: "Utilities (Water, Gas, Electric)",
        catGroceries: "Groceries & Food",
        catRepairs: "Repairs & Equipment",
        catOther: "Other",
        splitBoth: "Both (50/50)",
        splitDavide: "Davide Only",
        splitMattia: "Mattia Only",
        allExpensesTitle: "All Expenses",
        clearAllBtn: "Clear All",
        settlementTitle: "Current Settlement Status",
        totalLabel: "Total Expenses",
        davidePaidLabel: "Davide Paid",
        mattiaPaidLabel: "Mattia Paid",
        whoOwesLabel: "üí∏ Who Owes Whom",
        recordPaymentLabel: "üí∞ Record Partial Payment",
        recordPaymentBtn: "Record",
        davidePayOpt: "Davide pays",
        mattiaPayOpt: "Mattia pays",
        guestsTitle: "üë• Guests Management",
        addGuestBtn: "‚ûï Add Guest",
        checkIn: "Check-in Date",
        checkOut: "Check-out Date",
        guestNotes: "Special Notes & Requirements",
        addDocuments: "üìÅ Add Documents",
        saveGuest: "Save Guest",
        editGuest: "Edit Guest",
        deleteGuest: "Delete Guest",
        guestAdded: "‚úÖ Guest added successfully",
        guestDeleted: "üóëÔ∏è Guest deleted",
        documentAdded: "‚úÖ Document added",
        upcoming: "Upcoming",
        current: "Current",
        completed: "Completed",
        noGuests: "No guests found",
        clearHistoryConfirm: "‚ö†Ô∏è Delete ALL expenses and payments? This cannot be undone!",
        historyCleared: "üóëÔ∏è All history cleared",
        guestPhotos: "Guest Photos",
        addPhotos: "üì∏ Add Photos",
        touristTaxSection: "Tourist Tax (Como Decree)",
        touristTaxAmount: "Tourist tax amount",
        touristTaxPaid: "Paid",
        calendarTitle: "Airbnb Calendar",
        prevBtn: "Previous",
        nextBtn: "Next",
        exportTitle: "Monthly Summary & Export",
        expensePeriodLabel: "Expense Period",
        cleaningPeriodLabel: "Cleaning Dates Period",
        downloadReportBtn: "üìä Download Report",
        addedNotif: "‚úÖ Expense added",
        deletedNotif: "üóëÔ∏è Expense deleted",
        allSettledMsg: "‚úÖ All settled!",
        owesMsg: "{person} owes {other}: EUR {amount}",
        noExpenses: "No expenses found"
    },
    it: {
        authTitle: "Chillinguito",
        authSubtitle: "Seleziona il tuo account e inserisci il codice 2FA",
        authCodeLabel: "Inserisci codice a 6 cifre:",
        unlockBtn: "Sblocca",
        authInfo: "üí° Entrambi gli utenti usano lo stesso codice da Microsoft Authenticator",
        appTitle: "üè† Chillinguito Lake Como",
        appSubtitle: "Tracker Spese e Gestore Ospiti",
        langEnBtn: "üá¨üáß EN",
        langItBtn: "üáÆüáπ IT",
        logoutBtn: "üîí Esci",
        tabAddExpense: "Aggiungi Spesa",
        tabExpensesList: "Tutte le Spese",
        tabSettlement: "Saldo",
        tabGuests: "üë• Ospiti",
        tabCalendar: "Calendario",
        tabExport: "Esporta",
        addExpenseTitle: "Aggiungi Nuova Spesa",
        descLabel: "Descrizione",
        amountLabel: "Importo (EUR)",
        categoryLabel: "Categoria",
        paidByLabel: "Pagato Da",
        splitLabel: "Dividi Tra",
        dateLabel: "Data",
        notesLabel: "Note (opzionale)",
        cameraBtn: "üì∑ Scatta Foto Ricevuta",
        addExpenseBtn: "Aggiungi Spesa",
        catCleaning: "Pulizia e Manutenzione",
        catUtilities: "Utenze (Acqua, Gas, Elettricit√†)",
        catGroceries: "Alimentari e Cibo",
        catRepairs: "Riparazioni e Attrezzature",
        catOther: "Altro",
        splitBoth: "Entrambi (50/50)",
        splitDavide: "Solo Davide",
        splitMattia: "Solo Mattia",
        allExpensesTitle: "Tutte le Spese",
        clearAllBtn: "Cancella Tutto",
        settlementTitle: "Stato Saldo Attuale",
        totalLabel: "Spese Totali",
        davidePaidLabel: "Davide ha Pagato",
        mattiaPaidLabel: "Mattia ha Pagato",
        whoOwesLabel: "üí∏ Chi Deve a Chi",
        recordPaymentLabel: "üí∞ Registra Pagamento Parziale",
        recordPaymentBtn: "Registra",
        davidePayOpt: "Davide paga",
        mattiaPayOpt: "Mattia paga",
        guestsTitle: "üë• Gestione Ospiti",
        addGuestBtn: "‚ûï Aggiungi Ospite",
        checkIn: "Data Check-in",
        checkOut: "Data Check-out",
        guestNotes: "Note Speciali & Esigenze",
        addDocuments: "üìÅ Aggiungi Documenti",
        saveGuest: "Salva Ospite",
        editGuest: "Modifica Ospite",
        deleteGuest: "Elimina Ospite",
        guestAdded: "‚úÖ Ospite aggiunto con successo",
        guestDeleted: "üóëÔ∏è Ospite eliminato",
        documentAdded: "‚úÖ Documento aggiunto",
        upcoming: "Imminente",
        current: "Attuale",
        completed: "Completato",
        noGuests: "Nessun ospite trovato",
        clearHistoryConfirm: "‚ö†Ô∏è Eliminare TUTTE le spese e i pagamenti? Non √® possibile annullare!",
        historyCleared: "üóëÔ∏è Tutto lo storico cancellato",
        guestPhotos: "Foto Ospiti",
        addPhotos: "üì∏ Aggiungi Foto",
        touristTaxSection: "Imposta Turistica (Decreto Como)",
        touristTaxAmount: "Importo imposta turistica",
        touristTaxPaid: "Pagata",
        calendarTitle: "Calendario Airbnb",
        prevBtn: "Precedente",
        nextBtn: "Successivo",
        exportTitle: "Riepilogo Mensile & Esporta",
        expensePeriodLabel: "Periodo Spese",
        cleaningPeriodLabel: "Periodo Date Pulizia",
        downloadReportBtn: "üìä Scarica Report",
        addedNotif: "‚úÖ Spesa aggiunta",
        deletedNotif: "üóëÔ∏è Spesa eliminata",
        allSettledMsg: "‚úÖ Tutto pagato!",
        owesMsg: "{person} deve a {other}: EUR {amount}",
        noExpenses: "Nessuna spesa trovata"
    }
};

        // ============ HELPER FUNCTIONS ============
        function computeTouristTax(guest) {
            const persons = 1 + (guest.accompanied || 0);
            const checkIn = new Date(guest.checkIn);
            const checkOut = new Date(guest.checkOut);
            const msPerDay = 24 * 60 * 60 * 1000;
            let nights = Math.ceil((checkOut - checkIn) / msPerDay);
            if (isNaN(nights) || nights < 0) nights = 0;
            nights = Math.min(nights, 4);
            const tax = persons * nights * 3;
            return { tax, nights, persons };
        }

        function updateTouristTaxPreview() {
            const guestTemp = {
                accompanied: parseInt(document.getElementById('guestAccompanied').value) || 0,
                checkIn: document.getElementById('guestCheckIn').value,
                checkOut: document.getElementById('guestCheckOut').value
            };
            const { tax } = computeTouristTax(guestTemp);
            const el = document.getElementById('touristTaxAmount');
            if (el) el.value = `EUR ${tax.toFixed(2)}`;
        }

        // ============ TRANSLATIONS UPDATE ============
        function updateTranslations() {
            const t = translations[currentLanguage];
            
            // Auth screen elements
            const authTitle = document.getElementById('authTitle');
            const authSubtitle = document.getElementById('authSubtitle');
            const authCodeLabel = document.getElementById('authCodeLabel');
            const authInfo = document.getElementById('authInfo');
            const unlockBtn = document.querySelector('.unlock-btn');
            
            if (authTitle) authTitle.textContent = t.authTitle;
            if (authSubtitle) authSubtitle.textContent = t.authSubtitle;
            if (authCodeLabel) authCodeLabel.textContent = t.authCodeLabel;
            if (authInfo) authInfo.textContent = t.authInfo;
            if (unlockBtn) unlockBtn.textContent = t.unlockBtn;
            
            // Main app header
            const appTitle = document.getElementById('appTitle');
            const appSubtitle = document.getElementById('appSubtitle');
            const logoutBtn = document.getElementById('logoutBtn');
            
            if (appTitle) appTitle.textContent = t.appTitle;
            if (appSubtitle) appSubtitle.textContent = t.appSubtitle;
            if (logoutBtn) logoutBtn.textContent = t.logoutBtn;
            
            // Tabs
            const tabAddExpense = document.getElementById('tabAddExpense');
            const tabExpensesList = document.getElementById('tabExpensesList');
            const tabSettlement = document.getElementById('tabSettlement');
            const tabGuests = document.getElementById('tabGuests');
            const tabCalendar = document.getElementById('tabCalendar');
            const tabExport = document.getElementById('tabExport');
            
            if (tabAddExpense) tabAddExpense.textContent = t.tabAddExpense;
            if (tabExpensesList) tabExpensesList.textContent = t.tabExpensesList;
            if (tabSettlement) tabSettlement.textContent = t.tabSettlement;
            if (tabGuests) tabGuests.textContent = t.tabGuests;
            if (tabCalendar) tabCalendar.textContent = t.tabCalendar;
            if (tabExport) tabExport.textContent = t.tabExport;
        }
        

        function showNotification(msg) {
            const container = document.getElementById('notificationContainer');
            const div = document.createElement('div');
            div.className = 'notification-banner';
            if (msg.includes('‚ö†Ô∏è')) div.classList.add('warning');
            if (msg.includes('‚ùå')) div.classList.add('error');
            div.textContent = msg;
            container.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        function showSync() {
            const badge = document.getElementById('syncStatusIndicator');
            const dot = document.getElementById('syncDot');
            badge.style.display = 'flex';
            dot.classList.add('syncing');
        }

        function hideSync() {
            const badge = document.getElementById('syncStatusIndicator');
            const dot = document.getElementById('syncDot');
            dot.classList.remove('syncing');
            setTimeout(() => {
                badge.style.display = 'none';
            }, 1500);
        }

        // ============ FIREBASE DATA FUNCTIONS ============
        function getExpenses() {
            const data = localStorage.getItem('expenses_shared');
            return data ? JSON.parse(data) : [];
        }

        async function saveExpenses(expenses) {
            localStorage.setItem('expenses_shared', JSON.stringify(expenses));
            if (isFirebaseReady) {
                showSync();
                try {
                    await db.ref('shared/expenses').set(expenses);
                    console.log('‚úÖ Expenses synced to Firebase');
                    hideSync();
                } catch (error) {
                    console.error('‚ùå Firebase error:', error);
                }
            }
            displayExpenses();
            displaySettlement();
        }

        function getPayments() {
            const data = localStorage.getItem('payments_shared');
            return data ? JSON.parse(data) : [];
        }

        async function savePayments(payments) {
            localStorage.setItem('payments_shared', JSON.stringify(payments));
            if (isFirebaseReady) {
                showSync();
                try {
                    await db.ref('shared/payments').set(payments);
                    console.log('‚úÖ Payments synced to Firebase');
                    hideSync();
                } catch (error) {
                    console.error('‚ùå Firebase error:', error);
                }
            }
        }

        function getGuests() {
            const data = localStorage.getItem('guests_shared');
            return data ? JSON.parse(data) : [];
        }

        async function saveGuests(guests) {
            localStorage.setItem('guests_shared', JSON.stringify(guests));
            if (isFirebaseReady) {
                showSync();
                try {
                    await db.ref('shared/guests').set(guests);
                    console.log('‚úÖ Guests synced to Firebase');
                    hideSync();
                } catch (error) {
                    console.error('‚ùå Firebase error:', error);
                }
            }
            displayGuests();
        }

        function getCalendarData() {
            const data = localStorage.getItem('calendar_shared');
            return data ? JSON.parse(data) : {};
        }

        async function saveCalendarData(calendar) {
            localStorage.setItem('calendar_shared', JSON.stringify(calendar));
            if (isFirebaseReady) {
                showSync();
                try {
                    await db.ref('shared/calendar').set(calendar);
                    console.log('‚úÖ Calendar synced to Firebase');
                    hideSync();
                } catch (error) {
                    console.error('‚ùå Firebase error:', error);
                }
            }
            renderCalendar();
        }

        // ============ SETTLEMENT FUNCTIONS (v7 FIXED) ============
        function displaySettlement() {
            const expenses = getExpenses();
            const payments = getPayments();
            const balances = { Davide: 0, Mattia: 0 };
            let total = 0;

            // 1) Base balances from expenses
            expenses.forEach(exp => {
                const amount = exp.amount;
                total += amount;

                if (exp.paidBy === 'Davide') balances.Davide += amount;
                else if (exp.paidBy === 'Mattia') balances.Mattia += amount;

                if (exp.splitBetween === 'Both') {
                    balances.Davide -= amount / 2;
                    balances.Mattia -= amount / 2;
                } else if (exp.splitBetween === 'Davide') {
                    balances.Davide -= amount;
                } else if (exp.splitBetween === 'Mattia') {
                    balances.Mattia -= amount;
                }
            });

            // 2) APPLY PAYMENTS (FIXED)
            payments.forEach(p => {
                if (p.from === 'davide') {
                    balances.Davide += p.amount;
                    balances.Mattia -= p.amount;
                } else if (p.from === 'mattia') {
                    balances.Mattia += p.amount;
                    balances.Davide -= p.amount;
                }
            });

            document.getElementById('totalExpenses').textContent = `EUR ${total.toFixed(2)}`;

            let davidePaid = 0, mattiaPaid = 0;
            expenses.forEach(exp => {
                if (exp.paidBy === 'Davide') davidePaid += exp.amount;
                if (exp.paidBy === 'Mattia') mattiaPaid += exp.amount;
            });
            document.getElementById('davidePaid').textContent = `EUR ${davidePaid.toFixed(2)}`;
            document.getElementById('mattiaPaid').textContent = `EUR ${mattiaPaid.toFixed(2)}`;

            const banner = document.getElementById('settlementBanner');
            const detailsDiv = document.getElementById('settlementDetails');
            const progressContainer = document.getElementById('progressContainer');
            const t = translations[currentLanguage];

            if (total === 0) {
                banner.style.display = 'none';
                progressContainer.style.display = 'none';
                detailsDiv.innerHTML = '<div class="no-data">' + (currentLanguage === 'en' ? 'No expenses yet' : 'Nessuna spesa ancora') + '</div>';
                return;
            }

            banner.style.display = 'block';

            if (Math.abs(balances.Davide) < 0.01 && Math.abs(balances.Mattia) < 0.01) {
                banner.className = 'settlement-banner paid';
                banner.textContent = t.allSettledMsg;
                detailsDiv.innerHTML = '<div class="settlement-box" style="background:rgba(76,175,80,0.1);color:#2e7d32;border:none;">' + t.allSettledMsg + '</div>';
                progressContainer.style.display = 'none';
                document.getElementById('paymentFrom').innerHTML =
                    `<option value="davide">${t.davidePayOpt}</option><option value="mattia">${t.mattiaPayOpt}</option>`;
                return;
            }

            let debtor = null;
            let amountOwed = 0;

            if (balances.Davide < -0.01) {
                debtor = 'davide';
                amountOwed = Math.abs(balances.Davide);
                banner.className = 'settlement-banner owed';
                banner.textContent = `Davide ${currentLanguage === 'en' ? 'still owes' : 'deve ancora'} Mattia: EUR ${amountOwed.toFixed(2)}`;
                detailsDiv.innerHTML = `<div class="settlement-box owed">üí≥ Davide ${currentLanguage === 'en' ? 'still owes' : 'deve ancora'} Mattia: <strong>EUR ${amountOwed.toFixed(2)}</strong></div>`;
                document.getElementById('paymentFrom').innerHTML = `<option value="davide">${t.davidePayOpt}</option>`;
            } else if (balances.Mattia < -0.01) {
                debtor = 'mattia';
                amountOwed = Math.abs(balances.Mattia);
                banner.className = 'settlement-banner owed';
                banner.textContent = `Mattia ${currentLanguage === 'en' ? 'still owes' : 'deve ancora'} Davide: EUR ${amountOwed.toFixed(2)}`;
                detailsDiv.innerHTML = `<div class="settlement-box owed">üí≥ Mattia ${currentLanguage === 'en' ? 'still owes' : 'deve ancora'} Davide: <strong>EUR ${amountOwed.toFixed(2)}</strong></div>`;
                document.getElementById('paymentFrom').innerHTML = `<option value="mattia">${t.mattiaPayOpt}</option>`;
            }

            if (debtor) {
                progressContainer.style.display = 'block';
                updateProgressBar(amountOwed, debtor);
            } else {
                progressContainer.style.display = 'none';
            }
        }

        function updateProgressBar(amount, debtor) {
            const total = getExpenses().reduce((sum, e) => sum + e.amount, 0);
            const paid = getPayments().reduce((sum, p) => p.from === debtor ? sum + p.amount : sum, 0);
            const percent = Math.min((paid / amount) * 100, 100);
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressPercent').textContent = Math.round(percent) + '%';
        }

        function recordPayment() {
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const from = document.getElementById('paymentFrom').value;
            const t = translations[currentLanguage];

            if (!amount || amount <= 0) {
                showNotification('‚ùå Enter amount');
                return;
            }

            let payments = getPayments();
            payments.push({ from, amount, date: new Date().toISOString() });
            savePayments(payments);
            document.getElementById('paymentAmount').value = '';
            showNotification(t.paymentRecordedNotif);
            displaySettlement();
        }

        function addExpense(event) {
            event.preventDefault();
            const t = translations[currentLanguage];

            const expense = {
                id: Date.now(),
                description: document.getElementById('description').value,
                amount: parseFloat(document.getElementById('amount').value),
                category: document.getElementById('category').value,
                paidBy: document.getElementById('paidBy').value,
                splitBetween: document.getElementById('splitBetween').value,
                date: document.getElementById('date').value,
                notes: document.getElementById('notes').value,
                receipt: receiptBase64 || null,
                addedBy: currentUser
            };

            let expenses = getExpenses();
            expenses.push(expense);
            saveExpenses(expenses);

            document.getElementById('description').value = '';
            document.getElementById('amount').value = '';
            document.getElementById('category').value = '';
            document.getElementById('paidBy').value = '';
            document.getElementById('splitBetween').value = '';
            document.getElementById('date').value = '';
            document.getElementById('notes').value = '';
            document.getElementById('receiptPreview').innerHTML = '';
            receiptBase64 = null;

            showNotification(t.addedNotif);
        }

        function displayExpenses() {
            const expenses = getExpenses();
            const listDiv = document.getElementById('expensesList');

            if (expenses.length === 0) {
                listDiv.innerHTML = '<div class="no-data">' + translations[currentLanguage].noExpenses + '</div>';
                return;
            }

            expenses.sort((a, b) => new Date(b.date) - new Date(a.date));
            listDiv.innerHTML = expenses.map(exp => `
                <div class="expense-item">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div class="expense-info">
                            <div class="expense-description">${exp.description}</div>
                            <div class="expense-details">
                                <span class="category-badge">${exp.category}</span>
                                ${new Date(exp.date).toLocaleDateString()} ‚Ä¢ ${exp.paidBy} paid, split ${exp.splitBetween}<span class="user-badge-inline">${exp.addedBy}</span>
                            </div>
                        </div>
                        <div class="expense-amount">EUR ${exp.amount.toFixed(2)}</div>
                    </div>
                    ${exp.receipt ? `<div class="expense-receipt"><img src="${exp.receipt}" alt="Receipt"></div>` : ''}
                    <div style="margin-top: 12px;">
                        <button class="btn-danger" onclick="deleteExpense(${exp.id})" style="width: 100%; padding: 8px;">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function deleteExpense(id) {
            if (confirm('Delete this expense?')) {
                let expenses = getExpenses();
                expenses = expenses.filter(e => e.id !== id);
                saveExpenses(expenses);
                showNotification(translations[currentLanguage].deletedNotif);
            }
        }

        function clearAllExpenses() {
            if (confirm(translations[currentLanguage].clearHistoryConfirm)) {
                localStorage.removeItem('expenses_shared');
                localStorage.removeItem('payments_shared');
                displayExpenses();
                displaySettlement();
                showNotification(translations[currentLanguage].historyCleared);
            }
        }

        function filterExpenses() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const category = document.getElementById('filterCategory').value;
            const month = document.getElementById('filterMonth').value;
            const year = document.getElementById('filterYear').value;

            const expenses = getExpenses();
            filteredExpenses = expenses.filter(exp => {
                const matchesSearch = exp.description.toLowerCase().includes(searchText);
                const matchesCategory = !category || exp.category === category;
                const expDate = new Date(exp.date);
                const matchesMonth = !month || (expDate.getMonth() + 1).toString() === month;
                const matchesYear = !year || expDate.getFullYear().toString() === year;

                return matchesSearch && matchesCategory && matchesMonth && matchesYear;
            });

            document.getElementById('expensesList').innerHTML = filteredExpenses.length === 0
                ? '<div class="no-data">' + translations[currentLanguage].noExpenses + '</div>'
                : filteredExpenses.map(exp => `
                    <div class="expense-item">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div class="expense-info">
                                <div class="expense-description">${exp.description}</div>
                                <div class="expense-details">
                                    <span class="category-badge">${exp.category}</span>
                                    ${new Date(exp.date).toLocaleDateString()} ‚Ä¢ ${exp.paidBy} paid, split ${exp.splitBetween}
                                </div>
                            </div>
                            <div class="expense-amount">EUR ${exp.amount.toFixed(2)}</div>
                        </div>
                        ${exp.receipt ? `<div class="expense-receipt"><img src="${exp.receipt}" alt="Receipt"></div>` : ''}
                        <div style="margin-top: 12px;">
                            <button class="btn-danger" onclick="deleteExpense(${exp.id})" style="width: 100%; padding: 8px;">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `).join('');
        }

        function populateMonthYearFilters() {
            const expenses = getExpenses();
            const months = new Set();
            const years = new Set();

            expenses.forEach(exp => {
                const date = new Date(exp.date);
                months.add(date.getMonth() + 1);
                years.add(date.getFullYear());
            });

            const monthSelect = document.getElementById('filterMonth');
            const yearSelect = document.getElementById('filterYear');

            monthSelect.innerHTML = '<option value="">All Months</option>' +
                Array.from(months).sort().map(m => `<option value="${m}">${new Date(2000, m - 1).toLocaleString('en-US', {month: 'long'})}</option>`).join('');

            yearSelect.innerHTML = '<option value="">All Years</option>' +
                Array.from(years).sort().map(y => `<option value="${y}">${y}</option>`).join('');
        }

        // ============ CAMERA FUNCTIONS ============
        function openCamera() {
            document.getElementById('cameraInput').click();
        }

        function handleCameraCapture() {
            const file = document.getElementById('cameraInput').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    receiptBase64 = e.target.result;
                    document.getElementById('receiptPreview').innerHTML = `<img src="${receiptBase64}" style="max-width: 200px; border-radius: 6px;">`;
                };
                reader.readAsDataURL(file);
            }
        }

        // ============ CALENDAR AUTO-FILL (v10 NEW) ============
        function markGuestDatesOnCalendar(guest) {
            const calendar = getCalendarData();
            const checkIn = new Date(guest.checkIn);
            const checkOut = new Date(guest.checkOut);
           
            // Mark each night as occupied (from checkin to day before checkout)
            let currentDate = new Date(checkIn);
            while (currentDate < checkOut) {
               const dateStr = currentDate.toISOString().split('T')[0];
               calendar[dateStr] = 'occupied';
               currentDate.setDate(currentDate.getDate() + 1);
           }
           
            // Save and refresh calendar
            saveCalendarData(calendar);
        }

        // ============ CALENDAR CLEANUP (v11 NEW) ============
        function unmarkGuestDatesOnCalendar(guest) {
            const calendar = getCalendarData();
            const checkIn = new Date(guest.checkIn);
            const checkOut = new Date(guest.checkOut);
            
            // Remove occupancy for each night (from checkin to day before checkout)
            let currentDate = new Date(checkIn);
            while (currentDate < checkOut) {
                const dateStr = currentDate.toISOString().split('T')[0];
                // Delete the occupied status, making it available
                delete calendar[dateStr];
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // Save and refresh calendar
            saveCalendarData(calendar);
        }

        // ============ GUEST FUNCTIONS ============
        function openAddGuestModal() {
            currentEditingGuestId = null;
            guestPhotos = [];
            const t = translations[currentLanguage];
            const guest = {};
            
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.id = 'addGuestModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>${t.addGuestBtn}</h3>
                        <button class="modal-close" onclick="closeModal()">√ó</button>
                    </div>
                    <form onsubmit="saveGuest(event)">
                        <div class="form-group">
                            <label>${t.guestName}</label>
                            <input type="text" id="guestName" required placeholder="Full name">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>${t.guestEmail}</label>
                                <input type="email" id="guestEmail" placeholder="email@example.com">
                            </div>
                            <div class="form-group">
                                <label>${t.guestPhone}</label>
                                <input type="tel" id="guestPhone" placeholder="+39 xxx xxx xxxx">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>${t.checkIn}</label>
                                <input type="date" id="guestCheckIn" required onchange="updateTouristTaxPreview()">
                            </div>
                            <div class="form-group">
                                <label>${t.checkOut}</label>
                                <input type="date" id="guestCheckOut" required onchange="updateTouristTaxPreview()">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>${t.guestAccompanied}</label>
                            <input type="number" id="guestAccompanied" placeholder="0" min="0" max="10" value="0" onchange="updateAccompaniedGuestsForm(); updateTouristTaxPreview();">
                        </div>

                        <div id="accompaniedGuestsContainer"></div>

                        <div class="form-group">
                            <label>${t.guestPhotos}</label>
                            <button type="button" class="camera-btn" onclick="openGuestPhotoGallery()">üì∏ ${t.addPhotos}</button>
                            <input type="file" id="guestPhotoInput" accept="image/*" multiple onchange="handleGuestPhotos()">
                            <div id="guestPhotoPreview" class="image-gallery"></div>
                        </div>

                        <div class="tourist-tax-section">
                            <h4>${t.touristTaxSection}</h4>
                            <div class="tourist-tax-row">
                                <div>
                                    <label>${t.touristTaxAmount}</label>
                                    <input type="text" id="touristTaxAmount" disabled>
                                </div>
                                <div class="tourist-tax-paid">
                                    <input type="checkbox" id="touristTaxPaid">
                                    <label style="margin: 0;">${t.touristTaxPaid}</label>
                                </div>
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">${t.touristTaxCalculation}</div>
                        </div>

                        <div class="form-group">
                            <label>${t.guestNotes}</label>
                            <textarea id="guestNotes" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn-primary" style="width: 100%;">${t.saveGuest}</button>
                        </div>
                    </form>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = '';
            document.getElementById('modalContainer').appendChild(modal);
            modal.onclick = (e) => {
                if (e.target === modal) closeModal();
            };

            updateAccompaniedGuestsForm();
            displayGuestPhotos();
            updateTouristTaxPreview();
            document.getElementById('touristTaxPaid').checked = guest.touristTaxPaid || false;

            // Populate accompanied guests
            if (guest.accompaniedGuests && guest.accompaniedGuests.length > 0) {
                guest.accompaniedGuests.forEach((ag, idx) => {
                    const nameField = document.getElementById(`accompaniedGuestName${idx}`);
                    const surnameField = document.getElementById(`accompaniedGuestSurname${idx}`);
                    if (nameField) nameField.value = ag.name;
                    if (surnameField) surnameField.value = ag.surname;
                });
            }
        }

        function updateAccompaniedGuestsForm() {
            const count = parseInt(document.getElementById('guestAccompanied').value) || 0;
            const container = document.getElementById('accompaniedGuestsContainer');
            const t = translations[currentLanguage];
            
            container.innerHTML = '';
            if (count > 0) {
                container.innerHTML = `<div class="accompanied-guests-section">
                    <h4>${t.accompaniedGuestsInfo}</h4>`;
                for (let i = 0; i < count; i++) {
                    container.innerHTML += `
                        <div class="guest-info-row">
                            <input type="text" id="accompaniedGuestName${i}" placeholder="${t.accompaniedGuestName}" value="">
                            <input type="text" id="accompaniedGuestSurname${i}" placeholder="${t.accompaniedGuestSurname}" value="">
                        </div>
                    `;
                }
                container.innerHTML += '</div>';
            }
        }

        function openGuestPhotoGallery() {
            document.getElementById('guestPhotoInput').click();
        }

        function handleGuestPhotos() {
            const files = document.getElementById('guestPhotoInput').files;
            guestPhotos = [];
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    guestPhotos.push(e.target.result);
                    displayGuestPhotos();
                };
                reader.readAsDataURL(file);
            });
        }

        function displayGuestPhotos() {
            const preview = document.getElementById('guestPhotoPreview');
            preview.innerHTML = guestPhotos.map((photo, idx) => `
                <div class="gallery-item">
                    <img src="${photo}" alt="Guest photo">
                    <button class="gallery-item-remove" onclick="removeLocalPhoto(${idx})">√ó</button>
                </div>
            `).join('');
        }

        function removeLocalPhoto(idx) {
            guestPhotos.splice(idx, 1);
            displayGuestPhotos();
        }

        function saveGuest(event) {
            event.preventDefault();
            const t = translations[currentLanguage];
            
            const guest = {
                id: currentEditingGuestId || Date.now(),
                name: document.getElementById('guestName').value,
                email: document.getElementById('guestEmail').value,
                phone: document.getElementById('guestPhone').value,
                checkIn: document.getElementById('guestCheckIn').value,
                checkOut: document.getElementById('guestCheckOut').value,
                accompanied: parseInt(document.getElementById('guestAccompanied').value) || 0,
                photos: guestPhotos,
                notes: document.getElementById('guestNotes').value,
                touristTaxPaid: document.getElementById('touristTaxPaid').checked,
                documents: {},
                accompaniedGuests: []
            };

            const count = parseInt(document.getElementById('guestAccompanied').value) || 0;
            for (let i = 0; i < count; i++) {
                const name = document.getElementById(`accompaniedGuestName${i}`).value;
                const surname = document.getElementById(`accompaniedGuestSurname${i}`).value;
                if (name || surname) {
                    guest.accompaniedGuests.push({ name, surname });
                }
            }

            let guests = getGuests();
            if (currentEditingGuestId) {
                const idx = guests.findIndex(g => g.id === currentEditingGuestId);
                if (idx !== -1) guests[idx] = guest;
            } else {
                guests.push(guest);
                // Mark calendar dates for new guest
                markGuestDatesOnCalendar(guest);
            }

            saveGuests(guests);
            closeModal();
            showNotification(t.guestAdded);
        }

        function deleteGuest(guestId) {
            if (confirm('Delete this guest?')) {
                // Get the guest BEFORE deleting (so we know which dates to free up)
                const guests = getGuests();
                const guestToDelete = guests.find(g => g.id === guestId);
                
                // Remove from guests list
                const updatedGuests = guests.filter(g => g.id !== guestId);
                
                // Clear calendar dates for this guest
                if (guestToDelete && guestToDelete.checkIn && guestToDelete.checkOut) {
                    unmarkGuestDatesOnCalendar(guestToDelete);
                }
                
                // Save updated guests
                saveGuests(updatedGuests);
                
                // Show notification
                const t = translations[currentLanguage];
                showNotification(t.guestDeleted);
            }
        }

        function editGuest(guestId) {
            const guests = getGuests();
            const guest = guests.find(g => g.id === guestId);
            if (!guest) return;

            currentEditingGuestId = guestId;
            guestPhotos = guest.photos || [];
            const t = translations[currentLanguage];

            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.id = 'addGuestModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>${t.editGuest}</h3>
                        <button class="modal-close" onclick="closeModal()">√ó</button>
                    </div>
                    <form onsubmit="saveGuest(event)">
                        <div class="form-group">
                            <label>${t.guestName}</label>
                            <input type="text" id="guestName" required placeholder="Full name" value="${guest.name}">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>${t.guestEmail}</label>
                                <input type="email" id="guestEmail" placeholder="email@example.com" value="${guest.email || ''}">
                            </div>
                            <div class="form-group">
                                <label>${t.guestPhone}</label>
                                <input type="tel" id="guestPhone" placeholder="+39 xxx xxx xxxx" value="${guest.phone || ''}">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>${t.checkIn}</label>
                                <input type="date" id="guestCheckIn" required value="${guest.checkIn}" onchange="updateTouristTaxPreview()">
                            </div>
                            <div class="form-group">
                                <label>${t.checkOut}</label>
                                <input type="date" id="guestCheckOut" required value="${guest.checkOut}" onchange="updateTouristTaxPreview()">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>${t.guestAccompanied}</label>
                            <input type="number" id="guestAccompanied" placeholder="0" min="0" max="10" value="${guest.accompanied || 0}" onchange="updateAccompaniedGuestsForm(); updateTouristTaxPreview();">
                        </div>

                        <div id="accompaniedGuestsContainer"></div>

                        <div class="form-group">
                            <label>${t.guestPhotos}</label>
                            <button type="button" class="camera-btn" onclick="openGuestPhotoGallery()">üì∏ ${t.addPhotos}</button>
                            <input type="file" id="guestPhotoInput" accept="image/*" multiple onchange="handleGuestPhotos()">
                            <div id="guestPhotoPreview" class="image-gallery"></div>
                        </div>

                        <div class="tourist-tax-section">
                            <h4>${t.touristTaxSection}</h4>
                            <div class="tourist-tax-row">
                                <div>
                                    <label>${t.touristTaxAmount}</label>
                                    <input type="text" id="touristTaxAmount" disabled>
                                </div>
                                <div class="tourist-tax-paid">
                                    <input type="checkbox" id="touristTaxPaid">
                                    <label style="margin: 0;">${t.touristTaxPaid}</label>
                                </div>
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">${t.touristTaxCalculation}</div>
                        </div>

                        <div class="form-group">
                            <label>${t.guestNotes}</label>
                            <textarea id="guestNotes" rows="3">${guest.notes || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn-primary" style="width: 100%;">${t.saveGuest}</button>
                        </div>
                    </form>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = '';
            document.getElementById('modalContainer').appendChild(modal);
            modal.onclick = (e) => {
                if (e.target === modal) closeModal();
            };

            updateAccompaniedGuestsForm();
            displayGuestPhotos();
            updateTouristTaxPreview();
            document.getElementById('touristTaxPaid').checked = guest.touristTaxPaid || false;

            // Populate accompanied guests
            if (guest.accompaniedGuests && guest.accompaniedGuests.length > 0) {
                guest.accompaniedGuests.forEach((ag, idx) => {
                    const nameField = document.getElementById(`accompaniedGuestName${idx}`);
                    const surnameField = document.getElementById(`accompaniedGuestSurname${idx}`);
                    if (nameField) nameField.value = ag.name;
                    if (surnameField) surnameField.value = ag.surname;
                });
            }
        }

        function filterGuests() {
            const searchText = document.getElementById('guestSearchInput').value.toLowerCase();
            const dateFilter = document.getElementById('guestDateFilter').value;
            const statusFilter = document.getElementById('guestStatusFilter').value;
            const today = new Date();

            const guests = getGuests();
            filteredGuests = guests.filter(guest => {
                const matchesSearch = guest.name.toLowerCase().includes(searchText);
                const checkIn = new Date(guest.checkIn);
                const checkOut = new Date(guest.checkOut);

                let matchesStatus = true;
                if (statusFilter) {
                    if (statusFilter === 'upcoming' && checkIn <= today) matchesStatus = false;
                    if (statusFilter === 'current' && (today < checkIn || today >= checkOut)) matchesStatus = false;
                    if (statusFilter === 'completed' && checkOut > today) matchesStatus = false;
                }

                const matchesDate = !dateFilter || (dateFilter >= guest.checkIn && dateFilter < guest.checkOut);

                return matchesSearch && matchesStatus && matchesDate;
            });

            displayFilteredGuests();
        }

        function displayGuests() {
            filteredGuests = getGuests();
            displayFilteredGuests();
        }

        function displayFilteredGuests() {
            const listDiv = document.getElementById('guestsList');
            const t = translations[currentLanguage];

            if (filteredGuests.length === 0) {
                listDiv.innerHTML = '<div class="no-data">' + t.noGuests + '</div>';
                return;
            }

            listDiv.innerHTML = filteredGuests.map(guest => {
                const checkIn = new Date(guest.checkIn);
                const checkOut = new Date(guest.checkOut);
                const today = new Date();

                let status = 'upcoming';
                if (today >= checkIn && today < checkOut) status = 'current';
                if (today >= checkOut) status = 'completed';

                const statusText = { upcoming: t.upcoming, current: t.current, completed: t.completed }[status];
                const accompaniedText = guest.accompanied > 0 ? `+ ${guest.accompanied} ${t.guestGuests}` : '';

                let accompaniedInfo = '';
                if (guest.accompaniedGuests && guest.accompaniedGuests.length > 0) {
                    accompaniedInfo = '<div style="margin-top: 8px; font-size: 12px; color: var(--text-secondary);"><strong>Additional Guests:</strong><br>' +
                        guest.accompaniedGuests.map(ag => `${ag.name} ${ag.surname}`).join('<br>') +
                        '</div>';
                }

                const { tax } = computeTouristTax(guest);
                const taxPaidText = guest.touristTaxPaid ? '‚úì Yes' : '‚úó No';

                return `
                    <div class="guest-card">
                        <div class="guest-header">
                            <div class="guest-info" style="flex: 1;">
                                <h3>${guest.name} ${accompaniedText}</h3>
                                <div class="guest-dates">
                                    üìÖ ${checkIn.toLocaleDateString()} ‚Üí ${checkOut.toLocaleDateString()}
                                </div>
                                ${accompaniedInfo}
                                <span class="guest-status ${status}">${statusText}</span>
                            </div>
                        </div>
                        ${guest.photos && guest.photos.length > 0 ? `
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                                <strong style="font-size: 13px;">${t.guestPhotos}:</strong>
                                <div class="image-gallery">
                                    ${guest.photos.map((photo, idx) => `
                                        <div class="gallery-item">
                                            <img src="${photo}" alt="Guest photo">
                                            <button class="gallery-item-remove" onclick="removeGuestPhoto2(${guest.id}, ${idx})">√ó</button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); font-size: 13px;">
                            <strong>${t.touristTaxSection}:</strong><br>
                            EUR ${tax.toFixed(2)} ‚Ä¢ ${t.touristTaxPaid}: ${taxPaidText}
                        </div>
                        <div class="guest-documents">
                            <strong style="font-size: 13px;">üìÑ Documents:</strong>
                            <div style="margin-top: 8px;">
                                ${Object.entries(guest.documents || {}).length > 0 ? Object.entries(guest.documents).map(([docType, docs]) => `
                                    <div style="margin-bottom: 8px;">
                                        <div style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px;">${docType}</div>
                                        <div class="image-gallery">
                                            ${docs.map((doc, idx) => `
                                                <div class="gallery-item">
                                                    <img src="${doc}" alt="${docType}">
                                                    <button class="gallery-item-remove" onclick="removeGuestDocument(${guest.id}, '${docType}', ${idx})">√ó</button>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('') : '<div style="font-size: 12px; color: var(--text-secondary);">No documents</div>'}
                            </div>
                        </div>
                        <div class="guest-actions">
                            <button class="btn-primary" style="padding: 8px;" onclick="openAddDocumentModal(${guest.id})">üìÅ ${t.addDocuments}</button>
                            <button class="btn-secondary" style="padding: 8px;" onclick="editGuest(${guest.id})">‚úèÔ∏è ${t.editGuest}</button>
                            <button class="btn-danger" onclick="deleteGuest(${guest.id})">üóëÔ∏è ${t.deleteGuest}</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function removeGuestPhoto2(guestId, photoIdx) {
            let guests = getGuests();
            const guest = guests.find(g => g.id === guestId);
            if (guest && guest.photos) {
                guest.photos.splice(photoIdx, 1);
                saveGuests(guests);
            }
        }

        function openAddDocumentModal(guestId) {
            const t = translations[currentLanguage];
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>${t.addDocuments}</h3>
                        <button class="modal-close" onclick="closeModal()">√ó</button>
                    </div>
                    <div class="form-group">
                        <label>Document Type</label>
                        <select id="documentType">
                            <option value="ID/Passport">${t.idDocument}</option>
                            <option value="Tourist Tax Receipt">${t.touristTaxReceipt}</option>
                            <option value="Payment Receipt">${t.paymentReceipt}</option>
                            <option value="Check-in Photo">${t.checkInPhoto}</option>
                            <option value="Other Documents">${t.otherDoc}</option>
                        </select>
                    </div>
                    <button class="camera-btn" onclick="openDocumentCamera(${guestId})">üì∏ ${t.uploadDocument}</button>
                    <input type="file" id="documentInput" accept="image/*" onchange="handleDocumentUpload(${guestId})">
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = '';
            document.getElementById('modalContainer').appendChild(modal);
            modal.onclick = (e) => {
                if (e.target === modal) closeModal();
            };
        }

        function openDocumentCamera(guestId) {
            document.getElementById('documentInput').click();
        }

        function handleDocumentUpload(guestId) {
            const file = document.getElementById('documentInput').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const docType = document.getElementById('documentType').value;
                    let guests = getGuests();
                    const guest = guests.find(g => g.id === guestId);
                    if (guest) {
                        if (!guest.documents) guest.documents = {};
                        if (!guest.documents[docType]) guest.documents[docType] = [];
                        guest.documents[docType].push(e.target.result);
                        saveGuests(guests);
                        closeModal();
                        showNotification(translations[currentLanguage].documentAdded);
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        function removeGuestDocument(guestId, docType, docIdx) {
            let guests = getGuests();
            const guest = guests.find(g => g.id === guestId);
            if (guest && guest.documents && guest.documents[docType]) {
                guest.documents[docType].splice(docIdx, 1);
                if (guest.documents[docType].length === 0) delete guest.documents[docType];
                saveGuests(guests);
            }
        }

        function closeModal() {
            document.getElementById('modalContainer').innerHTML = '';
        }

        // ============ CALENDAR FUNCTIONS ============
        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();

            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();

            const calendarDays = document.getElementById('calendarDays');
            calendarDays.innerHTML = '';

            for (let i = firstDay - 1; i >= 0; i--) {
                const day = daysInPrevMonth - i;
                const cell = document.createElement('div');
                cell.className = 'calendar-day other-month';
                cell.textContent = day;
                calendarDays.appendChild(cell);
            }

            const calendar = getCalendarData();
            const t = translations[currentLanguage];

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const status = calendar[dateStr] || 'available';

                const cell = document.createElement('div');
                cell.className = `calendar-day ${status}`;
                cell.innerHTML = `<div class="calendar-day-number">${day}</div><div class="calendar-day-status">${t[status] || status}</div>`;
                cell.onclick = () => openCalendarStatusModal(dateStr);
                calendarDays.appendChild(cell);
            }

            const nextMonthDays = 42 - (firstDay + daysInMonth);
            for (let day = 1; day <= nextMonthDays; day++) {
                const cell = document.createElement('div');
                cell.className = 'calendar-day other-month';
                cell.textContent = day;
                calendarDays.appendChild(cell);
            }
        }

        function openCalendarStatusModal(dateStr) {
            const calendar = getCalendarData();
            const currentStatus = calendar[dateStr] || 'available';
            const t = translations[currentLanguage];

            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Set Status for ${dateStr}</h3>
                        <button class="modal-close" onclick="closeModal()">√ó</button>
                    </div>
                    <div class="day-status-selector">
                        <div class="status-option ${currentStatus === 'available' ? 'selected' : ''}" onclick="updateCalendarStatus('${dateStr}', 'available')">
                            üü¢ ${t.available}
                        </div>
                        <div class="status-option ${currentStatus === 'occupied' ? 'selected' : ''}" onclick="updateCalendarStatus('${dateStr}', 'occupied')">
                            üî¥ ${t.occupied}
                        </div>
                        <div class="status-option ${currentStatus === 'cleaning' ? 'selected' : ''}" onclick="updateCalendarStatus('${dateStr}', 'cleaning')">
                            üü† ${t.cleaning}
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = '';
            document.getElementById('modalContainer').appendChild(modal);
            modal.onclick = (e) => {
                if (e.target === modal) closeModal();
            };
        }

        function updateCalendarStatus(dateStr, status) {
            const calendar = getCalendarData();
            if (status === 'available') {
                delete calendar[dateStr];
            } else {
                calendar[dateStr] = status;
            }
            saveCalendarData(calendar);
            closeModal();
        }

        function previousMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar();
        }

        // ============ AUTH & UI FUNCTIONS ============

        function validateTOTP() {
            const inputs = document.querySelectorAll('.totp-digit');
            const code = Array.from(inputs).map(i => i.value).join('');
            const errorEl = document.getElementById('errorMessage');
        
            if (!selectedUsername) {
                if (errorEl) errorEl.textContent = '‚ùå Select a user first';
                return;
            }
        
            if (code.length !== 6) {
                if (errorEl) errorEl.textContent = '‚ùå Enter all 6 digits';
                return;
            }
        
            const username = selectedUsername; // 'davide' or 'mattia'
            const ok = verifyTOTP(code, username);
        
            if (!ok) {
                if (errorEl) errorEl.textContent = '‚ùå Invalid code ‚Äì try again';
                return;
            }
        
            // SUCCESS: unlock app
            currentUser = username === 'davide' ? 'Davide' : 'Mattia';
        
            const authScreen = document.getElementById('authScreen');
            const mainApp = document.getElementById('mainApp');
            if (authScreen) authScreen.style.display = 'none';
            if (mainApp) mainApp.style.display = 'block';
            document.body.classList.remove('locked');
        
            // header user badge
            const userIconEl = document.getElementById('userIcon');
            const userNameEl = document.getElementById('userName');
            if (userIconEl) userIconEl.textContent = username === 'davide' ? 'üë®' : 'üë®‚Äçü¶±';
            if (userNameEl) userNameEl.textContent = currentUser;
        
            if (errorEl) errorEl.textContent = '';
        }

        function selectUser(username, ev) {
            const e = ev || window.event;
            document.querySelectorAll('.user-btn').forEach(btn => btn.classList.remove('selected'));
            if (e && e.currentTarget) {
                e.currentTarget.classList.add('selected');
            }
            selectedUsername = username;
            const errorEl = document.getElementById('errorMessage');
            if (errorEl) errorEl.textContent = '';
        }
        
        function verifyTOTP(token, username) {
    const TOTP_SECRET_DAVIDE = 'JBSWY3DPEHPK3PXP';
    const TOTP_SECRET_MATTIA = 'JBSWY3DPEHPK3PXP';
    
    const secret = username === 'davide' ? TOTP_SECRET_DAVIDE : TOTP_SECRET_MATTIA;
    
    try {
        const secretBytes = base32Decode(secret);
        const now = Math.floor(Date.now() / 1000);
        
        // Check current time window and ¬±1 window (¬±30 seconds tolerance)
        for (let i = -1; i <= 1; i++) {
            const counter = Math.floor(now / 30) + i;
            const counterHex = ('0000000000000000' + counter.toString(16)).slice(-16);
            const counterBytes = hexToBytes(counterHex);
            
            // Use CryptoJS correctly
            const hmacObj = CryptoJS.HmacSHA1(
                CryptoJS.enc.Hex.parse(counterHex),
                CryptoJS.enc.Hex.parse(bytesToHex(secretBytes))
            );
            
            const hmacBytes = hexToBytes(hmacObj.toString());
            const offset = hmacBytes[hmacBytes.length - 1] & 0x0f;
            const value = (
                ((hmacBytes[offset] & 0x7f) << 24) |
                ((hmacBytes[offset + 1] & 0xff) << 16) |
                ((hmacBytes[offset + 2] & 0xff) << 8) |
                (hmacBytes[offset + 3] & 0xff)
            );
            
            const code = (value % 1000000).toString().padStart(6, '0');
            
            if (code === token) {
                console.log('‚úÖ TOTP code verified');
                return true;
            }
        }
        
        console.log('‚ùå TOTP code did not match any time window');
        return false;
    } catch (e) {
        console.error('‚ùå TOTP verification error:', e.message);
        return false;
    }
}

function bytesToHex(bytes) {
    let hex = '';
    for (let i = 0; i < bytes.length; i++) {
        hex += ('0' + bytes[i].toString(16)).slice(-2);
    }
    return hex;
}

        // ============ TOTP SETUP ============
function setupTOTPInput() {
    const inputs = document.querySelectorAll('.totp-digit');
    inputs.forEach((input, index) => {
        input.addEventListener('input', (e) => {
            if (e.target.value && index < inputs.length - 1) {
                inputs[index + 1].focus();
            }
        });
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace' && !e.target.value && index > 0) {
                inputs[index - 1].focus();
            }
            if (e.key === 'Enter') {
                validateTOTP();
            }
        });
    });
}

function validateTOTP() {
    const inputs = document.querySelectorAll('.totp-digit');
    const code = Array.from(inputs).map(i => i.value).join('');
    const errorEl = document.getElementById('errorMessage');

    if (!selectedUsername) {
        if (errorEl) errorEl.textContent = '‚ùå Select a user first';
        return;
    }

    if (code.length !== 6) {
        if (errorEl) errorEl.textContent = '‚ùå Enter all 6 digits';
        return;
    }

    const ok = verifyTOTP(code, selectedUsername);

    if (!ok) {
        if (errorEl) errorEl.textContent = '‚ùå Invalid code ‚Äì try again';
        // Clear inputs
        inputs.forEach(i => i.value = '');
        inputs[0].focus();
        return;
    }

    // SUCCESS: unlock app
    currentUser = selectedUsername === 'Davide' ? 'Davide' : 'Mattia';

    const authScreen = document.getElementById('authScreen');
    const mainApp = document.getElementById('mainApp');
    if (authScreen) authScreen.style.display = 'none';
    if (mainApp) mainApp.style.display = 'block';
    document.body.classList.remove('locked');

    // Update header user badge
    const userIconEl = document.getElementById('userIcon');
    const userNameEl = document.getElementById('userName');
    if (userIconEl) userIconEl.textContent = selectedUsername === 'Davide' ? 'üë®' : 'üë®‚Äçü¶±';
    if (userNameEl) userNameEl.textContent = currentUser;

    if (errorEl) errorEl.textContent = '';
    
    // Load data
    displayExpenses();
    displaySettlement();
    displayGuests();
    setupFirebaseListeners();
}        
        function verifyTOTP(token, username) {
            const TOTP_SECRET_DAVIDE = 'JBSWY3DPEHPK3PXP';
            const TOTP_SECRET_MATTIA = 'JBSWY3DPEHPK3PXP';
            
            const secret = username === 'davide' ? TOTP_SECRET_DAVIDE : TOTP_SECRET_MATTIA;
            
            try {
                const secretBytes = base32Decode(secret);
                const now = Math.floor(Date.now() / 1000);
                
                // Check current time window and ¬±1 window (¬±30 seconds tolerance)
                for (let i = -1; i <= 1; i++) {
                    const counter = Math.floor(now / 30) + i;
                    const counterHex = ('0000000000000000' + counter.toString(16)).slice(-16);
                    const counterBytes = hexToBytes(counterHex);
                    
                    const hmac = CryptoJS.HmacSHA1(
                        CryptoJS.enc.Latin1.parse(String.fromCharCode(...counterBytes)),
                        CryptoJS.enc.Latin1.parse(base32DecodeToString(secret))
                    );
                    
                    const hmacBytes = hexToBytes(hmac.toString());
                    const offset = hmacBytes[hmacBytes.length - 1] & 0x0f;
                    const value = (
                        ((hmacBytes[offset] & 0x7f) << 24) |
                        ((hmacBytes[offset + 1] & 0xff) << 16) |
                        ((hmacBytes[offset + 2] & 0xff) << 8) |
                        (hmacBytes[offset + 3] & 0xff)
                    );
                    
                    const code = (value % 1000000).toString().padStart(6, '0');
                    
                    if (code === token) {
                        console.log('‚úÖ TOTP code verified');
                        return true;
                    }
                }
                
                return false;
            } catch (e) {
                console.error('‚ùå TOTP verification error:', e.message);
                return false;
            }
        }
        
        function base32Decode(str) {
            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
            let bits = 0;
            let value = 0;
            const result = [];
            
            for (let i = 0; i < str.length; i++) {
                const index = alphabet.indexOf(str[i].toUpperCase());
                if (index === -1) throw new Error('Invalid base32 character');
                
                value = (value << 5) | index;
                bits += 5;
                
                if (bits >= 8) {
                    bits -= 8;
                    result.push((value >> bits) & 0xff);
                }
            }
            
            return result;
        }
        
        function base32DecodeToString(str) {
            return String.fromCharCode(...base32Decode(str));
        }
        
        function hexToBytes(hex) {
            const bytes = [];
            for (let i = 0; i < hex.length; i += 2) {
                bytes.push(parseInt(hex.substr(i, 2), 16));
            }
            return bytes;
        }
        
        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.querySelectorAll('.totp-digit').forEach(input => input.value = '');
            document.getElementById('errorMessage').textContent = '';
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'guests') displayGuests();
            if (tabName === 'calendar') renderCalendar();
        }

        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('language', lang);
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            if (lang === 'en') document.getElementById('langEnBtn').classList.add('active');
            else document.getElementById('langItBtn').classList.add('active');
            updateTranslations();
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', currentTheme);
            localStorage.setItem('theme', currentTheme);
        }

        function setupFirebaseListeners() {
            if (!isFirebaseReady || listenersSetup) return;

            db.ref('shared/expenses').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    localStorage.setItem('expenses_shared', JSON.stringify(data));
                    displayExpenses();
                    displaySettlement();
                }
            });

            db.ref('shared/guests').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    localStorage.setItem('guests_shared', JSON.stringify(data));
                    displayGuests();
                }
            });

            db.ref('shared/calendar').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    localStorage.setItem('calendar_shared', JSON.stringify(data));
                    renderCalendar();
                }
            });

            listenersSetup = true;
        }

        function generateAndDownloadReport() {
            const period = document.getElementById('expensePeriod').value;
            const expenses = getExpenses();
            const cutoffDate = new Date();
            cutoffDate.setMonth(cutoffDate.getMonth() - parseInt(period));

            const filtered = expenses.filter(e => new Date(e.date) >= cutoffDate);
            let report = 'CHILLINGUITO LAKE COMO - EXPENSE REPORT\n\n';
            report += filtered.map(e => `${e.date}: ${e.description} - EUR ${e.amount.toFixed(2)} (${e.paidBy})`).join('\n');

            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'chillinguito-report.txt';
            a.click();
        }

        // ============ INIT ============
        document.addEventListener('DOMContentLoaded', () => {
            const theme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', theme);
            
            // Setup TOTP input
            setupTOTPInput();
            
            // Auth screen shown by default
            const authScreen = document.getElementById('authScreen');
            const mainApp = document.getElementById('mainApp');
            
            authScreen.style.display = 'flex';  // Show auth
            mainApp.style.display = 'none';      // Hide main until authenticated
            document.body.classList.add('locked');
        }); 
    </script>
</body>
</html>
