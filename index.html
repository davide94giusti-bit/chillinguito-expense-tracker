<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chillinguito Lake Como - v11 FINAL</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<style>
/* ============================================
   PERPLEXITY DESIGN SYSTEM - COLOR TOKENS
   ============================================ */

:root {
  /* Primitive Color Tokens */
  --color-white: rgba(255, 255, 255, 1);
  --color-black: rgba(0, 0, 0, 1);
  --color-cream-50: rgba(252, 252, 249, 1);
  --color-cream-100: rgba(255, 255, 253, 1);
  --color-gray-200: rgba(245, 245, 245, 1);
  --color-gray-300: rgba(167, 169, 169, 1);
  --color-gray-400: rgba(119, 124, 124, 1);
  --color-slate-500: rgba(98, 108, 113, 1);
  --color-brown-600: rgba(94, 82, 64, 1);
  --color-charcoal-700: rgba(31, 33, 33, 1);
  --color-charcoal-800: rgba(38, 40, 40, 1);
  --color-slate-900: rgba(19, 52, 59, 1);
  --color-teal-300: rgba(50, 184, 198, 1);
  --color-teal-400: rgba(45, 166, 178, 1);
  --color-teal-500: rgba(33, 128, 141, 1);
  --color-teal-600: rgba(29, 116, 128, 1);
  --color-teal-700: rgba(26, 104, 115, 1);
  --color-teal-800: rgba(41, 150, 161, 1);
  --color-red-400: rgba(255, 84, 89, 1);
  --color-red-500: rgba(192, 21, 47, 1);
  --color-orange-400: rgba(230, 129, 97, 1);
  --color-orange-500: rgba(168, 75, 47, 1);

  /* RGB versions */
  --color-brown-600-rgb: 94, 82, 64;
  --color-teal-500-rgb: 33, 128, 141;
  --color-slate-900-rgb: 19, 52, 59;
  --color-slate-500-rgb: 98, 108, 113;
  --color-red-500-rgb: 192, 21, 47;
  --color-red-400-rgb: 255, 84, 89;
  --color-orange-500-rgb: 168, 75, 47;
  --color-orange-400-rgb: 230, 129, 97;

  /* Semantic Colors */
  --color-background: var(--color-cream-50);
  --color-surface: var(--color-cream-100);
  --color-text: var(--color-slate-900);
  --color-text-secondary: var(--color-slate-500);
  --color-primary: var(--color-teal-500);
  --color-primary-hover: var(--color-teal-600);
  --color-primary-active: var(--color-teal-700);
  --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
  --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
  --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
  --color-border: rgba(var(--color-brown-600-rgb), 0.2);
  --color-btn-primary-text: var(--color-cream-50);
  --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
  --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
  --color-error: var(--color-red-500);
  --color-success: var(--color-teal-500);
  --color-warning: var(--color-orange-500);
  --color-info: var(--color-slate-500);
  --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
  --color-success-rgb: 33, 128, 141;
  --color-error-rgb: 192, 21, 47;
  --color-warning-rgb: 168, 75, 47;
  --color-info-rgb: 98, 108, 113;

  /* Typography */
  --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  --font-family-mono: "Berkeley Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  --font-size-xs: 11px;
  --font-size-sm: 12px;
  --font-size-base: 14px;
  --font-size-md: 14px;
  --font-size-lg: 16px;
  --font-size-xl: 18px;
  --font-size-2xl: 20px;
  --font-size-3xl: 24px;
  --font-size-4xl: 30px;
  --font-weight-normal: 400;
  --font-weight-medium: 500;
  --font-weight-semibold: 550;
  --font-weight-bold: 600;
  --line-height-tight: 1.2;
  --line-height-normal: 1.5;
  --letter-spacing-tight: -0.01em;

  /* Spacing */
  --space-0: 0;
  --space-1: 1px;
  --space-2: 2px;
  --space-4: 4px;
  --space-6: 6px;
  --space-8: 8px;
  --space-10: 10px;
  --space-12: 12px;
  --space-16: 16px;
  --space-20: 20px;
  --space-24: 24px;
  --space-32: 32px;

  /* Border Radius */
  --radius-sm: 6px;
  --radius-base: 8px;
  --radius-md: 10px;
  --radius-lg: 12px;
  --radius-full: 9999px;

  /* Shadows */
  --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.02);
  --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
  --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.15), inset 0 -1px 0 rgba(0, 0, 0, 0.03);

  /* Animation */
  --duration-fast: 150ms;
  --duration-normal: 250ms;
  --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);

  /* Layout */
  --container-sm: 640px;
  --container-md: 768px;
  --container-lg: 1024px;
  --container-xl: 1280px;
}

/* Dark mode */
@media (prefers-color-scheme: dark) {
  :root {
    --color-gray-400-rgb: 119, 124, 124;
    --color-teal-300-rgb: 50, 184, 198;
    --color-gray-300-rgb: 167, 169, 169;
    --color-gray-200-rgb: 245, 245, 245;
    --color-background: var(--color-charcoal-700);
    --color-surface: var(--color-charcoal-800);
    --color-text: var(--color-gray-200);
    --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
    --color-primary: var(--color-teal-300);
    --color-primary-hover: var(--color-teal-400);
    --color-primary-active: var(--color-teal-800);
    --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);
    --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
    --color-secondary-active: rgba(var(--color-gray-400-rgb), 0.3);
    --color-border: rgba(var(--color-gray-400-rgb), 0.3);
    --color-error: var(--color-red-400);
    --color-success: var(--color-teal-300);
    --color-warning: var(--color-orange-400);
    --color-info: var(--color-gray-300);
    --color-focus-ring: rgba(var(--color-teal-300-rgb), 0.4);
    --color-btn-primary-text: var(--color-slate-900);
    --color-card-border: rgba(var(--color-gray-400-rgb), 0.2);
    --color-card-border-inner: rgba(var(--color-gray-400-rgb), 0.15);
    --color-success-rgb: var(--color-teal-300-rgb);
    --color-error-rgb: var(--color-red-400-rgb);
    --color-warning-rgb: var(--color-orange-400-rgb);
    --color-info-rgb: var(--color-gray-300-rgb);
  }
}

[data-color-scheme="dark"] {
  --color-background: var(--color-charcoal-700);
  --color-surface: var(--color-charcoal-800);
  --color-text: var(--color-gray-200);
  --color-primary: var(--color-teal-300);
  --color-primary-hover: var(--color-teal-400);
  --color-primary-active: var(--color-teal-800);
  --color-border: rgba(119, 124, 124, 0.3);
  --color-card-border: rgba(119, 124, 124, 0.15);
}

[data-color-scheme="light"] {
  --color-background: var(--color-cream-50);
  --color-surface: var(--color-cream-100);
  --color-text: var(--color-slate-900);
  --color-primary: var(--color-teal-500);
  --color-primary-hover: var(--color-teal-600);
  --color-primary-active: var(--color-teal-700);
  --color-border: rgba(94, 82, 64, 0.2);
  --color-card-border: rgba(94, 82, 64, 0.12);
}

/* Base styles */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html, body {
  width: 100%;
  height: 100vh;
  height: 100dvh;
  margin: 0;
  padding: 0;
  overflow: hidden;
  font-family: var(--font-family-base);
  background-color: var(--color-background);
  color: var(--color-text);
}

#authScreen {
  background: linear-gradient(135deg, rgba(26, 58, 82, 0.8), rgba(46, 139, 158, 0.8)), url('https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=1200&h=1200&fit=crop') center/cover no-repeat;
  background-attachment: scroll;
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

@media (max-width: 768px) {
  #authScreen {
    background-attachment: scroll !important;
    background-size: cover !important;
  }
}

.auth-container {
  background: white;
  border-radius: 24px;
  padding: 48px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
  max-width: 450px;
  width: 100%;
  text-align: center;
}

.auth-container h1 {
  color: #0066CC;
  font-size: 40px;
  font-weight: 700;
  margin: 0 0 12px 0;
  letter-spacing: -0.5px;
}

.auth-container p {
  color: #666;
  font-size: 15px;
  margin: 0 0 32px 0;
  line-height: 1.5;
}

.user-grid {
  display: flex;
  gap: 16px;
  margin-bottom: 28px;
  justify-content: center;
}

.user-choice {
  padding: 14px 28px;
  border: 2px solid #ddd;
  border-radius: 24px;
  background: white;
  cursor: pointer;
  font-weight: 600;
  font-size: 16px;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  min-width: 140px;
  color: #333;
}

.user-choice:hover {
  border-color: #0066CC;
  background: rgba(0, 102, 204, 0.05);
}

.user-choice.active {
  border-color: #0066CC;
  background: rgba(0, 102, 204, 0.1);
  color: #0066CC;
}

.code-input {
  display: flex;
  gap: 8px;
  justify-content: center;
  margin: 24px 0 32px 0;
  flex-wrap: wrap;
}

.code-box {
  width: 48px;
  height: 48px;
  font-size: 22px !important;
  font-weight: 600;
  text-align: center;
  border: 2px solid #ddd !important;
  border-radius: 10px;
  color: #333;
  background: white !important;
  padding: 0 !important;
  transition: all 0.2s ease;
}

.code-box:focus {
  outline: none;
  border-color: #0066CC !important;
  box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
}

.unlock-btn {
  width: 100%;
  padding: 16px;
  background: linear-gradient(135deg, #0066CC, #2E8B9E);
  color: white;
  border: none;
  border-radius: 24px;
  font-size: 18px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  min-height: 56px;
  box-shadow: 0 4px 15px rgba(0, 102, 204, 0.3);
  margin-bottom: 16px;
}

.unlock-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0, 102, 204, 0.4);
}

.unlock-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.error-message {
  color: #F44336;
  font-size: 13px;
  margin-bottom: 16px;
  min-height: 18px;
}

.auth-info {
  background: rgba(255, 193, 7, 0.08);
  border: 1px solid rgba(255, 193, 7, 0.2);
  padding: 14px;
  border-radius: 12px;
  font-size: 13px;
  color: #555;
  line-height: 1.5;
}

/* ============================================
   COMPLETE MOBILE CALENDAR CSS FIX
   ============================================ */

/* TABLET: 600px - 768px */
@media (max-width: 768px) {
  .calendar-container {
    padding: var(--space-16);
  }
  
  .calendar-days {
    gap: var(--space-6);
  }
  
  .calendar-day {
    min-height: 52px;
    padding: var(--space-4);
    font-size: var(--font-size-xs);
  }
  
  .day-number {
    font-size: var(--font-size-md);
  }
  
  .day-status {
    font-size: 8px;
  }
  
  .calendar-header h2 {
    font-size: var(--font-size-2xl);
  }
  
  .header-top {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .header-status {
    width: 100%;
    flex-direction: column;
    align-items: flex-start;
  }
  
  .tab-content {
    padding: var(--space-16);
  }
  
  .card {
    padding: var(--space-16);
  }
  
  .form-row {
    grid-template-columns: 1fr;
  }
  
  .filter-section {
    grid-template-columns: 1fr;
  }
  
  .stats {
    grid-template-columns: 1fr;
  }
  
  .expense-item {
    flex-direction: column;
  }
  
  .expense-amount {
    text-align: left;
  }
  
  .guest-info-row {
    grid-template-columns: 1fr;
  }
  
  .tourist-tax-row {
    grid-template-columns: 1fr;
  }
}

/* MEDIUM PHONES: 480px - 599px */
@media (max-width: 599px) {
  .calendar-container {
    padding: var(--space-10) !important;
    border-radius: var(--radius-md) !important;
  }
  
  .calendar-header {
    margin-bottom: var(--space-16) !important;
    padding-bottom: var(--space-10) !important;
  }
  
  .calendar-header h2 {
    font-size: var(--font-size-xl) !important;
  }
  
  .calendar-nav button {
    padding: var(--space-6) var(--space-12) !important;
    font-size: var(--font-size-sm) !important;
  }
  
  .calendar-nav span {
    font-size: var(--font-size-sm) !important;
    padding: 0 var(--space-8) !important;
    min-width: 100px !important;
  }
  
  .calendar-weekdays {
    gap: var(--space-4) !important;
    margin-bottom: var(--space-10) !important;
  }
  
  .weekday {
    font-size: var(--font-size-xs) !important;
    padding: var(--space-4) !important;
  }
  
  .calendar-days {
    gap: var(--space-4) !important;
  }
  
  .calendar-day {
    aspect-ratio: 1 !important;
    min-height: 46px !important;
    padding: var(--space-2) !important;
    font-size: var(--font-size-xs) !important;
    border-radius: var(--radius-sm) !important;
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
  }
  
  .day-number {
    font-size: var(--font-size-sm) !important;
    font-weight: var(--font-weight-bold) !important;
    line-height: var(--line-height-tight) !important;
    margin-bottom: var(--space-1) !important;
  }
  
  .day-status {
    font-size: 7px !important;
    font-weight: var(--font-weight-semibold) !important;
    text-transform: uppercase !important;
    opacity: 0.9 !important;
    margin: 0 !important;
    padding: 0 !important;
  }
  
  .day-notes {
    display: none !important;
  }
}

/* SMALL PHONES: under 480px (Mobile Portrait) */
@media (max-width: 480px) {
  html, body {
    width: 100%;
    height: 100vh;
    height: 100dvh;
  }
  
  #appBody {
    width: 100%;
    height: 100%;
    min-height: 100%;
  }
  
  #authScreen {
    min-height: 100%;
    height: 100%;
  }
  
  .auth-container {
    padding: var(--space-24);
  }
  
  header {
    padding: var(--space-16) 0;
  }
  
  .calendar-container {
    padding: var(--space-8) !important;
    border-radius: var(--radius-md) !important;
    background: var(--color-surface) !important;
    border: 1px solid var(--color-card-border) !important;
  }
  
  .calendar-header {
    margin-bottom: var(--space-12) !important;
    padding-bottom: var(--space-10) !important;
    border-bottom: 1px solid var(--color-card-border-inner) !important;
  }
  
  .calendar-header h2 {
    font-size: var(--font-size-lg) !important;
  }
  
  .calendar-nav button {
    padding: var(--space-6) var(--space-10) !important;
    font-size: var(--font-size-xs) !important;
  }
  
  .calendar-nav span {
    font-size: var(--font-size-xs) !important;
    padding: 0 var(--space-6) !important;
    min-width: 90px !important;
  }
  
  .calendar-weekdays {
    gap: var(--space-4) !important;
    margin-bottom: var(--space-8) !important;
  }
  
  .weekday {
    font-size: 9px !important;
    padding: var(--space-4) !important;
  }
  
  .calendar-days {
    display: grid !important;
    grid-template-columns: repeat(7, 1fr) !important;
    gap: var(--space-4) !important;
    width: 100% !important;
  }
  
  .calendar-day {
    aspect-ratio: 1 !important;
    min-height: 42px !important;
    max-height: 42px !important;
    padding: var(--space-1) !important;
    font-size: 9px !important;
    border-radius: var(--radius-sm) !important;
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
    border: 1px solid transparent !important;
    line-height: var(--line-height-tight) !important;
    transition: transform var(--duration-fast) var(--ease-standard), box-shadow var(--duration-fast) var(--ease-standard);
  }
  
  .day-number {
    font-size: var(--font-size-xs) !important;
    font-weight: var(--font-weight-bold) !important;
    line-height: var(--line-height-tight) !important;
    margin: 0 !important;
    padding: 0 !important;
  }
  
  .day-status {
    font-size: 6px !important;
    font-weight: var(--font-weight-semibold) !important;
    text-transform: uppercase !important;
    opacity: 0.85 !important;
    margin: 0 !important;
    padding: 0 !important;
    line-height: var(--line-height-tight) !important;
  }
  
  .day-notes {
    display: none !important;
  }
  
  .calendar-day.available {
    background: var(--color-success) !important;
    border-color: var(--color-primary-active) !important;
    color: var(--color-btn-primary-text) !important;
  }
  
  .calendar-day.available:hover,
  .calendar-day.available:active {
    transform: scale(1.01) !important;
    box-shadow: 0 1px 4px rgba(var(--color-success-rgb), 0.2) !important;
  }
  
  .calendar-day.occupied {
    background: var(--color-error) !important;
    border-color: rgba(var(--color-error-rgb), 0.8) !important;
    color: var(--color-btn-primary-text) !important;
  }
  
  .calendar-day.occupied:hover,
  .calendar-day.occupied:active {
    transform: scale(1.01) !important;
    box-shadow: 0 1px 4px rgba(var(--color-error-rgb), 0.2) !important;
  }
  
  .calendar-day.cleaning {
    background: var(--color-warning) !important;
    border-color: rgba(var(--color-warning-rgb), 0.8) !important;
    color: var(--color-btn-primary-text) !important;
  }
  
  .calendar-day.cleaning:hover,
  .calendar-day.cleaning:active {
    transform: scale(1.01) !important;
    box-shadow: 0 1px 4px rgba(var(--color-warning-rgb), 0.2) !important;
  }
  
  .calendar-day.maintenance {
    background: var(--color-info) !important;
    border-color: rgba(var(--color-info-rgb), 0.8) !important;
    color: var(--color-btn-primary-text) !important;
  }
  
  .calendar-day.maintenance:hover,
  .calendar-day.maintenance:active {
    transform: scale(1.01) !important;
    box-shadow: 0 1px 4px rgba(var(--color-info-rgb), 0.2) !important;
  }
  
  .calendar-day.other-month {
    background: var(--color-secondary) !important;
    border-color: var(--color-border) !important;
    color: var(--color-text-secondary) !important;
    opacity: 0.5;
  }
  
  .calendar-day.other-month:hover {
    transform: none !important;
  }
  
  .header-top h1 {
    font-size: var(--font-size-3xl);
  }
  
  .tab-btn {
    padding: var(--space-8) var(--space-12);
    font-size: var(--font-size-sm);
  }
  
  .card {
    padding: var(--space-12);
    border-radius: var(--radius-lg);
  }
  
  .modal-content {
    max-height: 100vh;
    border-radius: var(--radius-lg);
  }
}

/* ULTRA-SMALL PHONES: under 360px */
@media (max-width: 359px) {
  .calendar-container {
    padding: var(--space-6) !important;
  }
  
  .calendar-days {
    gap: var(--space-2) !important;
  }
  
  .calendar-day {
    min-height: 38px !important;
    max-height: 38px !important;
  }
  
  .day-number {
    font-size: var(--font-size-xs) !important;
  }
  
  .day-status {
    font-size: 5px !important;
  }
}

/* Calendar styles */
.calendar-container {
  background: var(--color-surface);
  border-radius: var(--radius-lg);
  padding: var(--space-16);
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--color-card-border);
}

.calendar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--space-20);
  padding-bottom: var(--space-12);
  border-bottom: 1px solid var(--color-border);
}

.calendar-header h2 {
  font-size: var(--font-size-2xl);
  font-weight: var(--font-weight-bold);
  color: var(--color-primary);
  margin: 0;
}

.calendar-nav {
  display: flex;
  gap: var(--space-8);
  align-items: center;
}

.calendar-nav button {
  background: var(--color-primary);
  color: white;
  border: none;
  padding: var(--space-8) var(--space-16);
  border-radius: var(--radius-base);
  cursor: pointer;
  font-weight: 600;
  transition: all var(--duration-normal) var(--ease-standard);
}

.calendar-nav button:hover {
  background: var(--color-primary-hover);
  transform: translateY(-2px);
}

.calendar-nav span {
  padding: 0 var(--space-16);
  font-weight: 600;
  min-width: 150px;
  text-align: center;
  color: var(--color-text);
  font-size: var(--font-size-base);
}

.calendar-weekdays {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: var(--space-8);
  margin-bottom: var(--space-12);
  text-align: center;
}

.weekday {
  font-weight: 700;
  color: var(--color-text-secondary);
  font-size: var(--font-size-xs);
  padding: var(--space-8);
  text-transform: uppercase;
}

.calendar-days {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: var(--space-8);
}

.calendar-day {
  aspect-ratio: 1;
  border-radius: var(--radius-base);
  padding: var(--space-8);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: var(--font-size-sm);
  cursor: pointer;
  transition: all var(--duration-normal) var(--ease-standard);
  border: 1px solid transparent;
  min-height: 60px;
  text-align: center;
  color: white;
}

.calendar-day.available {
  background: var(--color-success);
  border-color: rgba(var(--color-success-rgb), 0.5);
}

.calendar-day.available:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(var(--color-success-rgb), 0.4);
}

.calendar-day.occupied {
  background: var(--color-error);
  border-color: rgba(var(--color-error-rgb), 0.5);
}

.calendar-day.occupied:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(var(--color-error-rgb), 0.4);
}

.calendar-day.cleaning {
  background: var(--color-warning);
  border-color: rgba(var(--color-warning-rgb), 0.5);
}

.calendar-day.cleaning:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(var(--color-warning-rgb), 0.4);
}

.calendar-day.maintenance {
  background: var(--color-info);
  border-color: rgba(var(--color-info-rgb), 0.5);
}

.calendar-day.maintenance:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(var(--color-info-rgb), 0.4);
}

.calendar-day.other-month {
  color: var(--color-text-secondary);
  background: var(--color-secondary);
  border-color: var(--color-border);
  cursor: default;
  opacity: 0.5;
}

.calendar-day.other-month:hover {
  transform: none;
}

.day-number {
  font-size: var(--font-size-base);
  font-weight: 700;
  line-height: var(--line-height-tight);
  margin-bottom: var(--space-2);
}

.day-status {
  font-size: var(--font-size-xs);
  font-weight: 600;
  text-transform: uppercase;
  opacity: 0.85;
  letter-spacing: 0.5px;
  margin-top: var(--space-1);
}

.day-notes {
  font-size: 8px;
  opacity: 0.6;
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  margin-top: var(--space-1);
}

    </style>
</head>
<body id="appBody">
    <!-- AUTH SCREEN -->
<div id="authScreen" class="auth-screen">
    <div class="auth-container">
        <div class="auth-icon">üè†</div>
        <h1 id="authTitle">Chillinguito</h1>
        <p id="authSubtitle">Select your account & enter 2FA code</p>
        
        <div class="auth-step">
            <div class="user-grid">
                <button class="user-choice" data-user="davide" onclick="selectUser('davide')">
                    <span>üë®</span>
                    <span>Davide</span>
                </button>
                <button class="user-choice" data-user="mattia" onclick="selectUser('mattia')">
                    <span>üë®</span>
                    <span>Mattia</span>
                </button>
            </div>
        </div>

        <div class="auth-step">
            <label id="authCodeLabel">Enter 6-digit code:</label>
            <div class="code-input">
                <input type="text" class="code-box" maxlength="1" inputmode="numeric">
                <input type="text" class="code-box" maxlength="1" inputmode="numeric">
                <input type="text" class="code-box" maxlength="1" inputmode="numeric">
                <input type="text" class="code-box" maxlength="1" inputmode="numeric">
                <input type="text" class="code-box" maxlength="1" inputmode="numeric">
                <input type="text" class="code-box" maxlength="1" inputmode="numeric">
            </div>
        </div>

        <button id="unlockBtn" class="unlock-btn" onclick="validateTOTP()">Unlock</button>

        <div id="errorMsg" class="error-message"></div>
        <div id="authInfo" class="auth-info">üí° Both users use the same code from Microsoft Authenticator</div>
    </div>
</div>

    <!-- MAIN APP -->
    <div id="mainApp">
        <header>
            <div class="container">
                <div class="header-top">
                    <div>
                        <h1 id="appTitle">üè† Chillinguito Lake Como</h1>
                        <p id="appSubtitle">Expense Tracker & Guest Manager</p>
                    </div>
                    
                    <div class="header-status">
                        <div id="syncStatusIndicator" class="sync-status-indicator">
                            <div class="sync-dot" id="syncDot"></div>
                            <span id="syncStatus">Syncing...</span>
                        </div>

                        <div id="dbStatusIndicator" class="status-badge">
                            <span class="status-dot" id="dbStatusDot"></span>
                            <span id="dbStatus">DB Connected</span>
                        </div>

                        <div id="otherUserStatusIndicator" class="status-badge">
                            <span class="status-dot" id="otherUserDot"></span>
                            <span id="otherUserStatus">Mattia online</span>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <div class="user-badge" id="userBadge">
                            <span id="userIcon">üë®</span>
                            <span id="userName">Davide</span>
                        </div>
                        <button class="lang-btn active" onclick="setLanguage('en')" id="langEnBtn">üá¨üáß EN</button>
                        <button class="lang-btn" onclick="setLanguage('it')" id="langItBtn">üáÆüáπ IT</button>
                        <button class="theme-btn" onclick="toggleTheme()">üåô</button>
                        <button class="logout-btn" onclick="logout()" id="logoutBtn">üîí Logout</button>
                    </div>
                </div>
            </div>
        </header>

        <div class="container" style="display: flex; flex-direction: column; flex: 1; overflow: visible;">
            <div id="notificationContainer"></div>
            
            <!-- TABS (NOT SCROLLABLE) -->
            <div class="tabs" style="flex-shrink: 0;">
                <button class="tab-btn active" onclick="switchTab('add-expense')" id="tabAddExpense">Add Expense</button>
                <button class="tab-btn" onclick="switchTab('expenses-list')" id="tabExpensesList">All Expenses</button>
                <button class="tab-btn" onclick="switchTab('settlement')" id="tabSettlement">Settlement</button>
                <button class="tab-btn" onclick="switchTab('guests')" id="tabGuests">üë• Guests</button>
                <button class="tab-btn" onclick="switchTab('calendar')" id="tabCalendar">Calendar</button>
                <button class="tab-btn" onclick="switchTab('export')" id="tabExport">Export</button>
            </div>

            <!-- SCROLLABLE CONTENT AREA -->
            <div style="flex: 1; overflow-y: scroll; scrollbar-gutter: stable;">
                <!-- ADD EXPENSE TAB -->
                <div id="add-expense" class="tab-content active">
                    <div class="card">
                        <h2 id="addExpenseTitle" style="margin-bottom: 20px;">Add New Expense</h2>
                        <form onsubmit="addExpense(event)">
                            <div class="form-group">
                                <label for="description" id="descLabel">Description</label>
                                <input type="text" id="description" placeholder="e.g., Cleaning supplies, Groceries" required>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="amount" id="amountLabel">Amount (EUR)</label>
                                    <input type="number" id="amount" placeholder="0.00" step="0.01" min="0" required>
                                </div>
                                <div class="form-group">
                                    <label for="category" id="categoryLabel">Category</label>
                                    <select id="category" required>
                                        <option value=""></option>
                                        <option value="Cleaning" id="catCleaning">Cleaning & Maintenance</option>
                                        <option value="Utilities" id="catUtilities">Utilities (Water, Gas, Electric)</option>
                                        <option value="Groceries" id="catGroceries">Groceries & Food</option>
                                        <option value="Repairs" id="catRepairs">Repairs & Equipment</option>
                                        <option value="Other" id="catOther">Other</option>
                                    </select>
                                </div>
                            </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="paidBy" id="paidByLabel">Paid By</label>
                                <select id="paidBy" required>
                                    <option value=""></option>
                                    <option value="Davide">Davide</option>
                                    <option value="Mattia">Mattia</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="splitBetween" id="splitLabel">Split Between</label>
                                <select id="splitBetween" required>
                                    <option value=""></option>
                                    <option value="Both" id="splitBoth">Both (50/50)</option>
                                    <option value="Davide" id="splitDavide">Davide Only</option>
                                    <option value="Mattia" id="splitMattia">Mattia Only</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="date" id="dateLabel">Date</label>
                            <input type="date" id="date" required style="width: 100%;">
                        </div>

                        <div class="form-group">
                            <label for="notes" id="notesLabel">Notes (optional)</label>
                            <textarea id="notes" placeholder="Add notes..." rows="3"></textarea>
                        </div>

                        <div class="form-group">
                            <button type="button" class="camera-btn" onclick="openCamera()" id="cameraBtn">üì∑ Take Receipt Photo</button>
                            <input type="file" id="cameraInput" accept="image/" capture="environment" onchange="handleCameraCapture()">
                            <div id="receiptPreview" style="margin-top: 10px;"></div>
                        </div>

                        <button type="submit" class="btn-primary" id="addExpenseBtn" style="width: 100%; padding: 12px;">Add Expense</button>
                    </form>
                </div>
            </div>

            <!-- EXPENSES LIST TAB -->
            <div id="expenses-list" class="tab-content">
                <div class="filter-section">
                    <div class="filter-input">
                        <input type="text" id="searchInput" placeholder="Search by description..." onkeyup="filterExpenses()">
                    </div>
                    <div class="filter-input">
                        <select id="filterCategory" onchange="filterExpenses()">
                            <option value="">All Categories</option>
                            <option value="Cleaning">Cleaning</option>
                            <option value="Utilities">Utilities</option>
                            <option value="Groceries">Groceries</option>
                            <option value="Repairs">Repairs</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="filter-input">
                        <select id="filterMonth" onchange="filterExpenses()">
                            <option value="">All Months</option>
                        </select>
                    </div>
                    <div class="filter-input">
                        <select id="filterYear" onchange="filterExpenses()">
                            <option value="">All Years</option>
                        </select>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h2 id="allExpensesTitle">All Expenses</h2>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn-secondary" onclick="clearAllExpenses()" id="clearAllBtn" style="color: var(--danger);">Clear All</button>
                        </div>
                    </div>
                    <div id="expensesList"></div>
                </div>
            </div>

            <!-- SETTLEMENT TAB -->
            <div id="settlement" class="tab-content">
                <div class="settlement-summary">
                    <div class="settlement-banner" id="settlementBanner"></div>
                    
                    <div class="summary-title" id="settlementTitle">Current Settlement Status</div>
                    
                    <div class="stats">
                        <div class="stat-box-large">
                            <div class="stat-label" id="totalLabel">Total Expenses</div>
                            <div class="stat-value" id="totalExpenses">EUR 0.00</div>
                        </div>
                    </div>

                    <div class="stats-secondary">
                        <div class="stat-box">
                            <div class="stat-label" id="davidePaidLabel">Davide Paid</div>
                            <div class="stat-value" id="davidePaid">EUR 0.00</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label" id="mattiaPaidLabel">Mattia Paid</div>
                            <div class="stat-value" id="mattiaPaid">EUR 0.00</div>
                        </div>
                    </div>

                    <div style="margin-top: 20px;">
                        <h3 id="whoOwesLabel" style="margin-bottom: 15px; color: var(--primary);">üí∏ Who Owes Whom</h3>
                        <div id="settlementDetails"></div>
                    </div>

                    <div class="settlement-payments">
                        <h4 id="recordPaymentLabel" style="margin-bottom: 15px; color: var(--primary);">üí∞ Record Partial Payment</h4>
                        
                        <div id="progressContainer">
                            <div style="margin-bottom: 8px; display: flex; justify-content: space-between; font-size: 12px; color: var(--text-secondary);">
                                <span id="progressLabel">Payment Progress</span>
                                <span id="progressPercent">0%</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                            </div>
                        </div>

                        <div class="payment-input-group">
                            <input type="number" id="paymentAmount" placeholder="Amount (EUR)" step="0.01" min="0">
                            <select id="paymentFrom" style="flex: 1; min-width: 120px;">
                                <option value="davide" id="davidePayOpt">Davide pays</option>
                                <option value="mattia" id="mattiaPayOpt">Mattia pays</option>
                            </select>
                            <button type="button" class="btn-primary" onclick="recordPayment()" id="recordPaymentBtn" style="flex-shrink: 0;">Record</button>
                        </div>
                        <div id="paymentHistory" class="payment-history"></div>
                    </div>
                </div>
            </div>

            <!-- GUESTS TAB -->
            <div id="guests" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2 id="guestsTitle">üë• Guests Management</h2>
                        <button class="btn-primary" onclick="openAddGuestModal()" id="addGuestBtn">‚ûï Add Guest</button>
                    </div>

                    <div class="filter-section">
                        <div class="filter-input">
                            <input type="text" id="guestSearchInput" placeholder="Search by guest name..." onkeyup="filterGuests()">
                        </div>
                        <div class="filter-input">
                            <input type="date" id="guestDateFilter" onchange="filterGuests()">
                        </div>
                        <div class="filter-input">
                            <select id="guestStatusFilter" onchange="filterGuests()">
                                <option value="">All Status</option>
                                <option value="upcoming">Upcoming</option>
                                <option value="current">Current</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                    </div>

                    <div id="guestsList"></div>
                </div>
            </div>

            <!-- CALENDAR TAB -->
            <div id="calendar" class="tab-content">
                <div class="calendar-container">
                    <div class="calendar-header">
                        <h2 id="calendarTitle">Airbnb Calendar</h2>
                        <div class="calendar-nav">
                            <button onclick="previousMonth()" id="prevBtn">Previous</button>
                            <span id="currentMonth" style="padding: 0 20px; font-weight: 600; min-width: 150px; text-align: center;"></span>
                            <button onclick="nextMonth()" id="nextBtn">Next</button>
                        </div>
                    </div>

                    <div class="calendar-weekdays">
                        <div class="weekday" id="weekdaySun">Sun</div>
                        <div class="weekday" id="weekdayMon">Mon</div>
                        <div class="weekday" id="weekdayTue">Tue</div>
                        <div class="weekday" id="weekdayWed">Wed</div>
                        <div class="weekday" id="weekdayThu">Thu</div>
                        <div class="weekday" id="weekdayFri">Fri</div>
                        <div class="weekday" id="weekdaySat">Sat</div>
                    </div>

                    <div id="calendarDays" class="calendar-days"></div>
                </div>
            </div>

            <!-- EXPORT TAB -->
            <div id="export" class="tab-content">
                <div class="export-section">
                    <h2 id="exportTitle" style="margin-bottom: 20px;">Monthly Summary & Export</h2>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 id="expensePeriodLabel" style="margin-bottom: 10px;">Expense Period</h4>
                        <select id="expensePeriod" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 15px;">
                            <option value="1">Current Month</option>
                            <option value="3">Last 3 Months</option>
                            <option value="6">Last 6 Months</option>
                            <option value="9">Last 9 Months</option>
                            <option value="12">Last 12 Months</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h4 id="cleaningPeriodLabel" style="margin-bottom: 10px;">Cleaning Dates Period</h4>
                        <select id="cleaningPeriod" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 15px;">
                            <option value="1">Current Month</option>
                            <option value="3">Next 3 Months</option>
                            <option value="6">Next 6 Months</option>
                            <option value="9">Next 9 Months</option>
                            <option value="12">Next 12 Months</option>
                        </select>
                    </div>

                    <button class="btn-primary" id="downloadReportBtn" style="width: 100%; margin-top: 20px; font-size: 18px;" onclick="generateAndDownloadReport()">üìä Download Report</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modalContainer"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // ============ STATE ============
        const TOTP_SECRET = 'JBSWY3DPEHPK3PXP';
        let currentUser = null;
        let selectedUsername = null;
        let listenersSetup = false;
        let currentTheme = localStorage.getItem('theme') || 'light';
        let currentLanguage = localStorage.getItem('language') || 'en';
        let currentCalendarDate = new Date();
        let occupiedDates = []
        let cleaningDates = []
        let filteredExpenses = [];
        let filteredGuests = [];
        let receiptBase64 = null;
        let dbConnected = false;
        let otherUserOnline = false;
        let currentEditingGuestId = null;
        let guestPhotos = [];

        const firebaseConfig = {
            apiKey: "AIzaSyCwF7bvS12h3AM14gmAEKV16BjH4Bq6TWU",
            authDomain: "airbnb-expense-tracker-7f531.firebaseapp.com",
            databaseURL: "https://airbnb-expense-tracker-7f531-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "airbnb-expense-tracker-7f531",
            storageBucket: "airbnb-expense-tracker-7f531.firebasestorage.app",
            messagingSenderId: "466998817774",
            appId: "1:466998817774:web:f4b244ac7cfa1723dbd4ff"
        };

        let firebaseApp = null;
        let db = null;
        let isFirebaseReady = false;
        
 // ‚úÖ SHOW AUTH INSTANTLY - don't wait for Firebase
document.getElementById('authScreen').style.display = 'flex'
document.getElementById('mainApp').style.display = 'none'

// ‚úÖ Initialize Firebase in BACKGROUND - non-blocking
setTimeout(() => {
  try {
    firebaseApp = firebase.initializeApp(firebaseConfig)
    db = firebase.database()
    isFirebaseReady = true
    console.log('‚úÖ Firebase ready')
  } catch (e) {
    console.warn('‚ö†Ô∏è Firebase offline', e.message)
  }
}, 0)

// Force ready after 5 seconds max (for slow networks)
setTimeout(() => {
  isFirebaseReady = true
  console.log('‚è±Ô∏è Forcing Firebase ready after timeout')
}, 5000)     

        // ============ TRANSLATIONS ============
        const translations = {
    en: {
        authTitle: "Chillinguito",
        authSubtitle: "Select your account & enter 2FA code",
        authCodeLabel: "Enter 6-digit code:",
        unlockBtn: "Unlock",
        authInfo: "üí° Both users use the same code from Microsoft Authenticator",
        appTitle: "üè† Chillinguito Lake Como",
        appSubtitle: "Expense Tracker & Guest Manager",
        langEnBtn: "üá¨üáß EN",
        langItBtn: "üáÆüáπ IT",
        logoutBtn: "üîí Logout",
        tabAddExpense: "Add Expense",
        tabExpensesList: "All Expenses",
        tabSettlement: "Settlement",
        tabGuests: "üë• Guests",
        tabCalendar: "Calendar",
        tabExport: "Export",
        addExpenseTitle: "Add New Expense",
        descLabel: "Description",
        amountLabel: "Amount (EUR)",
        categoryLabel: "Category",
        paidByLabel: "Paid By",
        splitLabel: "Split Between",
        dateLabel: "Date",
        notesLabel: "Notes (optional)",
        cameraBtn: "üì∑ Take Receipt Photo",
        addExpenseBtn: "Add Expense",
        catCleaning: "Cleaning & Maintenance",
        catUtilities: "Utilities (Water, Gas, Electric)",
        catGroceries: "Groceries & Food",
        catRepairs: "Repairs & Equipment",
        catOther: "Other",
        splitBoth: "Both (50/50)",
        splitDavide: "Davide Only",
        splitMattia: "Mattia Only",
        allExpensesTitle: "All Expenses",
        clearAllBtn: "Clear All",
        settlementTitle: "Current Settlement Status",
        totalLabel: "Total Expenses",
        davidePaidLabel: "Davide Paid",
        mattiaPaidLabel: "Mattia Paid",
        whoOwesLabel: "üí∏ Who Owes Whom",
        recordPaymentLabel: "üí∞ Record Partial Payment",
        recordPaymentBtn: "Record",
        davidePayOpt: "Davide pays",
        mattiaPayOpt: "Mattia pays",
        guestsTitle: "üë• Guests Management",
        addGuestBtn: "‚ûï Add Guest",
        checkIn: "Check-in Date",
        checkOut: "Check-out Date",
        guestNotes: "Special Notes & Requirements",
        addDocuments: "üìÅ Add Documents",
        saveGuest: "Save Guest",
        editGuest: "Edit Guest",
        deleteGuest: "Delete Guest",
        guestAdded: "‚úÖ Guest added successfully",
        guestDeleted: "üóëÔ∏è Guest deleted",
        documentAdded: "‚úÖ Document added",
        upcoming: "Upcoming",
        current: "Current",
        completed: "Completed",
        noGuests: "No guests found",
        clearHistoryConfirm: "‚ö†Ô∏è Delete ALL expenses and payments? This cannot be undone!",
        historyCleared: "üóëÔ∏è All history cleared",
        guestPhotos: "Guest Photos",
        addPhotos: "üì∏ Add Photos",
        touristTaxSection: "Tourist Tax (Como Decree)",
        touristTaxAmount: "Tourist tax amount",
        touristTaxPaid: "Paid",
        calendarTitle: "Airbnb Calendar",
        prevBtn: "Previous",
        nextBtn: "Next",
        exportTitle: "Monthly Summary & Export",
        expensePeriodLabel: "Expense Period",
        cleaningPeriodLabel: "Cleaning Dates Period",
        downloadReportBtn: "üìä Download Report",
        addedNotif: "‚úÖ Expense added",
        deletedNotif: "üóëÔ∏è Expense deleted",
        allSettledMsg: "‚úÖ All settled!",
        owesMsg: "{person} owes {other}: EUR {amount}",
        noExpenses: "No expenses found"
    },
    it: {
        authTitle: "Chillinguito",
        authSubtitle: "Seleziona il tuo account e inserisci il codice 2FA",
        authCodeLabel: "Inserisci codice a 6 cifre:",
        unlockBtn: "Sblocca",
        authInfo: "üí° Entrambi gli utenti usano lo stesso codice da Microsoft Authenticator",
        appTitle: "üè† Chillinguito Lake Como",
        appSubtitle: "Tracker Spese e Gestore Ospiti",
        langEnBtn: "üá¨üáß EN",
        langItBtn: "üáÆüáπ IT",
        logoutBtn: "üîí Esci",
        tabAddExpense: "Aggiungi Spesa",
        tabExpensesList: "Tutte le Spese",
        tabSettlement: "Saldo",
        tabGuests: "üë• Ospiti",
        tabCalendar: "Calendario",
        tabExport: "Esporta",
        addExpenseTitle: "Aggiungi Nuova Spesa",
        descLabel: "Descrizione",
        amountLabel: "Importo (EUR)",
        categoryLabel: "Categoria",
        paidByLabel: "Pagato Da",
        splitLabel: "Dividi Tra",
        dateLabel: "Data",
        notesLabel: "Note (opzionale)",
        cameraBtn: "üì∑ Scatta Foto Ricevuta",
        addExpenseBtn: "Aggiungi Spesa",
        catCleaning: "Pulizia e Manutenzione",
        catUtilities: "Utenze (Acqua, Gas, Elettricit√†)",
        catGroceries: "Alimentari e Cibo",
        catRepairs: "Riparazioni e Attrezzature",
        catOther: "Altro",
        splitBoth: "Entrambi (50/50)",
        splitDavide: "Solo Davide",
        splitMattia: "Solo Mattia",
        allExpensesTitle: "Tutte le Spese",
        clearAllBtn: "Cancella Tutto",
        settlementTitle: "Stato Saldo Attuale",
        totalLabel: "Spese Totali",
        davidePaidLabel: "Davide ha Pagato",
        mattiaPaidLabel: "Mattia ha Pagato",
        whoOwesLabel: "üí∏ Chi Deve a Chi",
        recordPaymentLabel: "üí∞ Registra Pagamento Parziale",
        recordPaymentBtn: "Registra",
        davidePayOpt: "Davide paga",
        mattiaPayOpt: "Mattia paga",
        guestsTitle: "üë• Gestione Ospiti",
        addGuestBtn: "‚ûï Aggiungi Ospite",
        checkIn: "Data Check-in",
        checkOut: "Data Check-out",
        guestNotes: "Note Speciali & Esigenze",
        addDocuments: "üìÅ Aggiungi Documenti",
        saveGuest: "Salva Ospite",
        editGuest: "Modifica Ospite",
        deleteGuest: "Elimina Ospite",
        guestAdded: "‚úÖ Ospite aggiunto con successo",
        guestDeleted: "üóëÔ∏è Ospite eliminato",
        documentAdded: "‚úÖ Documento aggiunto",
        upcoming: "Imminente",
        current: "Attuale",
        completed: "Completato",
        noGuests: "Nessun ospite trovato",
        clearHistoryConfirm: "‚ö†Ô∏è Eliminare TUTTE le spese e i pagamenti? Non √® possibile annullare!",
        historyCleared: "üóëÔ∏è Tutto lo storico cancellato",
        guestPhotos: "Foto Ospiti",
        addPhotos: "üì∏ Aggiungi Foto",
        touristTaxSection: "Imposta Turistica (Decreto Como)",
        touristTaxAmount: "Importo imposta turistica",
        touristTaxPaid: "Pagata",
        calendarTitle: "Calendario Airbnb",
        prevBtn: "Precedente",
        nextBtn: "Successivo",
        exportTitle: "Riepilogo Mensile & Esporta",
        expensePeriodLabel: "Periodo Spese",
        cleaningPeriodLabel: "Periodo Date Pulizia",
        downloadReportBtn: "üìä Scarica Report",
        addedNotif: "‚úÖ Spesa aggiunta",
        deletedNotif: "üóëÔ∏è Spesa eliminata",
        allSettledMsg: "‚úÖ Tutto pagato!",
        owesMsg: "{person} deve a {other}: EUR {amount}",
        noExpenses: "Nessuna spesa trovata"
    }
};

        // ============ HELPER FUNCTIONS ============
        function computeTouristTax(guest) {
            const persons = 1 + (guest.accompanied || 0);
            const checkIn = new Date(guest.checkIn);
            const checkOut = new Date(guest.checkOut);
            const msPerDay = 24 * 60 * 60 * 1000;
            let nights = Math.ceil((checkOut - checkIn) / msPerDay);
            if (isNaN(nights) || nights < 0) nights = 0;
            nights = Math.min(nights, 4);
            const tax = persons * nights * 3;
            return { tax, nights, persons };
        }

        function updateTouristTaxPreview() {
            const guestTemp = {
                accompanied: parseInt(document.getElementById('guestAccompanied').value) || 0,
                checkIn: document.getElementById('guestCheckIn').value,
                checkOut: document.getElementById('guestCheckOut').value
            };
            const { tax } = computeTouristTax(guestTemp);
            const el = document.getElementById('touristTaxAmount');
            if (el) el.value = `EUR ${tax.toFixed(2)}`;
        }

        // ============ TRANSLATIONS UPDATE ============
        function updateTranslations() {
            const t = translations[currentLanguage];
            
            // Auth screen elements
            const authTitle = document.getElementById('authTitle');
            const authSubtitle = document.getElementById('authSubtitle');
            const authCodeLabel = document.getElementById('authCodeLabel');
            const authInfo = document.getElementById('authInfo');
            const unlockBtn = document.querySelector('.unlock-btn');
            
            if (authTitle) authTitle.textContent = t.authTitle;
            if (authSubtitle) authSubtitle.textContent = t.authSubtitle;
            if (authCodeLabel) authCodeLabel.textContent = t.authCodeLabel;
            if (authInfo) authInfo.textContent = t.authInfo;
            if (unlockBtn) unlockBtn.textContent = t.unlockBtn;
            
            // Main app header
            const appTitle = document.getElementById('appTitle');
            const appSubtitle = document.getElementById('appSubtitle');
            const logoutBtn = document.getElementById('logoutBtn');
            
            if (appTitle) appTitle.textContent = t.appTitle;
            if (appSubtitle) appSubtitle.textContent = t.appSubtitle;
            if (logoutBtn) logoutBtn.textContent = t.logoutBtn;
            
            // Tabs
            const tabAddExpense = document.getElementById('tabAddExpense');
            const tabExpensesList = document.getElementById('tabExpensesList');
            const tabSettlement = document.getElementById('tabSettlement');
            const tabGuests = document.getElementById('tabGuests');
            const tabCalendar = document.getElementById('tabCalendar');
            const tabExport = document.getElementById('tabExport');
            
            if (tabAddExpense) tabAddExpense.textContent = t.tabAddExpense;
            if (tabExpensesList) tabExpensesList.textContent = t.tabExpensesList;
            if (tabSettlement) tabSettlement.textContent = t.tabSettlement;
            if (tabGuests) tabGuests.textContent = t.tabGuests;
            if (tabCalendar) tabCalendar.textContent = t.tabCalendar;
            if (tabExport) tabExport.textContent = t.tabExport;
        }
        

        function showNotification(msg) {
            const container = document.getElementById('notificationContainer');
            const div = document.createElement('div');
            div.className = 'notification-banner';
            if (msg.includes('‚ö†Ô∏è')) div.classList.add('warning');
            if (msg.includes('‚ùå')) div.classList.add('error');
            div.textContent = msg;
            container.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        function showSync() {
            const badge = document.getElementById('syncStatusIndicator');
            const dot = document.getElementById('syncDot');
            badge.style.display = 'flex';
            dot.classList.add('syncing');
        }

        function hideSync() {
            const badge = document.getElementById('syncStatusIndicator');
            const dot = document.getElementById('syncDot');
            dot.classList.remove('syncing');
            setTimeout(() => {
                badge.style.display = 'none';
            }, 1500);
        }

        // ============ FIREBASE DATA FUNCTIONS ============
        function getExpenses() {
            const data = localStorage.getItem('expenses_shared');
            return data ? JSON.parse(data) : [];
        }

        async function saveExpenses(expenses) {
            localStorage.setItem('expenses_shared', JSON.stringify(expenses));
            if (isFirebaseReady) {
                showSync();
                try {
                    await db.ref('shared/expenses').set(expenses);
                    console.log('‚úÖ Expenses synced to Firebase');
                    hideSync();
                } catch (error) {
                    console.error('‚ùå Firebase error:', error);
                }
            }
            displayExpenses();
            displaySettlement();
        }

        function getPayments() {
            const data = localStorage.getItem('payments_shared');
            return data ? JSON.parse(data) : [];
        }

        async function savePayments(payments) {
            localStorage.setItem('payments_shared', JSON.stringify(payments));
            if (isFirebaseReady) {
                showSync();
                try {
                    await db.ref('shared/payments').set(payments);
                    console.log('‚úÖ Payments synced to Firebase');
                    hideSync();
                } catch (error) {
                    console.error('‚ùå Firebase error:', error);
                }
            }
        }

        function getGuests() {
            const data = localStorage.getItem('guests_shared');
            return data ? JSON.parse(data) : [];
        }

        async function saveGuests(guests) {
            localStorage.setItem('guests_shared', JSON.stringify(guests));
            if (isFirebaseReady) {
                showSync();
                try {
                    await db.ref('shared/guests').set(guests);
                    console.log('‚úÖ Guests synced to Firebase');
                    hideSync();
                } catch (error) {
                    console.error('‚ùå Firebase error:', error);
                }
            }
            displayGuests();
        }

        function getCalendarData() {
            const data = localStorage.getItem('calendar_shared');
            return data ? JSON.parse(data) : {};
        }

        async function saveCalendarData(calendar) {
            localStorage.setItem('calendar_shared', JSON.stringify(calendar));
            if (isFirebaseReady) {
                showSync();
                try {
                    await db.ref('shared/calendar').set(calendar);
                    console.log('‚úÖ Calendar synced to Firebase');
                    hideSync();
                } catch (error) {
                    console.error('‚ùå Firebase error:', error);
                }
            }
            renderCalendar();
        }

        // ============ SETTLEMENT FUNCTIONS (v7 FIXED) ============
        function displaySettlement() {
            const expenses = getExpenses();
            const payments = getPayments();
            const balances = { Davide: 0, Mattia: 0 };
            let total = 0;

            // 1) Base balances from expenses
            expenses.forEach(exp => {
                const amount = exp.amount;
                total += amount;

                if (exp.paidBy === 'Davide') balances.Davide += amount;
                else if (exp.paidBy === 'Mattia') balances.Mattia += amount;

                if (exp.splitBetween === 'Both') {
                    balances.Davide -= amount / 2;
                    balances.Mattia -= amount / 2;
                } else if (exp.splitBetween === 'Davide') {
                    balances.Davide -= amount;
                } else if (exp.splitBetween === 'Mattia') {
                    balances.Mattia -= amount;
                }
            });

            // 2) APPLY PAYMENTS (FIXED)
            payments.forEach(p => {
                if (p.from === 'davide') {
                    balances.Davide += p.amount;
                    balances.Mattia -= p.amount;
                } else if (p.from === 'mattia') {
                    balances.Mattia += p.amount;
                    balances.Davide -= p.amount;
                }
            });

            document.getElementById('totalExpenses').textContent = `EUR ${total.toFixed(2)}`;

            let davidePaid = 0, mattiaPaid = 0;
            expenses.forEach(exp => {
                if (exp.paidBy === 'Davide') davidePaid += exp.amount;
                if (exp.paidBy === 'Mattia') mattiaPaid += exp.amount;
            });
            document.getElementById('davidePaid').textContent = `EUR ${davidePaid.toFixed(2)}`;
            document.getElementById('mattiaPaid').textContent = `EUR ${mattiaPaid.toFixed(2)}`;

            const banner = document.getElementById('settlementBanner');
            const detailsDiv = document.getElementById('settlementDetails');
            const progressContainer = document.getElementById('progressContainer');
            const t = translations[currentLanguage];

            if (total === 0) {
                banner.style.display = 'none';
                progressContainer.style.display = 'none';
                detailsDiv.innerHTML = '<div class="no-data">' + (currentLanguage === 'en' ? 'No expenses yet' : 'Nessuna spesa ancora') + '</div>';
                return;
            }

            banner.style.display = 'block';

            if (Math.abs(balances.Davide) < 0.01 && Math.abs(balances.Mattia) < 0.01) {
                banner.className = 'settlement-banner paid';
                banner.textContent = t.allSettledMsg;
                detailsDiv.innerHTML = '<div class="settlement-box" style="background:rgba(76,175,80,0.1);color:#2e7d32;border:none;">' + t.allSettledMsg + '</div>';
                progressContainer.style.display = 'none';
                document.getElementById('paymentFrom').innerHTML =
                    `<option value="davide">${t.davidePayOpt}</option><option value="mattia">${t.mattiaPayOpt}</option>`;
                return;
            }

            let debtor = null;
            let amountOwed = 0;

            if (balances.Davide < -0.01) {
                debtor = 'davide';
                amountOwed = Math.abs(balances.Davide);
                banner.className = 'settlement-banner owed';
                banner.textContent = `Davide ${currentLanguage === 'en' ? 'still owes' : 'deve ancora'} Mattia: EUR ${amountOwed.toFixed(2)}`;
                detailsDiv.innerHTML = `<div class="settlement-box owed">üí≥ Davide ${currentLanguage === 'en' ? 'still owes' : 'deve ancora'} Mattia: <strong>EUR ${amountOwed.toFixed(2)}</strong></div>`;
                document.getElementById('paymentFrom').innerHTML = `<option value="davide">${t.davidePayOpt}</option>`;
            } else if (balances.Mattia < -0.01) {
                debtor = 'mattia';
                amountOwed = Math.abs(balances.Mattia);
                banner.className = 'settlement-banner owed';
                banner.textContent = `Mattia ${currentLanguage === 'en' ? 'still owes' : 'deve ancora'} Davide: EUR ${amountOwed.toFixed(2)}`;
                detailsDiv.innerHTML = `<div class="settlement-box owed">üí≥ Mattia ${currentLanguage === 'en' ? 'still owes' : 'deve ancora'} Davide: <strong>EUR ${amountOwed.toFixed(2)}</strong></div>`;
                document.getElementById('paymentFrom').innerHTML = `<option value="mattia">${t.mattiaPayOpt}</option>`;
            }

            if (debtor) {
                progressContainer.style.display = 'block';
                updateProgressBar(amountOwed, debtor);
            } else {
                progressContainer.style.display = 'none';
            }
        }

        function updateProgressBar(amount, debtor) {
            const total = getExpenses().reduce((sum, e) => sum + e.amount, 0);
            const paid = getPayments().reduce((sum, p) => p.from === debtor ? sum + p.amount : sum, 0);
            const percent = Math.min((paid / amount) * 100, 100);
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressPercent').textContent = Math.round(percent) + '%';
        }

        function recordPayment() {
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const from = document.getElementById('paymentFrom').value;
            const t = translations[currentLanguage];

            if (!amount || amount <= 0) {
                showNotification('‚ùå Enter amount');
                return;
            }

            let payments = getPayments();
            payments.push({ from, amount, date: new Date().toISOString() });
            savePayments(payments);
            document.getElementById('paymentAmount').value = '';
            showNotification(t.paymentRecordedNotif);
            displaySettlement();
        }

        function addExpense(event) {
            event.preventDefault();
            const t = translations[currentLanguage];

            const expense = {
                id: Date.now(),
                description: document.getElementById('description').value,
                amount: parseFloat(document.getElementById('amount').value),
                category: document.getElementById('category').value,
                paidBy: document.getElementById('paidBy').value,
                splitBetween: document.getElementById('splitBetween').value,
                date: document.getElementById('date').value,
                notes: document.getElementById('notes').value,
                receipt: receiptBase64 || null,
                addedBy: currentUser
            };

            let expenses = getExpenses();
            expenses.push(expense);
            saveExpenses(expenses);

            document.getElementById('description').value = '';
            document.getElementById('amount').value = '';
            document.getElementById('category').value = '';
            document.getElementById('paidBy').value = '';
            document.getElementById('splitBetween').value = '';
            document.getElementById('date').value = '';
            document.getElementById('notes').value = '';
            document.getElementById('receiptPreview').innerHTML = '';
            receiptBase64 = null;

            showNotification(t.addedNotif);
        }

        function displayExpenses() {
            const expenses = getExpenses();
            const listDiv = document.getElementById('expensesList');

            if (expenses.length === 0) {
                listDiv.innerHTML = '<div class="no-data">' + translations[currentLanguage].noExpenses + '</div>';
                return;
            }

            expenses.sort((a, b) => new Date(b.date) - new Date(a.date));
            listDiv.innerHTML = expenses.map(exp => `
                <div class="expense-item">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div class="expense-info">
                            <div class="expense-description">${exp.description}</div>
                            <div class="expense-details">
                                <span class="category-badge">${exp.category}</span>
                                ${new Date(exp.date).toLocaleDateString()} ‚Ä¢ ${exp.paidBy} paid, split ${exp.splitBetween}<span class="user-badge-inline">${exp.addedBy}</span>
                            </div>
                        </div>
                        <div class="expense-amount">EUR ${exp.amount.toFixed(2)}</div>
                    </div>
                    ${exp.receipt ? `<div class="expense-receipt"><img src="${exp.receipt}" alt="Receipt"></div>` : ''}
                    <div style="margin-top: 12px;">
                        <button class="btn-danger" onclick="deleteExpense(${exp.id})" style="width: 100%; padding: 8px;">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function deleteExpense(id) {
            if (confirm('Delete this expense?')) {
                let expenses = getExpenses();
                expenses = expenses.filter(e => e.id !== id);
                saveExpenses(expenses);
                showNotification(translations[currentLanguage].deletedNotif);
            }
        }

        function clearAllExpenses() {
            if (confirm(translations[currentLanguage].clearHistoryConfirm)) {
                localStorage.removeItem('expenses_shared');
                localStorage.removeItem('payments_shared');
                displayExpenses();
                displaySettlement();
                showNotification(translations[currentLanguage].historyCleared);
            }
        }

        function filterExpenses() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const category = document.getElementById('filterCategory').value;
            const month = document.getElementById('filterMonth').value;
            const year = document.getElementById('filterYear').value;

            const expenses = getExpenses();
            filteredExpenses = expenses.filter(exp => {
                const matchesSearch = exp.description.toLowerCase().includes(searchText);
                const matchesCategory = !category || exp.category === category;
                const expDate = new Date(exp.date);
                const matchesMonth = !month || (expDate.getMonth() + 1).toString() === month;
                const matchesYear = !year || expDate.getFullYear().toString() === year;

                return matchesSearch && matchesCategory && matchesMonth && matchesYear;
            });

            document.getElementById('expensesList').innerHTML = filteredExpenses.length === 0
                ? '<div class="no-data">' + translations[currentLanguage].noExpenses + '</div>'
                : filteredExpenses.map(exp => `
                    <div class="expense-item">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div class="expense-info">
                                <div class="expense-description">${exp.description}</div>
                                <div class="expense-details">
                                    <span class="category-badge">${exp.category}</span>
                                    ${new Date(exp.date).toLocaleDateString()} ‚Ä¢ ${exp.paidBy} paid, split ${exp.splitBetween}
                                </div>
                            </div>
                            <div class="expense-amount">EUR ${exp.amount.toFixed(2)}</div>
                        </div>
                        ${exp.receipt ? `<div class="expense-receipt"><img src="${exp.receipt}" alt="Receipt"></div>` : ''}
                        <div style="margin-top: 12px;">
                            <button class="btn-danger" onclick="deleteExpense(${exp.id})" style="width: 100%; padding: 8px;">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `).join('');
        }

        function populateMonthYearFilters() {
            const expenses = getExpenses();
            const months = new Set();
            const years = new Set();

            expenses.forEach(exp => {
                const date = new Date(exp.date);
                months.add(date.getMonth() + 1);
                years.add(date.getFullYear());
            });

            const monthSelect = document.getElementById('filterMonth');
            const yearSelect = document.getElementById('filterYear');

            monthSelect.innerHTML = '<option value="">All Months</option>' +
                Array.from(months).sort().map(m => `<option value="${m}">${new Date(2000, m - 1).toLocaleString('en-US', {month: 'long'})}</option>`).join('');

            yearSelect.innerHTML = '<option value="">All Years</option>' +
                Array.from(years).sort().map(y => `<option value="${y}">${y}</option>`).join('');
        }

        // ============ CAMERA FUNCTIONS ============
        function openCamera() {
            document.getElementById('cameraInput').click();
        }

        function handleCameraCapture() {
            const file = document.getElementById('cameraInput').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    receiptBase64 = e.target.result;
                    document.getElementById('receiptPreview').innerHTML = `<img src="${receiptBase64}" style="max-width: 200px; border-radius: 6px;">`;
                };
                reader.readAsDataURL(file);
            }
        }

        // ============ CALENDAR AUTO-FILL (v10 NEW) ============
        function markGuestDatesOnCalendar(guest) {
            const calendar = getCalendarData();
            const checkIn = new Date(guest.checkIn);
            const checkOut = new Date(guest.checkOut);
           
            // Mark each night as occupied (from checkin to day before checkout)
            let currentDate = new Date(checkIn);
            while (currentDate < checkOut) {
               const dateStr = currentDate.toISOString().split('T')[0];
               calendar[dateStr] = 'occupied';
               currentDate.setDate(currentDate.getDate() + 1);
           }
           
            // Save and refresh calendar
            saveCalendarData(calendar);
        }

        // ============ CALENDAR CLEANUP (v11 NEW) ============
        function unmarkGuestDatesOnCalendar(guest) {
            const calendar = getCalendarData();
            const checkIn = new Date(guest.checkIn);
            const checkOut = new Date(guest.checkOut);
            
            // Remove occupancy for each night (from checkin to day before checkout)
            let currentDate = new Date(checkIn);
            while (currentDate < checkOut) {
                const dateStr = currentDate.toISOString().split('T')[0];
                // Delete the occupied status, making it available
                delete calendar[dateStr];
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // Save and refresh calendar
            saveCalendarData(calendar);
        }

        // ============ GUEST FUNCTIONS ============
        function openAddGuestModal() {
            currentEditingGuestId = null;
            guestPhotos = [];
            const t = translations[currentLanguage];
            const guest = {};
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.id = 'addGuestModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>${t.addGuestBtn}</h3>
                        <button class="modal-close" onclick="closeModal()">√ó</button>
                    </div>
                    <form onsubmit="saveGuest(event)">
                        <div class="form-group">
                            <label>${t.guestName}</label>
                            <input type="text" id="guestName" required placeholder="Full name">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>${t.guestEmail}</label>
                                <input type="email" id="guestEmail" placeholder="email@example.com">
                            </div>
                            <div class="form-group">
                                <label>${t.guestPhone}</label>
                                <input type="tel" id="guestPhone" placeholder="+39 xxx xxx xxxx">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>${t.checkIn}</label>
                                <input type="date" id="guestCheckIn" required onchange="updateTouristTaxPreview()">
                            </div>
                            <div class="form-group">
                                <label>${t.checkOut}</label>
                                <input type="date" id="guestCheckOut" required onchange="updateTouristTaxPreview()">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>${t.guestAccompanied}</label>
                            <input type="number" id="guestAccompanied" placeholder="0" min="0" max="10" value="0" onchange="updateAccompaniedGuestsForm(); updateTouristTaxPreview();">
                        </div>

                        <div id="accompaniedGuestsContainer"></div>

                        <div class="form-group">
                            <label>${t.guestPhotos}</label>
                            <button type="button" class="camera-btn" onclick="openGuestPhotoGallery()">üì∏ ${t.addPhotos}</button>
                            <input type="file" id="guestPhotoInput" accept="image/*" multiple onchange="handleGuestPhotos()">
                            <div id="guestPhotoPreview" class="image-gallery"></div>
                        </div>

                        <div class="tourist-tax-section">
                            <h4>${t.touristTaxSection}</h4>
                            <div class="tourist-tax-row">
                                <div>
                                    <label>${t.touristTaxAmount}</label>
                                    <input type="text" id="touristTaxAmount" disabled>
                                </div>
                                <div class="tourist-tax-paid">
                                    <input type="checkbox" id="touristTaxPaid">
                                    <label style="margin: 0;">${t.touristTaxPaid}</label>
                                </div>
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">${t.touristTaxCalculation}</div>
                        </div>

                        <div class="form-group">
                            <label>${t.guestNotes}</label>
                            <textarea id="guestNotes" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn-primary" style="width: 100%;">${t.saveGuest}</button>
                        </div>
                    </form>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = '';
            document.getElementById('modalContainer').appendChild(modal);
            modal.onclick = (e) => {
                if (e.target === modal) closeModal();
            };

            updateAccompaniedGuestsForm();
            displayGuestPhotos();
            updateTouristTaxPreview();
            document.getElementById('touristTaxPaid').checked = guest.touristTaxPaid || false;

            // Populate accompanied guests
            if (guest.accompaniedGuests && guest.accompaniedGuests.length > 0) {
                guest.accompaniedGuests.forEach((ag, idx) => {
                    const nameField = document.getElementById(`accompaniedGuestName${idx}`);
                    const surnameField = document.getElementById(`accompaniedGuestSurname${idx}`);
                    if (nameField) nameField.value = ag.name;
                    if (surnameField) surnameField.value = ag.surname;
                });
            }
        }

        function updateAccompaniedGuestsForm() {
            const count = parseInt(document.getElementById('guestAccompanied').value) || 0;
            const container = document.getElementById('accompaniedGuestsContainer');
            const t = translations[currentLanguage];
            
            container.innerHTML = '';
            if (count > 0) {
                container.innerHTML = `<div class="accompanied-guests-section">
                    <h4>${t.accompaniedGuestsInfo}</h4>`;
                for (let i = 0; i < count; i++) {
                    container.innerHTML += `
                        <div class="guest-info-row">
                            <input type="text" id="accompaniedGuestName${i}" placeholder="${t.accompaniedGuestName}" value="">
                            <input type="text" id="accompaniedGuestSurname${i}" placeholder="${t.accompaniedGuestSurname}" value="">
                        </div>
                    `;
                }
                container.innerHTML += '</div>';
            }
        }

        function openGuestPhotoGallery() {
            document.getElementById('guestPhotoInput').click();
        }

        function handleGuestPhotos() {
            const files = document.getElementById('guestPhotoInput').files;
            guestPhotos = [];
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    guestPhotos.push(e.target.result);
                    displayGuestPhotos();
                };
                reader.readAsDataURL(file);
            });
        }

        function displayGuestPhotos() {
            const preview = document.getElementById('guestPhotoPreview');
            preview.innerHTML = guestPhotos.map((photo, idx) => `
                <div class="gallery-item">
                    <img src="${photo}" alt="Guest photo">
                    <button class="gallery-item-remove" onclick="removeLocalPhoto(${idx})">√ó</button>
                </div>
            `).join('');
        }

        function removeLocalPhoto(idx) {
            guestPhotos.splice(idx, 1);
            displayGuestPhotos();
        }

        function saveGuest(event) {
            event.preventDefault();
            const t = translations[currentLanguage];
            
            const guest = {
                id: currentEditingGuestId || Date.now(),
                name: document.getElementById('guestName').value,
                email: document.getElementById('guestEmail').value,
                phone: document.getElementById('guestPhone').value,
                checkIn: document.getElementById('guestCheckIn').value,
                checkOut: document.getElementById('guestCheckOut').value,
                accompanied: parseInt(document.getElementById('guestAccompanied').value) || 0,
                photos: guestPhotos,
                notes: document.getElementById('guestNotes').value,
                touristTaxPaid: document.getElementById('touristTaxPaid').checked,
                documents: {},
                accompaniedGuests: []
            };

            const count = parseInt(document.getElementById('guestAccompanied').value) || 0;
            for (let i = 0; i < count; i++) {
                const name = document.getElementById(`accompaniedGuestName${i}`).value;
                const surname = document.getElementById(`accompaniedGuestSurname${i}`).value;
                if (name || surname) {
                    guest.accompaniedGuests.push({ name, surname });
                }
            }

            let guests = getGuests();
            if (currentEditingGuestId) {
                const idx = guests.findIndex(g => g.id === currentEditingGuestId);
                if (idx !== -1) guests[idx] = guest;
            } else {
                guests.push(guest);
                // Mark calendar dates for new guest
                markGuestDatesOnCalendar(guest);
            }

            saveGuests(guests);
            closeModal();
            showNotification(t.guestAdded);
        }

        function deleteGuest(guestId) {
            if (confirm('Delete this guest?')) {
                // Get the guest BEFORE deleting (so we know which dates to free up)
                const guests = getGuests();
                const guestToDelete = guests.find(g => g.id === guestId);
                
                // Remove from guests list
                const updatedGuests = guests.filter(g => g.id !== guestId);
                
                // Clear calendar dates for this guest
                if (guestToDelete && guestToDelete.checkIn && guestToDelete.checkOut) {
                    unmarkGuestDatesOnCalendar(guestToDelete);
                }
                
                // Save updated guests
                saveGuests(updatedGuests);
                
                // Show notification
                const t = translations[currentLanguage];
                showNotification(t.guestDeleted);
            }
        }

        function editGuest(guestId) {
            const guests = getGuests();
            const guest = guests.find(g => g.id === guestId);
            if (!guest) return;

            currentEditingGuestId = guestId;
            guestPhotos = guest.photos || [];
            const t = translations[currentLanguage];

            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.id = 'addGuestModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>${t.editGuest}</h3>
                        <button class="modal-close" onclick="closeModal()">√ó</button>
                    </div>
                    <form onsubmit="saveGuest(event)">
                        <div class="form-group">
                            <label>${t.guestName}</label>
                            <input type="text" id="guestName" required placeholder="Full name" value="${guest.name}">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>${t.guestEmail}</label>
                                <input type="email" id="guestEmail" placeholder="email@example.com" value="${guest.email || ''}">
                            </div>
                            <div class="form-group">
                                <label>${t.guestPhone}</label>
                                <input type="tel" id="guestPhone" placeholder="+39 xxx xxx xxxx" value="${guest.phone || ''}">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>${t.checkIn}</label>
                                <input type="date" id="guestCheckIn" required value="${guest.checkIn}" onchange="updateTouristTaxPreview()">
                            </div>
                            <div class="form-group">
                                <label>${t.checkOut}</label>
                                <input type="date" id="guestCheckOut" required value="${guest.checkOut}" onchange="updateTouristTaxPreview()">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>${t.guestAccompanied}</label>
                            <input type="number" id="guestAccompanied" placeholder="0" min="0" max="10" value="${guest.accompanied || 0}" onchange="updateAccompaniedGuestsForm(); updateTouristTaxPreview();">
                        </div>

                        <div id="accompaniedGuestsContainer"></div>

                        <div class="form-group">
                            <label>${t.guestPhotos}</label>
                            <button type="button" class="camera-btn" onclick="openGuestPhotoGallery()">üì∏ ${t.addPhotos}</button>
                            <input type="file" id="guestPhotoInput" accept="image/*" multiple onchange="handleGuestPhotos()">
                            <div id="guestPhotoPreview" class="image-gallery"></div>
                        </div>

                        <div class="tourist-tax-section">
                            <h4>${t.touristTaxSection}</h4>
                            <div class="tourist-tax-row">
                                <div>
                                    <label>${t.touristTaxAmount}</label>
                                    <input type="text" id="touristTaxAmount" disabled>
                                </div>
                                <div class="tourist-tax-paid">
                                    <input type="checkbox" id="touristTaxPaid">
                                    <label style="margin: 0;">${t.touristTaxPaid}</label>
                                </div>
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">${t.touristTaxCalculation}</div>
                        </div>

                        <div class="form-group">
                            <label>${t.guestNotes}</label>
                            <textarea id="guestNotes" rows="3">${guest.notes || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn-primary" style="width: 100%;">${t.saveGuest}</button>
                        </div>
                    </form>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = '';
            document.getElementById('modalContainer').appendChild(modal);
            modal.onclick = (e) => {
                if (e.target === modal) closeModal();
            };

            updateAccompaniedGuestsForm();
            displayGuestPhotos();
            updateTouristTaxPreview();
            document.getElementById('touristTaxPaid').checked = guest.touristTaxPaid || false;

            // Populate accompanied guests
            if (guest.accompaniedGuests && guest.accompaniedGuests.length > 0) {
                guest.accompaniedGuests.forEach((ag, idx) => {
                    const nameField = document.getElementById(`accompaniedGuestName${idx}`);
                    const surnameField = document.getElementById(`accompaniedGuestSurname${idx}`);
                    if (nameField) nameField.value = ag.name;
                    if (surnameField) surnameField.value = ag.surname;
                });
            }
        }

        function filterGuests() {
            const searchText = document.getElementById('guestSearchInput').value.toLowerCase();
            const dateFilter = document.getElementById('guestDateFilter').value;
            const statusFilter = document.getElementById('guestStatusFilter').value;
            const today = new Date();

            const guests = getGuests();
            filteredGuests = guests.filter(guest => {
                const matchesSearch = guest.name.toLowerCase().includes(searchText);
                const checkIn = new Date(guest.checkIn);
                const checkOut = new Date(guest.checkOut);

                let matchesStatus = true;
                if (statusFilter) {
                    if (statusFilter === 'upcoming' && checkIn <= today) matchesStatus = false;
                    if (statusFilter === 'current' && (today < checkIn || today >= checkOut)) matchesStatus = false;
                    if (statusFilter === 'completed' && checkOut > today) matchesStatus = false;
                }

                const matchesDate = !dateFilter || (dateFilter >= guest.checkIn && dateFilter < guest.checkOut);

                return matchesSearch && matchesStatus && matchesDate;
            });

            displayFilteredGuests();
        }

        function displayGuests() {
            filteredGuests = getGuests();
            displayFilteredGuests();
        }

        function displayFilteredGuests() {
            const listDiv = document.getElementById('guestsList');
            const t = translations[currentLanguage];

            if (filteredGuests.length === 0) {
                listDiv.innerHTML = '<div class="no-data">' + t.noGuests + '</div>';
                return;
            }

            listDiv.innerHTML = filteredGuests.map(guest => {
                const checkIn = new Date(guest.checkIn);
                const checkOut = new Date(guest.checkOut);
                const today = new Date();

                let status = 'upcoming';
                if (today >= checkIn && today < checkOut) status = 'current';
                if (today >= checkOut) status = 'completed';

                const statusText = { upcoming: t.upcoming, current: t.current, completed: t.completed }[status];
                const accompaniedText = guest.accompanied > 0 ? `+ ${guest.accompanied} ${t.guestGuests}` : '';

                let accompaniedInfo = '';
                if (guest.accompaniedGuests && guest.accompaniedGuests.length > 0) {
                    accompaniedInfo = '<div style="margin-top: 8px; font-size: 12px; color: var(--text-secondary);"><strong>Additional Guests:</strong><br>' +
                        guest.accompaniedGuests.map(ag => `${ag.name} ${ag.surname}`).join('<br>') +
                        '</div>';
                }

                const { tax } = computeTouristTax(guest);
                const taxPaidText = guest.touristTaxPaid ? '‚úì Yes' : '‚úó No';

                return `
                    <div class="guest-card">
                        <div class="guest-header">
                            <div class="guest-info" style="flex: 1;">
                                <h3>${guest.name} ${accompaniedText}</h3>
                                <div class="guest-dates">
                                    üìÖ ${checkIn.toLocaleDateString()} ‚Üí ${checkOut.toLocaleDateString()}
                                </div>
                                ${accompaniedInfo}
                                <span class="guest-status ${status}">${statusText}</span>
                            </div>
                        </div>
                        ${guest.photos && guest.photos.length > 0 ? `
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                                <strong style="font-size: 13px;">${t.guestPhotos}:</strong>
                                <div class="image-gallery">
                                    ${guest.photos.map((photo, idx) => `
                                        <div class="gallery-item">
                                            <img src="${photo}" alt="Guest photo">
                                            <button class="gallery-item-remove" onclick="removeGuestPhoto2(${guest.id}, ${idx})">√ó</button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); font-size: 13px;">
                            <strong>${t.touristTaxSection}:</strong><br>
                            EUR ${tax.toFixed(2)} ‚Ä¢ ${t.touristTaxPaid}: ${taxPaidText}
                        </div>
                        <div class="guest-documents">
                            <strong style="font-size: 13px;">üìÑ Documents:</strong>
                            <div style="margin-top: 8px;">
                                ${Object.entries(guest.documents || {}).length > 0 ? Object.entries(guest.documents).map(([docType, docs]) => `
                                    <div style="margin-bottom: 8px;">
                                        <div style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px;">${docType}</div>
                                        <div class="image-gallery">
                                            ${docs.map((doc, idx) => `
                                                <div class="gallery-item">
                                                    <img src="${doc}" alt="${docType}">
                                                    <button class="gallery-item-remove" onclick="removeGuestDocument(${guest.id}, '${docType}', ${idx})">√ó</button>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('') : '<div style="font-size: 12px; color: var(--text-secondary);">No documents</div>'}
                            </div>
                        </div>
                        <div class="guest-actions">
                            <button class="btn-primary" style="padding: 8px;" onclick="openAddDocumentModal(${guest.id})">üìÅ ${t.addDocuments}</button>
                            <button class="btn-secondary" style="padding: 8px;" onclick="editGuest(${guest.id})">‚úèÔ∏è ${t.editGuest}</button>
                            <button class="btn-danger" onclick="deleteGuest(${guest.id})">üóëÔ∏è ${t.deleteGuest}</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function removeGuestPhoto2(guestId, photoIdx) {
            let guests = getGuests();
            const guest = guests.find(g => g.id === guestId);
            if (guest && guest.photos) {
                guest.photos.splice(photoIdx, 1);
                saveGuests(guests);
            }
        }

        function openAddDocumentModal(guestId) {
            const t = translations[currentLanguage];
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>${t.addDocuments}</h3>
                        <button class="modal-close" onclick="closeModal()">√ó</button>
                    </div>
                    <div class="form-group">
                        <label>Document Type</label>
                        <select id="documentType">
                            <option value="ID/Passport">${t.idDocument}</option>
                            <option value="Tourist Tax Receipt">${t.touristTaxReceipt}</option>
                            <option value="Payment Receipt">${t.paymentReceipt}</option>
                            <option value="Check-in Photo">${t.checkInPhoto}</option>
                            <option value="Other Documents">${t.otherDoc}</option>
                        </select>
                    </div>
                    <button class="camera-btn" onclick="openDocumentCamera(${guestId})">üì∏ ${t.uploadDocument}</button>
                    <input type="file" id="documentInput" accept="image/*" onchange="handleDocumentUpload(${guestId})">
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = '';
            document.getElementById('modalContainer').appendChild(modal);
            modal.onclick = (e) => {
                if (e.target === modal) closeModal();
            };
        }

        function openDocumentCamera(guestId) {
            document.getElementById('documentInput').click();
        }

        function handleDocumentUpload(guestId) {
            const file = document.getElementById('documentInput').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const docType = document.getElementById('documentType').value;
                    let guests = getGuests();
                    const guest = guests.find(g => g.id === guestId);
                    if (guest) {
                        if (!guest.documents) guest.documents = {};
                        if (!guest.documents[docType]) guest.documents[docType] = [];
                        guest.documents[docType].push(e.target.result);
                        saveGuests(guests);
                        closeModal();
                        showNotification(translations[currentLanguage].documentAdded);
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        function removeGuestDocument(guestId, docType, docIdx) {
            let guests = getGuests();
            const guest = guests.find(g => g.id === guestId);
            if (guest && guest.documents && guest.documents[docType]) {
                guest.documents[docType].splice(docIdx, 1);
                if (guest.documents[docType].length === 0) delete guest.documents[docType];
                saveGuests(guests);
            }
        }

        function closeModal() {
            document.getElementById('modalContainer').innerHTML = '';
        }
// 1Ô∏è‚É£ FIRST - Define the calendar modal function
function openCalendarStatusModal(dateStr) {
    const calendar = getCalendarData();
    const currentData = calendar[dateStr] || {};
    const currentStatus = typeof currentData === 'string' ? currentData : currentData.status || 'available';
    const currentNotes = typeof currentData === 'object' ? currentData.notes || '' : '';
    
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Set Status for ${dateStr}</h3>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <form onsubmit="saveDayChanges('${dateStr}', event)">
                <div class="form-group">
                    <label>Status</label>
                    <select id="dayStatus">
                        <option value="available">üü¢ Free</option>
                        <option value="occupied">üî¥ Occupied</option>
                        <option value="cleaning">üü† Cleaning</option>
                        <option value="maintenance">üü£ Maintenance</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes (optional)</label>
                    <textarea id="dayNotes" placeholder="Add notes for this day..." rows="3"></textarea>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%;">Save Changes</button>
            </form>
        </div>
    `;
    
    document.getElementById('modalContainer').innerHTML = '';
    document.getElementById('modalContainer').appendChild(modal);
    
    // Set current values
    document.getElementById('dayStatus').value = currentStatus;
    document.getElementById('dayNotes').value = currentNotes;
    
    // Close on background click
    modal.onclick = (e) => {
        if (e.target === modal) closeModal();
    };
}

// 2Ô∏è‚É£ SECOND - Define the save function
function saveDayChanges(dateStr, event) {
    event.preventDefault();
    const status = document.getElementById('dayStatus').value;
    const notes = document.getElementById('dayNotes').value;
    
    const calendar = getCalendarData();
    
    if (status === 'available' && !notes) {
        delete calendar[dateStr];
    } else {
        calendar[dateStr] = {
            status: status,
            notes: notes,
            lastModified: new Date().toISOString()
        };
    }
    
    saveCalendarData(calendar);
    closeModal();
    showNotification('‚úÖ Day updated');
}

// ============ COMPLETE WORKING CALENDAR FUNCTION ============
function renderCalendar() {
    try {
        // Get calendar data
        const calendarData = getCalendarData();
        occupiedDates = [];
        cleaningDates = [];
        
        // Parse occupied/cleaning from calendarData
        Object.entries(calendarData).forEach(([dateStr, data]) => {
            const status = typeof data === 'string' ? data : data.status;
            if (status === 'occupied') occupiedDates.push(dateStr);
            else if (status === 'cleaning') cleaningDates.push(dateStr);
        });
        
        // Get current month/year
        const year = currentCalendarDate.getFullYear();
        const month = currentCalendarDate.getMonth();
        
        // Calculate calendar grid
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        // Update month display
        const monthName = new Date(year, month, 1).toLocaleString('en-US', { month: 'long', year: 'numeric' });
        const currentMonthEl = document.getElementById('currentMonth');
        if (currentMonthEl) currentMonthEl.textContent = monthName;
        
        // Clear calendar grid
        const calendarDays = document.getElementById('calendarDays');
        if (!calendarDays) {
            console.warn('‚ö†Ô∏è Calendar container not found');
            return;
        }
        calendarDays.innerHTML = '';
        
        // Add empty cells for days before month starts
        for (let i = 0; i < firstDay; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.className = 'calendar-day other-month';
            emptyDay.textContent = '';
            calendarDays.appendChild(emptyDay);
        }
        
        // Add day cells with proper coloring and status/notes
        for (let day = 1; day <= daysInMonth; day++) {
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            
            // Format date as YYYY-MM-DD
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            
            // Get day data
            const dayData = calendarData[dateStr];
            const status = typeof dayData === 'string' ? dayData : dayData?.status || 'available';
            const notes = typeof dayData === 'object' ? dayData.notes || '' : '';
            
            // Determine status and add class
            if (status === 'occupied') {
                dayElement.classList.add('occupied');
            } else if (status === 'cleaning') {
                dayElement.classList.add('cleaning');
            } else if (status === 'maintenance') {
                dayElement.classList.add('maintenance');
            } else {
                dayElement.classList.add('available');
            }
            
            // Create inner HTML with day number, status, and notes preview
            dayElement.innerHTML = `
                <div class="day-number">${day}</div>
                <div class="day-status">${status.charAt(0).toUpperCase() + status.slice(1)}</div>
                ${notes ? `<div class="day-notes" title="${notes}">üìù</div>` : ''}
            `;
            
            dayElement.style.cursor = 'pointer';
            dayElement.onclick = () => openCalendarStatusModal(dateStr);
            calendarDays.appendChild(dayElement);
        }
        
        // Add empty cells for days after month ends
        const totalCells = firstDay + daysInMonth;
        const remainingCells = 42 - totalCells;
        for (let i = 0; i < remainingCells; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.className = 'calendar-day other-month';
            emptyDay.textContent = '';
            calendarDays.appendChild(emptyDay);
        }
        
        console.log('‚úÖ Calendar rendered successfully');
    } catch (error) {
        console.error('‚ùå Calendar render error:', error);
    }
}

        function previousMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar();
        }
        function saveDayChanges(dateStr, event) {
    event.preventDefault();
    const status = document.getElementById('dayStatus').value;
    const notes = document.getElementById('dayNotes').value;
    
    const calendar = getCalendarData();
    
    // If no status and no notes, delete the entry
    if (status === 'available' && !notes) {
        delete calendar[dateStr];
    } else {
        // Store both status and notes
        calendar[dateStr] = {
            status: status,
            notes: notes,
            lastModified: new Date().toISOString()
        };
    }
    
    saveCalendarData(calendar);
    closeModal();
    showNotification('‚úÖ Day updated');
}

        // ============ AUTH & UI FUNCTIONS ============

        function validateTOTP() {
    const inputs = document.querySelectorAll('.code-box');
            const code = Array.from(inputs).map(i => i.value).join('');
            const errorEl = document.getElementById('errorMsg');
        
            if (!selectedUsername) {
                if (errorEl) errorEl.textContent = '‚ùå Select a user first';
                return;
            }
        
            if (code.length !== 6) {
                if (errorEl) errorEl.textContent = '‚ùå Enter all 6 digits';
                return;
            }
        
            const username = selectedUsername; // 'davide' or 'mattia'
            const ok = verifyTOTP(code, username);
        
            if (!ok) {
                if (errorEl) errorEl.textContent = '‚ùå Invalid code ‚Äì try again';
                return;
            }
        
            // SUCCESS: unlock app
            currentUser = username === 'davide' ? 'Davide' : 'Mattia';
        
            const authScreen = document.getElementById('authScreen');
            const mainApp = document.getElementById('mainApp');
            if (authScreen) authScreen.style.display = 'none';
            if (mainApp) mainApp.style.display = 'block';
            document.body.classList.remove('locked');
        
            // header user badge
            const userIconEl = document.getElementById('userIcon');
            const userNameEl = document.getElementById('userName');
            if (userIconEl) userIconEl.textContent = username === 'davide' ? 'üë®' : 'üë®‚Äçü¶±';
            if (userNameEl) userNameEl.textContent = currentUser;
        
            if (errorEl) errorEl.textContent = '';
            document.documentElement.classList.add('app-open');
            document.body.classList.add('app-open');
        }


        function selectUser(username, ev) {
    const e = ev || window.event;
    document.querySelectorAll('.user-choice').forEach(btn => btn.classList.remove('active'));  // ‚úÖ CORRECT
    if (e && e.currentTarget) {
        e.currentTarget.classList.add('active');  // ‚úÖ CORRECT
    }
            selectedUsername = username;
            const errorEl = document.getElementById('errorMsg');
            if (errorEl) errorEl.textContent = '';
        }
        
        function verifyTOTP(token, username) {
    const TOTP_SECRET_DAVIDE = 'JBSWY3DPEHPK3PXP';
    const TOTP_SECRET_MATTIA = 'JBSWY3DPEHPK3PXP';
    
    const secret = username === 'davide' ? TOTP_SECRET_DAVIDE : TOTP_SECRET_MATTIA;
    
    try {
        const secretBytes = base32Decode(secret);
        const now = Math.floor(Date.now() / 1000);
        
        // Check current time window and ¬±1 window (¬±30 seconds tolerance)
        for (let i = -1; i <= 1; i++) {
            const counter = Math.floor(now / 30) + i;
            const counterHex = ('0000000000000000' + counter.toString(16)).slice(-16);
            const counterBytes = hexToBytes(counterHex);
            
            // Use CryptoJS correctly
            const hmacObj = CryptoJS.HmacSHA1(
                CryptoJS.enc.Hex.parse(counterHex),
                CryptoJS.enc.Hex.parse(bytesToHex(secretBytes))
            );
            
            const hmacBytes = hexToBytes(hmacObj.toString());
            const offset = hmacBytes[hmacBytes.length - 1] & 0x0f;
            const value = (
                ((hmacBytes[offset] & 0x7f) << 24) |
                ((hmacBytes[offset + 1] & 0xff) << 16) |
                ((hmacBytes[offset + 2] & 0xff) << 8) |
                (hmacBytes[offset + 3] & 0xff)
            );
            
            const code = (value % 1000000).toString().padStart(6, '0');
            
            if (code === token) {
                console.log('‚úÖ TOTP code verified');
                return true;
            }
        }
        
        console.log('‚ùå TOTP code did not match any time window');
        return false;
    } catch (e) {
        console.error('‚ùå TOTP verification error:', e.message);
        return false;
    }
}

function bytesToHex(bytes) {
    let hex = '';
    for (let i = 0; i < bytes.length; i++) {
        hex += ('0' + bytes[i].toString(16)).slice(-2);
    }
    return hex;
}

        // ============ TOTP SETUP ============
function setupTOTPInput() {
    const inputs = document.querySelectorAll('.code-box');
    inputs.forEach((input, index) => {
        input.addEventListener('input', (e) => {
            if (e.target.value && index < inputs.length - 1) {
                inputs[index + 1].focus();
            }
        });
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace' && !e.target.value && index > 0) {
                inputs[index - 1].focus();
            }
            if (e.key === 'Enter') {
                validateTOTP();
            }
        });
    });
}

function validateTOTP() {
    const inputs = document.querySelectorAll('.code-box');
    const code = Array.from(inputs).map(i => i.value).join('');
    const errorEl = document.getElementById('errorMsg');

    if (!selectedUsername) {
        if (errorEl) errorEl.textContent = '‚ùå Select a user first';
        return;
    }

    if (code.length !== 6) {
        if (errorEl) errorEl.textContent = '‚ùå Enter all 6 digits';
        return;
    }

    const ok = verifyTOTP(code, selectedUsername);

    if (!ok) {
        if (errorEl) errorEl.textContent = '‚ùå Invalid code ‚Äì try again';
        // Clear inputs
        inputs.forEach(i => i.value = '');
        inputs[0].focus();
        return;
    }

// SUCCESS: unlock app - SHOW APP INSTANTLY
currentUser = selectedUsername === 'Davide' ? 'Davide' : 'Mattia';

const authScreen = document.getElementById('authScreen');
const mainApp = document.getElementById('mainApp');
if (authScreen) authScreen.style.display = 'none';
if (mainApp) {
  mainApp.style.display = 'block';
  mainApp.style.zIndex = '10';
}
document.body.classList.remove('locked');

// Update header user badge
const userIconEl = document.getElementById('userIcon');
const userNameEl = document.getElementById('userName');
if (userIconEl) userIconEl.textContent = selectedUsername === 'Davide' ? 'üë®' : 'üë®‚Äçü¶±';
if (userNameEl) userNameEl.textContent = currentUser;

if (errorEl) errorEl.textContent = '';

console.log('‚úÖ App loaded from localStorage');

// Load data from localStorage INSTANTLY
displayExpenses()
displaySettlement()
displayGuests()

// Start Firebase sync in BACKGROUND (don't wait)
console.log('üîÑ Starting Firebase sync...')
if (isFirebaseReady) {
  setTimeout(() => setupFirebaseListeners(), 100)
}

    
    // Load data
    displayExpenses();
    displaySettlement();
    displayGuests();
    setTimeout(() => setupFirebaseListeners(), 100)
}        
        function verifyTOTP(token, username) {
            const TOTP_SECRET_DAVIDE = 'JBSWY3DPEHPK3PXP';
            const TOTP_SECRET_MATTIA = 'JBSWY3DPEHPK3PXP';
            
            const secret = username === 'davide' ? TOTP_SECRET_DAVIDE : TOTP_SECRET_MATTIA;
            
            try {
                const secretBytes = base32Decode(secret);
                const now = Math.floor(Date.now() / 1000);
                
                // Check current time window and ¬±1 window (¬±30 seconds tolerance)
                for (let i = -1; i <= 1; i++) {
                    const counter = Math.floor(now / 30) + i;
                    const counterHex = ('0000000000000000' + counter.toString(16)).slice(-16);
                    const counterBytes = hexToBytes(counterHex);
                    
                    const hmac = CryptoJS.HmacSHA1(
                        CryptoJS.enc.Latin1.parse(String.fromCharCode(...counterBytes)),
                        CryptoJS.enc.Latin1.parse(base32DecodeToString(secret))
                    );
                    
                    const hmacBytes = hexToBytes(hmac.toString());
                    const offset = hmacBytes[hmacBytes.length - 1] & 0x0f;
                    const value = (
                        ((hmacBytes[offset] & 0x7f) << 24) |
                        ((hmacBytes[offset + 1] & 0xff) << 16) |
                        ((hmacBytes[offset + 2] & 0xff) << 8) |
                        (hmacBytes[offset + 3] & 0xff)
                    );
                    
                    const code = (value % 1000000).toString().padStart(6, '0');
                    
                    if (code === token) {
                        console.log('‚úÖ TOTP code verified');
                        return true;
                    }
                }
                
                return false;
            } catch (e) {
                console.error('‚ùå TOTP verification error:', e.message);
                return false;
            }
        }
        
        function base32Decode(str) {
            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
            let bits = 0;
            let value = 0;
            const result = [];
            
            for (let i = 0; i < str.length; i++) {
                const index = alphabet.indexOf(str[i].toUpperCase());
                if (index === -1) throw new Error('Invalid base32 character');
                
                value = (value << 5) | index;
                bits += 5;
                
                if (bits >= 8) {
                    bits -= 8;
                    result.push((value >> bits) & 0xff);
                }
            }
            
            return result;
        }
        
        function base32DecodeToString(str) {
            return String.fromCharCode(...base32Decode(str));
        }
        
        function hexToBytes(hex) {
            const bytes = [];
            for (let i = 0; i < hex.length; i += 2) {
                bytes.push(parseInt(hex.substr(i, 2), 16));
            }
            return bytes;
        }
        
        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.querySelectorAll('.totp-digit').forEach(input => input.value = '');
            document.getElementById('errorMsg').textContent = '';
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'guests') displayGuests();
            if (tabName === 'calendar') renderCalendar();
        }

        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('language', lang);
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            if (lang === 'en') document.getElementById('langEnBtn').classList.add('active');
            else document.getElementById('langItBtn').classList.add('active');
            updateTranslations();
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', currentTheme);
            localStorage.setItem('theme', currentTheme);
        }

        function setupFirebaseListeners() {
            if (!isFirebaseReady || listenersSetup) return;

            db.ref('shared/expenses').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    localStorage.setItem('expenses_shared', JSON.stringify(data));
                    displayExpenses();
                    displaySettlement();
                }
            });

            db.ref('shared/guests').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    localStorage.setItem('guests_shared', JSON.stringify(data));
                    displayGuests();
                }
            });

            db.ref('shared/calendar').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    localStorage.setItem('calendar_shared', JSON.stringify(data));
                    renderCalendar();
                }
            });

            listenersSetup = true;
        }

        function generateAndDownloadReport() {
            const period = document.getElementById('expensePeriod').value;
            const expenses = getExpenses();
            const cutoffDate = new Date();
            cutoffDate.setMonth(cutoffDate.getMonth() - parseInt(period));

            const filtered = expenses.filter(e => new Date(e.date) >= cutoffDate);
            let report = 'CHILLINGUITO LAKE COMO - EXPENSE REPORT\n\n';
            report += filtered.map(e => `${e.date}: ${e.description} - EUR ${e.amount.toFixed(2)} (${e.paidBy})`).join('\n');

            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'chillinguito-report.txt';
            a.click();
        }

        // ============ INIT ============
        document.addEventListener('DOMContentLoaded', function() {
            const theme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', theme);
            
            // Setup TOTP input
            setupTOTPInput();
            // Setup button event listeners
document.querySelectorAll('.user-choice').forEach(button => {
    button.addEventListener('click', function() {
        selectedUsername = this.dataset.user;
        
        // Update active state
        document.querySelectorAll('.user-choice').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        // Auto-focus first code input
        document.querySelector('.code-box').focus();
    });
});

// Setup unlock button
document.getElementById('unlockBtn').addEventListener('click', function() {
    const inputs = document.querySelectorAll('.code-box');
    const code = Array.from(inputs).map(i => i.value).join('');
    
    if (!selectedUsername) {
        document.getElementById('errorMsg').textContent = 'Select a user first';
        return;
    }
    
    if (code.length !== 6) {
        document.getElementById('errorMsg').textContent = 'Enter all 6 digits';
        return;
    }
    
    const username = selectedUsername === 'davide' ? 'Davide' : 'Mattia';
    const ok = verifyTOTP(code, username);
    
    if (!ok) {
        document.getElementById('errorMsg').textContent = 'Invalid code, try again';
        return;
    }
    
    // SUCCESS - unlock app
    currentUser = username;
    const authScreen = document.getElementById('authScreen');
    const mainApp = document.getElementById('mainApp');
    
    if (authScreen) authScreen.style.display = 'none';
    if (mainApp) mainApp.style.display = 'block';
    document.body.classList.remove('locked');
    
    // Update header user badge
    const userIconEl = document.getElementById('userIcon');
    const userNameEl = document.getElementById('userName');
    if (userIconEl) userIconEl.textContent = selectedUsername === 'davide' ? 'üë®' : 'üë®';
    if (userNameEl) userNameEl.textContent = currentUser;
    
    displayExpenses();
    displaySettlement();
    displayGuests();
    setTimeout(() => setupFirebaseListeners(), 100);
});

// Setup code input auto-advance
document.querySelectorAll('.code-box').forEach((input, index) => {
    input.addEventListener('input', function() {
        if (this.value.length === 1 && index < 5) {
            document.querySelectorAll('.code-box')[index + 1].focus();
        }
    });
    
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Backspace' && !this.value && index > 0) {
            document.querySelectorAll('.code-box')[index - 1].focus();
        }
    });
});
            // Auth screen shown by default
            const authScreen = document.getElementById('authScreen');
            const mainApp = document.getElementById('mainApp');
            
            authScreen.style.display = 'flex';  // Show auth
            mainApp.style.display = 'none';      // Hide main until authenticated
            document.body.classList.add('locked');
        }); 
// ‚úÖ Initialize calendar when page loads
document.addEventListener('DOMContentLoaded', () => {
  console.log('Initializing calendar...')
  renderCalendar()
})

// Also make sure these functions exist and work
function nextMonth() {
  currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1)
  renderCalendar()
}

function previousMonth() {
  currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1)
  renderCalendar()
}
  // Initialize TOTP input handling when page loads
document.addEventListener('DOMContentLoaded', () => {
    setupTOTPInput();
    console.log('‚úÖ TOTP input setup complete');
});
    </script>
</body>
</html>
