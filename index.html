<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chillinguito Lake Como - v7 FINAL</title>
    <script type="text/javascript" src="https://gc.kes.v2.scr.kaspersky-labs.com/7EA5E9BB-55E1-4C31-9C21-4943DDFED2E4/main.js?attr=SyZ-6RCmlILFtBs8u74iELEkHZ4IPvdXR9dvowxG--BJS8iAKTg102AZLHJGLvpr3DlaZauO2mYyHskXfWH7XWXjTb6kSBXQ9_QfoQuY7FG4xDv-IzuDIFxeAuBu9e7apiv-QUJO-BxwK7OQ5nHDMwPcJ-5Sp8u1d3LV2umWNK-72lZXiWN2ts0HHTbWgpyPBAx0c4cYnxpo013kDuePlkAzkKPeudkTBGAWunk8hy-1WrVSxa95lcrMPWOK0OiIgYo-dn4cBAVzivggL9OQVf3puD-jyctYdeiOEzTHYIkU6uYdEfB8_eWbbcxLspkYG1jZu-o1wBvG0ZHufajjOSI4t1cP4OkW7mxDkJZa2Kze0APFZ_glM5Oii93HtDHkLcRch54sIechFSWkAdBQsrqGt1RWUaOkR0WhAdnAcOC7Rlh7YrnDAT9HE8q86a1mlECKZjSBr-AZdFBYl6m1x716zJtGitOrzHZYbkD025Rwi5CC0ysHq55x5LJRay07BiTbrpYUiE_aqrWOk2WqB9auNGFcKeu1AdUHVcvN1P41gcEGfOw9B3s4U8hzEPvE_Ga6T3r9SyHpJafrgjlRRJpCBhkuFQQ7FU2VmGqmiKjDqMtQsMlg72SBEj5AsZC6ttMQD9cIGBnY67Y7L-3r1xOju6TX2SXyaFpI8SAk0YyX_MgMhx_TjkcFWpsbNJUb40xK_gsyj6N8zts1VuU_UNvF6E13CNml8MICQb9S1ZzcQVrTq7Wu9EyYAoPvtoTAmltgASTOyShKFpmhjX0w96YSrGdphZaiWuUEk8GL3v8PoZavASRkl-1yTqcwHYUypswbqvkz84u3OQPKAHOa3AY9guBzLUEPnxO6Tm_kUvcGaSr_IpDSP8lWHGxMjeZJyc1p5JdwU-vqAEUPcjMKSOTp-w1fUnxJUObWyBXbUuI-z4qoo3Ws_NGpE6le4Oc-3_Y-lLxivMywXjV2llFuxEARA0Ld5sylrVsxacYWaaOpylbCe7tnxke7RTw2Rd3lyO7fXiAvUxrAaSukQIdbcSMDXTl28GhOSileYTv5p-2Y8k2iL5rJPZE4OpNyDoXoZIlGivWtf911fqe--dEnGO2ru-PlOqdE7k9TDSuuc67evzz2V3tIqB814HJfDcE9dso2ho1f4ajSui2OJcsmUj6684F3WRAWTFKF1uG88LCARsGMX1ghJbgwtOzsED2l81emhvQ7YTATiufm40uafBDKEy2tB6yNb9Cg15iw7dtwEFwRAxsbhdqBfLgLBqoE4aef2oYIDB7wTo8S37xn6j0_WYkz_3QK4Pi93ezPxaJQP1JjdmWdl51u8LcD5V4UZRCGXTKJtO7_0nL4cwk27kwU9qcq293MYRzzLzp-Bk_Z2I68jE-9V1R3-lX26hFm3eXL_9oj_WtjPgAw-UjCLJm2fWn_ssCmjwNQLcjZ7NEFZH6oSBm-nLvmNK2twreqwboPjDILUuBzRdZXzCWDFDxGf-qKfcSprdwK5bP35EPrX4APIjCnrfqt2CvsvwYztG-akMwFPSE27P4vkOs7TbQ0oFgM6X8-xDbnmH2ZhsukGQgWSSxoCWym65NYSdIwlHVqWqoja8H4IY2P6H0hwvlgZ4lRMidD-viHVQj1856T-wEq_JPz6mOyuAyK-_jypK6ZRtdKBRq0N8kYTulczM3-y2GQkFYdFCohet6fBCy6h9AmG0kV36vYUzvJS30x1-wRdpGVwOfpYsAoXCKt1MJC_wgRcDCddFkCU3gkoj326d-_VayBOlHzFkmwyi0lR_JQBkA7fWRPJQLXJ_f4GRp6CLyvy47e2Nwqyvccqg3TVAn0OwGHSaTTjvNYnj5W8vPDZmPzSq9VTpzpdcUwtNQFwr1TYjDAoPQbqtmRttD-jpkBBCRNoLt8LBfGhe1Q55txuypFE5kMI-JbCYfG3acaALwO_HGegE2ZJh6dgmXFZoiDacNEsjVPqhXb9BzLu6lvt8KRE_5HvHaBu4QkFg16SuDho5Purki83T8sUVpizr4M1akEglWIqa1HOhzESwCKFaGPOXCI9Xdvo4HjP9YoFVoIiWR3REnkAZ8qjyNrH0Ouv7dzJYq8KwI9fdv6BBpAlYSyl4Gl-qhlJzfW-m_XwWJugsYiYi0MyXV_mCGJXfYnVrC0liOVVt-96aPchHPJxL6_XmJLzVj5q6pJaxN821rIhbhO9G06tJ70fW-QGofoss_yePZrH_-TmI14azJUA04UExUA_h9kHFH3K8cljegEPgLIqP1ESkV0672YSx2EPLsm5UjebJXoJEyoFdCS0NYdWEXsSWHvWt5pVw" charset="UTF-8"></script><script type="text/javascript" src="https://gc.kes.v2.scr.kaspersky-labs.com/7EA5E9BB-55E1-4C31-9C21-4943DDFED2E4/main.js" charset="UTF-8"></script>
    <style>
  :root {
    --primary: #2196F3;
    --primary-dark: #1976D2;
    --success: #4CAF50;
    --danger: #f44336;
    --warning: #ff9800;
    --bg: #050910;
    --bg-elevated: rgba(15, 23, 42, 0.9);
    --bg-card: rgba(15, 23, 42, 0.85);
    --border: rgba(148, 163, 184, 0.35);
    --text: #e5e7eb;
    --text-secondary: #9ca3af;
    --glass: rgba(15, 23, 42, 0.7);
    --blur-strength: 18px;
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: radial-gradient(circle at top left, #111827 0, #020617 45%, #000 100%);
    color: var(--text);
    line-height: 1.6;
    min-height: 100vh;
  }

  body.locked {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 20px;
  }

  .auth-screen {
    background: radial-gradient(circle at top left, rgba(37, 99, 235, 0.35), rgba(15, 23, 42, 0.98));
    border-radius: 24px;
    padding: 40px 36px;
    box-shadow: 0 18px 60px rgba(0, 0, 0, 0.75);
    text-align: center;
    max-width: 420px;
    width: 100%;
    backdrop-filter: blur(20px);
    border: 1px solid rgba(148, 163, 184, 0.5);
  }

  .auth-screen h1 {
    color: #f9fafb;
    margin-bottom: 10px;
    font-size: 30px;
    letter-spacing: 0.04em;
  }

  .auth-screen p {
    color: var(--text-secondary);
    margin-bottom: 30px;
    font-size: 15px;
  }

  .auth-screen .icon {
    font-size: 60px;
    margin-bottom: 20px;
    filter: drop-shadow(0 8px 18px rgba(37, 99, 235, 0.7));
  }

  .user-selector {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 24px;
  }

  .user-btn {
    padding: 16px;
    border-radius: 16px;
    background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.7), rgba(15, 23, 42, 0.96));
    border: 1px solid rgba(148, 163, 184, 0.5);
    cursor: pointer;
    font-weight: 600;
    font-size: 15px;
    transition: all 0.22s ease-out;
    min-height: 86px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 8px;
    color: var(--text);
  }

  .user-btn:hover {
    border-color: #60a5fa;
    box-shadow: 0 10px 30px rgba(37, 99, 235, 0.4);
    transform: translateY(-1px);
  }

  .user-btn.selected {
    border-color: #93c5fd;
    background: radial-gradient(circle at top left, rgba(59, 130, 246, 0.8), rgba(15, 23, 42, 0.95));
    color: #e5f2ff;
  }

  .user-icon {
    font-size: 24px;
  }

  .totp-input {
    display: flex;
    gap: 8px;
    justify-content: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .totp-digit {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    border: 1px solid rgba(148, 163, 184, 0.7);
    background: rgba(15, 23, 42, 0.9);
    text-align: center;
    font-size: 22px;
    font-weight: 600;
    color: #e5f2ff;
    box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.9);
  }

  .totp-digit:focus {
    outline: none;
    border-color: #60a5fa;
    box-shadow: 0 0 0 1px #1d4ed8, 0 0 32px rgba(37, 99, 235, 0.6);
  }

  .unlock-btn {
    width: 100%;
    padding: 12px;
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 45%, #7dd3fc 100%);
    color: #f9fafb;
    border: none;
    border-radius: 999px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 20px;
    min-height: 44px;
    box-shadow: 0 16px 40px rgba(37, 99, 235, 0.6);
    transition: all 0.18s ease-out;
  }

  .unlock-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 20px 60px rgba(37, 99, 235, 0.75);
  }

  .unlock-btn:disabled {
    opacity: 0.55;
    cursor: not-allowed;
    box-shadow: none;
  }

  .error-message {
    color: #fecaca;
    margin-top: 10px;
    font-size: 13px;
    min-height: 20px;
  }

  .auth-info {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(30, 64, 175, 0.6));
    padding: 16px;
    border-radius: 12px;
    margin-top: 20px;
    font-size: 13px;
    color: #d1d5db;
    border: 1px solid rgba(59, 130, 246, 0.4);
  }

  .container {
    max-width: 1180px;
    margin: 0 auto;
    padding: 0 16px 40px;
  }

  header {
    background: radial-gradient(circle at top left, #1d4ed8 0%, #020617 55%, #000 100%);
    color: white;
    padding: 18px 0 16px;
    margin-bottom: 18px;
    box-shadow: 0 16px 60px rgba(15, 23, 42, 0.9);
    border-bottom: 1px solid rgba(148, 163, 184, 0.35);
    position: sticky;
    top: 0;
    z-index: 40;
    backdrop-filter: blur(22px);
  }

  header h1 {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 4px;
    letter-spacing: 0.02em;
  }

  header p {
    font-size: 13px;
    opacity: 0.9;
  }

  .header-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 12px;
  }

  .header-status {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
  }

  .status-badge,
  .sync-status-indicator {
    background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.6));
    color: #e5e7eb;
    border: 1px solid rgba(148, 163, 184, 0.6);
    padding: 6px 12px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 6px;
    backdrop-filter: blur(14px);
  }

  .status-dot,
  .sync-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #22c55e;
    box-shadow: 0 0 12px rgba(34, 197, 94, 0.9);
  }

  .status-dot.offline {
    background: #9ca3af;
    box-shadow: none;
  }

  .sync-dot.syncing {
    background: #fbbf24;
    box-shadow: 0 0 16px rgba(251, 191, 36, 0.95);
    animation: pulse 1s infinite;
  }

  @keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.3); opacity: 0.6; }
  }

  .user-badge {
    background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.7));
    color: #e5e7eb;
    border: 1px solid rgba(148, 163, 184, 0.5);
    padding: 8px 12px;
    border-radius: 999px;
    font-weight: 500;
    font-size: 14px;
    min-height: 40px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .logout-btn,
  .lang-btn,
  .theme-btn {
    background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.85), rgba(15, 23, 42, 0.98));
    color: #e5e7eb;
    border: 1px solid rgba(148, 163, 184, 0.6);
    padding: 8px 12px;
    border-radius: 999px;
    cursor: pointer;
    font-weight: 500;
    font-size: 14px;
    transition: all 0.18s ease-out;
    min-height: 40px;
  }

  .lang-btn.active {
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
    color: #f9fafb;
    border-color: rgba(191, 219, 254, 0.9);
  }

  .logout-btn:hover,
  .lang-btn:hover,
  .theme-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 10px 26px rgba(15, 23, 42, 0.8);
  }

  .tabs {
    display: flex;
    gap: 12px;
    margin: 12px 0 18px;
    flex-wrap: nowrap;
    overflow-x: auto;
    padding-bottom: 2px;
  }

  .tab-btn {
    padding: 10px 16px;
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-secondary);
    border-radius: 999px;
    border: 1px solid transparent;
    transition: all 0.2s ease-out;
    white-space: nowrap;
    flex-shrink: 0;
    min-height: 40px;
    display: flex;
    align-items: center;
  }

  .tab-btn.active {
    color: #e5f2ff;
    border-color: rgba(96, 165, 250, 0.9);
    background: radial-gradient(circle at top left, rgba(37, 99, 235, 0.85), rgba(15, 23, 42, 0.95));
    box-shadow: 0 10px 30px rgba(37, 99, 235, 0.7);
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  .card,
  .settlement-summary,
  .calendar-container,
  .export-section {
    background: var(--glass);
    border-radius: 22px;
    padding: 22px 20px;
    margin-bottom: 18px;
    box-shadow: 0 22px 70px rgba(15, 23, 42, 0.9);
    border: 1px solid rgba(148, 163, 184, 0.45);
    backdrop-filter: blur(var(--blur-strength));
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(148, 163, 184, 0.55);
    flex-wrap: wrap;
    gap: 12px;
  }

  h2, h3, h4 {
    color: #e5e7eb;
  }

  input, select, textarea {
    width: 100%;
    padding: 11px 14px;
    border-radius: 12px;
    border: 1px solid rgba(148, 163, 184, 0.6);
    background: rgba(15, 23, 42, 0.9);
    font-size: 15px;
    color: #e5e7eb;
  }

  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: #60a5fa;
    box-shadow: 0 0 0 1px #1d4ed8, 0 0 26px rgba(37, 99, 235, 0.7);
  }

  .btn-primary {
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
    color: #f9fafb;
    border-radius: 999px;
    border: 1px solid rgba(191, 219, 254, 0.7);
    box-shadow: 0 14px 40px rgba(37, 99, 235, 0.8);
  }

  .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 18px 52px rgba(37, 99, 235, 0.95);
  }

  .btn-secondary {
    background: rgba(15, 23, 42, 0.95);
    color: var(--text);
    border-radius: 999px;
    border: 1px solid rgba(148, 163, 184, 0.65);
  }

  .btn-secondary:hover {
    transform: translateY(-1px);
    box-shadow: 0 12px 36px rgba(15, 23, 42, 0.9);
  }

  .btn-danger {
    background: linear-gradient(135deg, #dc2626, #b91c1c);
    color: #fee2e2;
    border-radius: 999px;
    border: 1px solid rgba(248, 113, 113, 0.9);
    box-shadow: 0 12px 34px rgba(248, 113, 113, 0.75);
  }

  .expense-item {
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding: 16px 14px;
    background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.85));
    border-radius: 16px;
    margin-bottom: 12px;
    border: 1px solid rgba(148, 163, 184, 0.5);
  }

  .expense-amount {
    font-weight: 700;
    color: #93c5fd;
    font-size: 18px;
  }

  .settlement-banner.paid {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.18), rgba(21, 128, 61, 0.8));
    color: #bbf7d0;
    border-left: 4px solid #22c55e;
  }

  .settlement-banner.owed {
    background: linear-gradient(135deg, rgba(248, 113, 113, 0.18), rgba(185, 28, 28, 0.8));
    color: #fecaca;
    border-left: 4px solid #f97373;
  }

  .progress-bar-container {
    width: 100%;
    background: rgba(15, 23, 42, 0.9);
    border-radius: 999px;
    height: 18px;
    margin-bottom: 12px;
    overflow: hidden;
    border: 1px solid rgba(148, 163, 184, 0.6);
  }

  .progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #22c55e, #4ade80, #bef264);
    transition: width 0.28s ease-out;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #022c22;
    font-size: 11px;
    font-weight: 700;
  }

  .guest-card {
    background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.88));
    border-radius: 18px;
    padding: 16px 14px;
    margin-bottom: 14px;
    border: 1px solid rgba(148, 163, 184, 0.55);
    box-shadow: 0 18px 55px rgba(15, 23, 42, 0.95);
  }

  .guest-status.upcoming {
    background: rgba(59, 130, 246, 0.18);
    color: #bfdbfe;
  }

  .guest-status.current {
    background: rgba(34, 197, 94, 0.18);
    color: #bbf7d0;
  }

  .guest-status.completed {
    background: rgba(148, 163, 184, 0.18);
    color: #e5e7eb;
  }

  .image-gallery img {
    border-radius: 10px;
    border: 1px solid rgba(148, 163, 184, 0.6);
  }

  .calendar-day.available {
    background: radial-gradient(circle at top, #22c55e, #15803d);
    border-color: rgba(187, 247, 208, 0.9);
    color: #ecfdf5;
  }

  .calendar-day.occupied {
    background: radial-gradient(circle at top, #f97373, #b91c1c);
    border-color: rgba(254, 202, 202, 0.9);
    color: #fef2f2;
  }

  .calendar-day.cleaning {
    background: radial-gradient(circle at top, #fb923c, #c2410c);
    border-color: rgba(254, 215, 170, 0.9);
    color: #fff7ed;
  }

  .notification-banner {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.9), rgba(22, 163, 74, 0.95));
    color: #dcfce7;
    padding: 12px 16px;
    border-radius: 999px;
    margin-bottom: 16px;
    border: 1px solid rgba(190, 242, 100, 0.9);
  }

  .notification-banner.warning { background: linear-gradient(135deg, #fbbf24, #d97706); }
  .notification-banner.error { background: linear-gradient(135deg, #f97373, #b91c1c); }

  @media (max-width: 600px) {
    .card,
    .settlement-summary,
    .calendar-container,
    .export-section { padding: 18px 14px; }
  }
</style>
</head>
<body id="appBody">
    <!-- AUTH SCREEN -->
    <div id="authScreen" class="auth-screen" style="display: none;">
        <div class="auth-screen">
            <div class="icon">üè†</div>
            <h1 id="authTitle">Chillinguito</h1>
            <p id="authSubtitle">Select your account & enter 2FA code</p>

            <div class="user-selector">
                <button class="user-btn" onclick="selectUser('davide')">
                    <span class="user-icon">üë®</span>
                    <span>Davide</span>
                </button>
                <button class="user-btn" onclick="selectUser('mattia')">
                    <span class="user-icon">üë®‚Äçü¶±</span>
                    <span>Mattia</span>
                </button>
            </div>

            <label id="authCodeLabel" style="display: block; margin-bottom: 12px; font-weight: 600;">Enter 6-digit code:</label>
            <div class="totp-input">
                <input type="text" class="totp-digit" maxlength="1" inputmode="numeric">
                <input type="text" class="totp-digit" maxlength="1" inputmode="numeric">
                <input type="text" class="totp-digit" maxlength="1" inputmode="numeric">
                <input type="text" class="totp-digit" maxlength="1" inputmode="numeric">
                <input type="text" class="totp-digit" maxlength="1" inputmode="numeric">
                <input type="text" class="totp-digit" maxlength="1" inputmode="numeric">
            </div>

            <button class="unlock-btn" onclick="validateTOTP()" id="unlockBtn">Unlock</button>

            <div class="error-message" id="errorMessage"></div>

            <div class="auth-info" id="authInfo">
                üí° Both users use the same code from Microsoft Authenticator
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp" style="display: none;">
        <header>
            <div class="container">
                <div class="header-top">
                    <div>
                        <h1 id="appTitle">üè† Chillinguito Lake Como</h1>
                        <p id="appSubtitle">Expense Tracker & Guest Manager</p>
                    </div>
                    
                    <div class="header-status">
                        <div id="syncStatusIndicator" class="sync-status-indicator" style="display: none;">
                            <div class="sync-dot" id="syncDot"></div>
                            <span id="syncStatus">Syncing...</span>
                        </div>

                        <div id="dbStatusIndicator" class="status-badge" style="display: none;">
                            <span class="status-dot" id="dbStatusDot"></span>
                            <span id="dbStatus">DB Connected</span>
                        </div>

                        <div id="otherUserStatusIndicator" class="status-badge" style="display: none;">
                            <span class="status-dot" id="otherUserDot"></span>
                            <span id="otherUserStatus">Mattia online</span>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <div class="user-badge" id="userBadge">
                            <span id="userIcon">üë®</span>
                            <span id="userName">Davide</span>
                        </div>
                        <button class="lang-btn active" onclick="setLanguage('en')" id="langEnBtn">üá¨üáß EN</button>
                        <button class="lang-btn" onclick="setLanguage('it')" id="langItBtn">üáÆüáπ IT</button>
                        <button class="theme-btn" onclick="toggleTheme()">üåô</button>
                        <button class="logout-btn" onclick="logout()" id="logoutBtn">üîí Logout</button>
                    </div>
                </div>
            </div>
        </header>

        <div class="container">
            <div id="notificationContainer"></div>

            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('add-expense')" id="tabAddExpense">Add Expense</button>
                <button class="tab-btn" onclick="switchTab('expenses-list')" id="tabExpensesList">All Expenses</button>
                <button class="tab-btn" onclick="switchTab('settlement')" id="tabSettlement">Settlement</button>
                <button class="tab-btn" onclick="switchTab('guests')" id="tabGuests">üë• Guests</button>
                <button class="tab-btn" onclick="switchTab('calendar')" id="tabCalendar">Calendar</button>
                <button class="tab-btn" onclick="switchTab('export')" id="tabExport">Export</button>
            </div>

            <!-- ADD EXPENSE TAB -->
            <div id="add-expense" class="tab-content active">
                <div class="card">
                    <h2 id="addExpenseTitle" style="margin-bottom: 20px;">Add New Expense</h2>
                    <form onsubmit="addExpense(event)">
                        <div class="form-group">
                            <label for="description" id="descLabel">Description</label>
                            <input type="text" id="description" placeholder="e.g., Cleaning supplies, Groceries" required>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="amount" id="amountLabel">Amount (EUR)</label>
                                <input type="number" id="amount" placeholder="0.00" step="0.01" min="0" required>
                            </div>
                            <div class="form-group">
                                <label for="category" id="categoryLabel">Category</label>
                                <select id="category" required>
                                    <option value="">-- Select Category --</option>
                                    <option value="Cleaning" id="catCleaning">Cleaning & Maintenance</option>
                                    <option value="Utilities" id="catUtilities">Utilities (Water, Gas, Electric)</option>
                                    <option value="Groceries" id="catGroceries">Groceries & Food</option>
                                    <option value="Repairs" id="catRepairs">Repairs & Equipment</option>
                                    <option value="Other" id="catOther">Other</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="paidBy" id="paidByLabel">Paid By</label>
                                <select id="paidBy" required>
                                    <option value="">-- Select --</option>
                                    <option value="Davide">Davide</option>
                                    <option value="Mattia">Mattia</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="splitBetween" id="splitLabel">Split Between</label>
                                <select id="splitBetween" required>
                                    <option value="">-- Select --</option>
                                    <option value="Both" id="splitBoth">Both (50/50)</option>
                                    <option value="Davide" id="splitDavide">Davide Only</option>
                                    <option value="Mattia" id="splitMattia">Mattia Only</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="date" id="dateLabel">Date</label>
                            <input type="date" id="date" required style="width: 100%;">
                        </div>

                        <div class="form-group">
                            <label for="notes" id="notesLabel">Notes (optional)</label>
                            <textarea id="notes" placeholder="Add notes..." rows="3"></textarea>
                        </div>

                        <div class="form-group">
                            <button type="button" class="camera-btn" onclick="openCamera()" id="cameraBtn">üì∑ Take Receipt Photo</button>
                            <input type="file" id="cameraInput" accept="image/*" capture="environment" onchange="handleCameraCapture()">
                            <div id="receiptPreview" style="margin-top: 10px;"></div>
                        </div>

                        <button type="submit" class="btn-primary" id="addExpenseBtn" style="width: 100%; padding: 12px;">Add Expense</button>
                    </form>
                </div>
            </div>

            <!-- EXPENSES LIST TAB -->
            <div id="expenses-list" class="tab-content">
                <div class="filter-section">
                    <div class="filter-input">
                        <input type="text" id="searchInput" placeholder="Search by description..." onkeyup="filterExpenses()">
                    </div>
                    <div class="filter-input">
                        <select id="filterCategory" onchange="filterExpenses()">
                            <option value="">All Categories</option>
                            <option value="Cleaning">Cleaning</option>
                            <option value="Utilities">Utilities</option>
                            <option value="Groceries">Groceries</option>
                            <option value="Repairs">Repairs</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="filter-input">
                        <select id="filterMonth" onchange="filterExpenses()">
                            <option value="">All Months</option>
                        </select>
                    </div>
                    <div class="filter-input">
                        <select id="filterYear" onchange="filterExpenses()">
                            <option value="">All Years</option>
                        </select>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h2 id="allExpensesTitle">All Expenses</h2>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn-secondary" onclick="clearAllExpenses()" id="clearAllBtn" style="color: var(--danger);">Clear All</button>
                        </div>
                    </div>
                    <div id="expensesList"></div>
                </div>
            </div>

            <!-- SETTLEMENT TAB -->
            <div id="settlement" class="tab-content">
                <div class="settlement-summary">
                    <div class="settlement-banner" id="settlementBanner" style="display: none;"></div>
                    
                    <div class="summary-title" id="settlementTitle">Current Settlement Status</div>
                    
                    <div class="stats">
                        <div class="stat-box-large">
                            <div class="stat-label" id="totalLabel">Total Expenses</div>
                            <div class="stat-value" id="totalExpenses">EUR 0.00</div>
                        </div>
                    </div>

                    <div class="stats-secondary">
                        <div class="stat-box">
                            <div class="stat-label" id="davidePaidLabel">Davide Paid</div>
                            <div class="stat-value" id="davidePaid">EUR 0.00</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label" id="mattiaPaidLabel">Mattia Paid</div>
                            <div class="stat-value" id="mattiaPaid">EUR 0.00</div>
                        </div>
                    </div>

                    <div style="margin-top: 20px;">
                        <h3 id="whoOwesLabel" style="margin-bottom: 15px; color: var(--primary);">üí∏ Who Owes Whom</h3>
                        <div id="settlementDetails"></div>
                    </div>

                    <div class="settlement-payments">
                        <h4 id="recordPaymentLabel" style="margin-bottom: 15px; color: var(--primary);">üí∞ Record Partial Payment</h4>
                        
                        <div id="progressContainer" style="display: none;">
                            <div style="margin-bottom: 8px; display: flex; justify-content: space-between; font-size: 12px; color: var(--text-secondary);">
                                <span id="progressLabel">Payment Progress</span>
                                <span id="progressPercent">0%</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                            </div>
                        </div>

                        <div class="payment-input-group">
                            <input type="number" id="paymentAmount" placeholder="Amount (EUR)" step="0.01" min="0">
                            <select id="paymentFrom" style="flex: 1; min-width: 120px;">
                                <option value="davide" id="davidePayOpt">Davide pays</option>
                                <option value="mattia" id="mattiaPayOpt">Mattia pays</option>
                            </select>
                            <button type="button" class="btn-primary" onclick="recordPayment()" id="recordPaymentBtn" style="flex-shrink: 0;">Record</button>
                        </div>
                        <div id="paymentHistory" class="payment-history"></div>
                    </div>
                </div>
            </div>

            <!-- GUESTS TAB -->
            <div id="guests" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2 id="guestsTitle">üë• Guests Management</h2>
                        <button class="btn-primary" onclick="openAddGuestModal()" id="addGuestBtn">‚ûï Add Guest</button>
                    </div>

                    <div class="filter-section">
                        <div class="filter-input">
                            <input type="text" id="guestSearchInput" placeholder="Search by guest name..." onkeyup="filterGuests()">
                        </div>
                        <div class="filter-input">
                            <input type="date" id="guestDateFilter" onchange="filterGuests()">
                        </div>
                        <div class="filter-input">
                            <select id="guestStatusFilter" onchange="filterGuests()">
                                <option value="">All Status</option>
                                <option value="upcoming">Upcoming</option>
                                <option value="current">Current</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                    </div>

                    <div id="guestsList"></div>
                </div>
            </div>

            <!-- CALENDAR TAB -->
            <div id="calendar" class="tab-content">
                <div class="calendar-container">
                    <div class="calendar-header">
                        <h2 id="calendarTitle">Airbnb Calendar</h2>
                        <div class="calendar-nav">
                            <button onclick="previousMonth()" id="prevBtn">Previous</button>
                            <span id="currentMonth" style="padding: 0 20px; font-weight: 600; min-width: 150px; text-align: center;"></span>
                            <button onclick="nextMonth()" id="nextBtn">Next</button>
                        </div>
                    </div>

                    <div class="calendar-weekdays">
                        <div class="weekday" id="weekdaySun">Sun</div>
                        <div class="weekday" id="weekdayMon">Mon</div>
                        <div class="weekday" id="weekdayTue">Tue</div>
                        <div class="weekday" id="weekdayWed">Wed</div>
                        <div class="weekday" id="weekdayThu">Thu</div>
                        <div class="weekday" id="weekdayFri">Fri</div>
                        <div class="weekday" id="weekdaySat">Sat</div>
                    </div>

                    <div id="calendarDays" class="calendar-days"></div>
                </div>
            </div>

            <!-- EXPORT TAB -->
            <div id="export" class="tab-content">
                <div class="export-section">
                    <h2 id="exportTitle" style="margin-bottom: 20px;">Monthly Summary & Export</h2>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 id="expensePeriodLabel" style="margin-bottom: 10px;">Expense Period</h4>
                        <select id="expensePeriod" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 15px;">
                            <option value="1">Current Month</option>
                            <option value="3">Last 3 Months</option>
                            <option value="6">Last 6 Months</option>
                            <option value="9">Last 9 Months</option>
                            <option value="12">Last 12 Months</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h4 id="cleaningPeriodLabel" style="margin-bottom: 10px;">Cleaning Dates Period</h4>
                        <select id="cleaningPeriod" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 15px;">
                            <option value="1">Current Month</option>
                            <option value="3">Next 3 Months</option>
                            <option value="6">Next 6 Months</option>
                            <option value="9">Next 9 Months</option>
                            <option value="12">Next 12 Months</option>
                        </select>
                    </div>

                    <button class="btn-primary" id="downloadReportBtn" style="width: 100%; margin-top: 20px; font-size: 18px;" onclick="generateAndDownloadReport()">üìä Download Report</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modalContainer"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // ============ STATE ============
        const TOTP_SECRET = 'JBSWY3DPEHPK3PXP';
        let currentUser = null;
        let listenersSetup = false;
        let currentTheme = localStorage.getItem('theme') || 'light';
        let currentLanguage = localStorage.getItem('language') || 'en';
        let currentCalendarDate = new Date();
        let filteredExpenses = [];
        let filteredGuests = [];
        let receiptBase64 = null;
        let dbConnected = false;
        let otherUserOnline = false;
        let currentEditingGuestId = null;
        let guestPhotos = [];

        const firebaseConfig = {
            apiKey: "AIzaSyCwF7bvS12h3AM14gmAEKV16BjH4Bq6TWU",
            authDomain: "airbnb-expense-tracker-7f531.firebaseapp.com",
            databaseURL: "https://airbnb-expense-tracker-7f531-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "airbnb-expense-tracker-7f531",
            storageBucket: "airbnb-expense-tracker-7f531.firebasestorage.app",
            messagingSenderId: "466998817774",
            appId: "1:466998817774:web:f4b244ac7cfa1723dbd4ff"
        };

        let firebaseApp = null;
        let db = null;
        let isFirebaseReady = false;

        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            isFirebaseReady = true;
            console.log('‚úÖ Firebase ready');
        } catch (e) {
            console.warn('Firebase init warning:', e.message);
        }

        // ============ TRANSLATIONS ============
        const translations = {
            en: {
                authTitle: "Chillinguito",
                authSubtitle: "Select your account & enter 2FA code",
                authCodeLabel: "Enter 6-digit code:",
                unlockBtn: "Unlock",
                authInfo: "üí° Both users use the same code from Microsoft Authenticator",
                appTitle: "üè† Chillinguito Lake Como",
                appSubtitle: "Expense Tracker & Guest Manager",
                langEnBtn: "üá¨üáß EN",
                langItBtn: "üáÆüáπ IT",
                logoutBtn: "üîí Logout",
                dbConnected: "‚úì DB Connected",
                dbDisconnected: "‚úó DB Offline",
                userOnline: "online",
                userOffline: "offline",
                tabAddExpense: "Add Expense",
                tabExpensesList: "All Expenses",
                tabSettlement: "Settlement",
                tabGuests: "üë• Guests",
                tabCalendar: "Calendar",
                tabExport: "Export",
                addExpenseTitle: "Add New Expense",
                descLabel: "Description",
                amountLabel: "Amount (EUR)",
                categoryLabel: "Category",
                paidByLabel: "Paid By",
                splitLabel: "Split Between",
                dateLabel: "Date",
                notesLabel: "Notes (optional)",
                cameraBtn: "üì∑ Take Receipt Photo",
                addExpenseBtn: "Add Expense",
                catCleaning: "Cleaning & Maintenance",
                catUtilities: "Utilities (Water, Gas, Electric)",
                catGroceries: "Groceries & Food",
                catRepairs: "Repairs & Equipment",
                catOther: "Other",
                splitBoth: "Both (50/50)",
                splitDavide: "Davide Only",
                splitMattia: "Mattia Only",
                allExpensesTitle: "All Expenses",
                clearAllBtn: "Clear All",
                filterBtn: "Filter",
                settlementTitle: "Current Settlement Status",
                totalLabel: "Total Expenses",
                davidePaidLabel: "Davide Paid",
                mattiaPaidLabel: "Mattia Paid",
                whoOwesLabel: "üí∏ Who Owes Whom",
                recordPaymentLabel: "üí∞ Record Partial Payment",
                recordPaymentBtn: "Record",
                calendarTitle: "Airbnb Calendar",
                prevBtn: "Previous",
                nextBtn: "Next",
                exportTitle: "Monthly Summary & Export",
                expensePeriodLabel: "Expense Period",
                cleaningPeriodLabel: "Cleaning Dates Period",
                downloadReportBtn: "üìä Download Report",
                addedNotif: "‚úÖ Expense added",
                deletedNotif: "üóëÔ∏è Expense deleted",
                clearedNotif: "üóëÔ∏è All cleared",
                calendarUpdatedNotif: "‚úÖ Calendar updated",
                calendarChangedNotif: "üìÖ Calendar changed by {user}",
                expenseAddedNotif: "üí∞ New expense added by {user}",
                expenseDeletedNotif: "üóëÔ∏è Expense deleted by {user}",
                paymentRecordedNotif: "‚úÖ Payment recorded",
                reportDownloadedNotif: "‚úÖ Report downloaded",
                allSettledMsg: "‚úÖ All settled!",
                stillOwesMsg: "{person} still owes {other}: EUR {amount}",
                owesMsg: "{person} owes {other}: EUR {amount}",
                mattiaPays: "Mattia pays",
                davidePays: "Davide pays",
                davidePayOpt: "Davide pays",
                mattiaPayOpt: "Mattia pays",
                searchPlaceholder: "Search by description...",
                occupied: "Occupied",
                available: "Available",
                cleaning: "Cleaning",
                overdueNotif: "‚ö†Ô∏è Payment overdue! {person} still owes EUR {amount}",
                noExpenses: "No expenses found",
                onlyDebtorCanPay: "‚ùå Only the person who owes can make a payment",
                guestsTitle: "üë• Guests Management",
                addGuestBtn: "‚ûï Add Guest",
                guestName: "Guest Name",
                guestEmail: "Email",
                guestPhone: "Phone",
                guestAccompanied: "Accompanied by",
                guestGuests: "guests",
                checkIn: "Check-in Date",
                checkOut: "Check-out Date",
                guestNotes: "Special Notes & Requirements",
                addDocuments: "üìÅ Add Documents",
                idDocument: "ID/Passport",
                touristTaxReceipt: "Tourist Tax Receipt",
                paymentReceipt: "Payment Receipt",
                checkInPhoto: "Check-in Photo",
                otherDoc: "Other Documents",
                uploadDocument: "Upload",
                deleteDocument: "Delete",
                viewDocument: "View",
                saveGuest: "Save Guest",
                editGuest: "Edit Guest",
                deleteGuest: "Delete Guest",
                guestAdded: "‚úÖ Guest added successfully",
                guestDeleted: "üóëÔ∏è Guest deleted",
                documentAdded: "‚úÖ Document added",
                documentDeleted: "üóëÔ∏è Document deleted",
                upcoming: "Upcoming",
                current: "Current",
                completed: "Completed",
                noGuests: "No guests found",
                deleteAllHistory: "üóëÔ∏è Clear All History",
                clearHistoryConfirm: "‚ö†Ô∏è Delete ALL expenses and payments? This cannot be undone!",
                historyCleared: "üóëÔ∏è All history cleared",
                accompaniedGuestsInfo: "Guest Information",
                accompaniedGuestName: "First Name",
                accompaniedGuestSurname: "Last Name",
                guestPhotos: "Guest Photos",
                addPhotos: "üì∏ Add Photos",
                mainBooker: "Main Booker",
                additionalGuests: "Additional Guests",
                touristTaxSection: "Tourist Tax (Como Decree)",
                touristTaxAmount: "Tourist tax amount",
                touristTaxPaid: "Paid",
                touristTaxCalculation: "3‚Ç¨ per person √ó nights (max 4)"
            },
            it: {
                authTitle: "Chillinguito",
                authSubtitle: "Seleziona il tuo account e inserisci il codice 2FA",
                authCodeLabel: "Inserisci codice a 6 cifre:",
                unlockBtn: "Sblocca",
                authInfo: "üí° Entrambi gli utenti usano lo stesso codice da Microsoft Authenticator",
                appTitle: "üè† Chillinguito Lake Como",
                appSubtitle: "Tracker Spese e Gestore Ospiti",
                langEnBtn: "üá¨üáß EN",
                langItBtn: "üáÆüáπ IT",
                logoutBtn: "üîí Esci",
                dbConnected: "‚úì DB Connesso",
                dbDisconnected: "‚úó DB Offline",
                userOnline: "online",
                userOffline: "offline",
                tabAddExpense: "Aggiungi Spesa",
                tabExpensesList: "Tutte le Spese",
                tabSettlement: "Saldo",
                tabGuests: "üë• Ospiti",
                tabCalendar: "Calendario",
                tabExport: "Esporta",
                addExpenseTitle: "Aggiungi Nuova Spesa",
                descLabel: "Descrizione",
                amountLabel: "Importo (EUR)",
                categoryLabel: "Categoria",
                paidByLabel: "Pagato Da",
                splitLabel: "Dividi Tra",
                dateLabel: "Data",
                notesLabel: "Note (opzionale)",
                cameraBtn: "üì∑ Scatta Foto Ricevuta",
                addExpenseBtn: "Aggiungi Spesa",
                catCleaning: "Pulizia e Manutenzione",
                catUtilities: "Utenze (Acqua, Gas, Elettricit√†)",
                catGroceries: "Alimentari e Cibo",
                catRepairs: "Riparazioni e Attrezzature",
                catOther: "Altro",
                splitBoth: "Entrambi (50/50)",
                splitDavide: "Solo Davide",
                splitMattia: "Solo Mattia",
                allExpensesTitle: "Tutte le Spese",
                clearAllBtn: "Cancella Tutto",
                filterBtn: "Filtra",
                settlementTitle: "Stato Saldo Attuale",
                totalLabel: "Spese Totali",
                davidePaidLabel: "Davide ha Pagato",
                mattiaPaidLabel: "Mattia ha Pagato",
                whoOwesLabel: "üí∏ Chi Deve a Chi",
                recordPaymentLabel: "üí∞ Registra Pagamento Parziale",
                recordPaymentBtn: "Registra",
                calendarTitle: "Calendario Airbnb",
                prevBtn: "Precedente",
                nextBtn: "Successivo",
                exportTitle: "Riepilogo Mensile & Esporta",
                expensePeriodLabel: "Periodo Spese",
                cleaningPeriodLabel: "Periodo Date Pulizia",
                downloadReportBtn: "üìä Scarica Report",
                addedNotif: "‚úÖ Spesa aggiunta",
                deletedNotif: "üóëÔ∏è Spesa eliminata",
                clearedNotif: "üóëÔ∏è Tutto cancellato",
                calendarUpdatedNotif: "‚úÖ Calendario aggiornato",
                calendarChangedNotif: "üìÖ Calendario modificato da {user}",
                expenseAddedNotif: "üí∞ Nuova spesa aggiunta da {user}",
                expenseDeletedNotif: "üóëÔ∏è Spesa eliminata da {user}",
                paymentRecordedNotif: "‚úÖ Pagamento registrato",
                reportDownloadedNotif: "‚úÖ Report scaricato",
                allSettledMsg: "‚úÖ Tutto pagato!",
                stillOwesMsg: "{person} deve ancora a {other}: EUR {amount}",
                owesMsg: "{person} deve a {other}: EUR {amount}",
                mattiaPays: "Mattia paga",
                davidePays: "Davide paga",
                davidePayOpt: "Davide paga",
                mattiaPayOpt: "Mattia paga",
                searchPlaceholder: "Cerca per descrizione...",
                occupied: "Occupato",
                available: "Disponibile",
                cleaning: "Pulizia",
                overdueNotif: "‚ö†Ô∏è Pagamento scaduto! {person} deve ancora EUR {amount}",
                noExpenses: "Nessuna spesa trovata",
                onlyDebtorCanPay: "‚ùå Solo chi deve pu√≤ fare un pagamento",
                guestsTitle: "üë• Gestione Ospiti",
                addGuestBtn: "‚ûï Aggiungi Ospite",
                guestName: "Nome Ospite",
                guestEmail: "Email",
                guestPhone: "Telefono",
                guestAccompanied: "Accompagnato da",
                guestGuests: "ospiti",
                checkIn: "Data Check-in",
                checkOut: "Data Check-out",
                guestNotes: "Note Speciali & Esigenze",
                addDocuments: "üìÅ Aggiungi Documenti",
                idDocument: "ID/Passaporto",
                touristTaxReceipt: "Ricevuta Imposta Turistica",
                paymentReceipt: "Ricevuta Pagamento",
                checkInPhoto: "Foto Check-in",
                otherDoc: "Altri Documenti",
                uploadDocument: "Carica",
                deleteDocument: "Elimina",
                viewDocument: "Visualizza",
                saveGuest: "Salva Ospite",
                editGuest: "Modifica Ospite",
                deleteGuest: "Elimina Ospite",
                guestAdded: "‚úÖ Ospite aggiunto con successo",
                guestDeleted: "üóëÔ∏è Ospite eliminato",
                documentAdded: "‚úÖ Documento aggiunto",
                documentDeleted: "üóëÔ∏è Documento eliminato",
                upcoming: "Imminente",
                current: "Attuale",
                completed: "Completato",
                noGuests: "Nessun ospite trovato",
                deleteAllHistory: "üóëÔ∏è Cancella Tutto lo Storico",
                clearHistoryConfirm: "‚ö†Ô∏è Eliminare TUTTE le spese e i pagamenti? Non √® possibile annullare!",
                historyCleared: "üóëÔ∏è Tutto lo storico cancellato",
                accompaniedGuestsInfo: "Informazioni Ospiti",
                accompaniedGuestName: "Nome",
                accompaniedGuestSurname: "Cognome",
                guestPhotos: "Foto Ospiti",
                addPhotos: "üì∏ Aggiungi Foto",
                mainBooker: "Ospite Principale",
                additionalGuests: "Ospiti Aggiuntivi",
                touristTaxSection: "Imposta Turistica (Decreto Como)",
                touristTaxAmount: "Importo imposta turistica",
                touristTaxPaid: "Pagata",
                touristTaxCalculation: "3‚Ç¨ per persona √ó notti (max 4)"
            }
        };

        // ============ HELPER FUNCTIONS ============
        function computeTouristTax(guest) {
            const persons = 1 + (guest.accompanied || 0);
            const checkIn = new Date(guest.checkIn);
            const checkOut = new Date(guest.checkOut);
            const msPerDay = 24 * 60 * 60 * 1000;
            let nights = Math.ceil((checkOut - checkIn) / msPerDay);
            if (isNaN(nights) || nights < 0) nights = 0;
            nights = Math.min(nights, 4);
            const tax = persons * nights * 3;
            return { tax, nights, persons };
        }

        function updateTouristTaxPreview() {
            const guestTemp = {
                accompanied: parseInt(document.getElementById('guestAccompanied').value) || 0,
                checkIn: document.getElementById('guestCheckIn').value,
                checkOut: document.getElementById('guestCheckOut').value
            };
            const { tax } = computeTouristTax(guestTemp);
            const el = document.getElementById('touristTaxAmount');
            if (el) el.value = `EUR ${tax.toFixed(2)}`;
        }

        // ============ TRANSLATIONS UPDATE ============
        function updateTranslations() {
            const t = translations[currentLanguage];
            document.getElementById('authTitle').textContent = t.authTitle;
            document.getElementById('authSubtitle').textContent = t.authSubtitle;
            document.getElementById('authCodeLabel').textContent = t.authCodeLabel;
            document.getElementById('unlockBtn').textContent = t.unlockBtn;
            document.getElementById('authInfo').textContent = t.authInfo;
            document.getElementById('appTitle').textContent = t.appTitle;
            document.getElementById('appSubtitle').textContent = t.appSubtitle;
            document.getElementById('langEnBtn').textContent = t.langEnBtn;
            document.getElementById('langItBtn').textContent = t.langItBtn;
            document.getElementById('logoutBtn').textContent = t.logoutBtn;
            document.getElementById('tabAddExpense').textContent = t.tabAddExpense;
            document.getElementById('tabExpensesList').textContent = t.tabExpensesList;
            document.getElementById('tabSettlement').textContent = t.tabSettlement;
            document.getElementById('tabGuests').textContent = t.tabGuests;
            document.getElementById('tabCalendar').textContent = t.tabCalendar;
            document.getElementById('tabExport').textContent = t.tabExport;
            document.getElementById('addExpenseTitle').textContent = t.addExpenseTitle;
            document.getElementById('descLabel').textContent = t.descLabel;
            document.getElementById('amountLabel').textContent = t.amountLabel;
            document.getElementById('categoryLabel').textContent = t.categoryLabel;
            document.getElementById('paidByLabel').textContent = t.paidByLabel;
            document.getElementById('splitLabel').textContent = t.splitLabel;
            document.getElementById('dateLabel').textContent = t.dateLabel;
            document.getElementById('notesLabel').textContent = t.notesLabel;
            document.getElementById('cameraBtn').textContent = t.cameraBtn;
            document.getElementById('addExpenseBtn').textContent = t.addExpenseBtn;
            document.getElementById('catCleaning').textContent = t.catCleaning;
            document.getElementById('catUtilities').textContent = t.catUtilities;
            document.getElementById('catGroceries').textContent = t.catGroceries;
            document.getElementById('catRepairs').textContent = t.catRepairs;
            document.getElementById('catOther').textContent = t.catOther;
            document.getElementById('splitBoth').textContent = t.splitBoth;
            document.getElementById('splitDavide').textContent = t.splitDavide;
            document.getElementById('splitMattia').textContent = t.splitMattia;
            document.getElementById('allExpensesTitle').textContent = t.allExpensesTitle;
            document.getElementById('clearAllBtn').textContent = t.clearAllBtn;
            document.getElementById('settlementTitle').textContent = t.settlementTitle;
            document.getElementById('totalLabel').textContent = t.totalLabel;
            document.getElementById('davidePaidLabel').textContent = t.davidePaidLabel;
            document.getElementById('mattiaPaidLabel').textContent = t.mattiaPaidLabel;
            document.getElementById('whoOwesLabel').textContent = t.whoOwesLabel;
            document.getElementById('recordPaymentLabel').textContent = t.recordPaymentLabel;
            document.getElementById('recordPaymentBtn').textContent = t.recordPaymentBtn;
            document.getElementById('davidePayOpt').textContent = t.davidePayOpt;
            document.getElementById('mattiaPayOpt').textContent = t.mattiaPayOpt;
            document.getElementById('guestsTitle').textContent = t.guestsTitle;
            document.getElementById('addGuestBtn').textContent = t.addGuestBtn;
            document.getElementById('calendarTitle').textContent = t.calendarTitle;
            document.getElementById('prevBtn').textContent = t.prevBtn;
            document.getElementById('nextBtn').textContent = t.nextBtn;
            document.getElementById('exportTitle').textContent = t.exportTitle;
            document.getElementById('expensePeriodLabel').textContent = t.expensePeriodLabel;
            document.getElementById('cleaningPeriodLabel').textContent = t.cleaningPeriodLabel;
            document.getElementById('downloadReportBtn').textContent = t.downloadReportBtn;
            populateMonthYearFilters();
            renderCalendar();
        }

        function showNotification(msg) {
            const container = document.getElementById('notificationContainer');
            const div = document.createElement('div');
            div.className = 'notification-banner';
            if (msg.includes('‚ö†Ô∏è')) div.classList.add('warning');
            if (msg.includes('‚ùå')) div.classList.add('error');
            div.textContent = msg;
            container.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        function showSync() {
            const badge = document.getElementById('syncStatusIndicator');
            const dot = document.getElementById('syncDot');
            badge.style.display = 'flex';
            dot.classList.add('syncing');
        }

        function hideSync() {
            const badge = document.getElementById('syncStatusIndicator');
            const dot = document.getElementById('syncDot');
            dot.classList.remove('syncing');
            setTimeout(() => {
                badge.style.display = 'none';
            }, 1500);
        }

        // ============ FIREBASE DATA FUNCTIONS ============
        function getExpenses() {
            const data = localStorage.getItem('expenses_shared');
            return data ? JSON.parse(data) : [];
        }

        async function saveExpenses(expenses) {
            localStorage.setItem('expenses_shared', JSON.stringify(expenses));
            if (isFirebaseReady) {
                showSync();
                try {
                    await db.ref('shared/expenses').set(expenses);
                    console.log('‚úÖ Expenses synced to Firebase');
                    hideSync();
                } catch (error) {
                    console.error('‚ùå Firebase error:', error);
                }
            }
            displayExpenses();
            displaySettlement();
        }

        function getPayments() {
            const data = localStorage.getItem('payments_shared');
            return data ? JSON.parse(data) : [];
        }

        async function savePayments(payments) {
            localStorage.setItem('payments_shared', JSON.stringify(payments));
            if (isFirebaseReady) {
                showSync();
                try {
                    await db.ref('shared/payments').set(payments);
                    console.log('‚úÖ Payments synced to Firebase');
                    hideSync();
                } catch (error) {
                    console.error('‚ùå Firebase error:', error);
                }
            }
        }

        function getGuests() {
            const data = localStorage.getItem('guests_shared');
            return data ? JSON.parse(data) : [];
        }

        async function saveGuests(guests) {
            localStorage.setItem('guests_shared', JSON.stringify(guests));
            if (isFirebaseReady) {
                showSync();
                try {
                    await db.ref('shared/guests').set(guests);
                    console.log('‚úÖ Guests synced to Firebase');
                    hideSync();
                } catch (error) {
                    console.error('‚ùå Firebase error:', error);
                }
            }
            displayGuests();
        }

        function getCalendarData() {
            const data = localStorage.getItem('calendar_shared');
            return data ? JSON.parse(data) : {};
        }

        async function saveCalendarData(calendar) {
            localStorage.setItem('calendar_shared', JSON.stringify(calendar));
            if (isFirebaseReady) {
                showSync();
                try {
                    await db.ref('shared/calendar').set(calendar);
                    console.log('‚úÖ Calendar synced to Firebase');
                    hideSync();
                } catch (error) {
                    console.error('‚ùå Firebase error:', error);
                }
            }
            renderCalendar();
        }

        // ============ SETTLEMENT FUNCTIONS (v7 FIXED) ============
        function displaySettlement() {
            const expenses = getExpenses();
            const payments = getPayments();
            const balances = { Davide: 0, Mattia: 0 };
            let total = 0;

            // 1) Base balances from expenses
            expenses.forEach(exp => {
                const amount = exp.amount;
                total += amount;

                if (exp.paidBy === 'Davide') balances.Davide += amount;
                else if (exp.paidBy === 'Mattia') balances.Mattia += amount;

                if (exp.splitBetween === 'Both') {
                    balances.Davide -= amount / 2;
                    balances.Mattia -= amount / 2;
                } else if (exp.splitBetween === 'Davide') {
                    balances.Davide -= amount;
                } else if (exp.splitBetween === 'Mattia') {
                    balances.Mattia -= amount;
                }
            });

            // 2) APPLY PAYMENTS (FIXED)
            // When Davide pays: his balance moves toward 0 (less negative)
            payments.forEach(p => {
                if (p.from === 'davide') {
                    balances.Davide += p.amount;
                    balances.Mattia -= p.amount;
                } else if (p.from === 'mattia') {
                    balances.Mattia += p.amount;
                    balances.Davide -= p.amount;
                }
            });

            document.getElementById('totalExpenses').textContent = `EUR ${total.toFixed(2)}`;

            let davidePaid = 0, mattiaPaid = 0;
            expenses.forEach(exp => {
                if (exp.paidBy === 'Davide') davidePaid += exp.amount;
                if (exp.paidBy === 'Mattia') mattiaPaid += exp.amount;
            });
            document.getElementById('davidePaid').textContent = `EUR ${davidePaid.toFixed(2)}`;
            document.getElementById('mattiaPaid').textContent = `EUR ${mattiaPaid.toFixed(2)}`;

            const banner = document.getElementById('settlementBanner');
            const detailsDiv = document.getElementById('settlementDetails');
            const progressContainer = document.getElementById('progressContainer');
            const t = translations[currentLanguage];

            if (total === 0) {
                banner.style.display = 'none';
                progressContainer.style.display = 'none';
                detailsDiv.innerHTML = '<div class="no-data">' + (currentLanguage === 'en' ? 'No expenses yet' : 'Nessuna spesa ancora') + '</div>';
                return;
            }

            banner.style.display = 'block';

            // If both close to 0 ‚Üí settled
            if (Math.abs(balances.Davide) < 0.01 && Math.abs(balances.Mattia) < 0.01) {
                banner.className = 'settlement-banner paid';
                banner.textContent = t.allSettledMsg;
                detailsDiv.innerHTML = '<div class="settlement-box" style="background:rgba(76,175,80,0.1);color:#2e7d32;border:none;">' + t.allSettledMsg + '</div>';
                progressContainer.style.display = 'none';
                document.getElementById('paymentFrom').innerHTML =
                    `<option value="davide">${t.davidePayOpt}</option><option value="mattia">${t.mattiaPayOpt}</option>`;
                return;
            }

            let debtor = null;
            let amountOwed = 0;

            if (balances.Davide < -0.01) {
                debtor = 'davide';
                amountOwed = Math.abs(balances.Davide);
                banner.className = 'settlement-banner owed';
                banner.textContent = `Davide ${currentLanguage === 'en' ? 'still owes' : 'deve ancora'} Mattia: EUR ${amountOwed.toFixed(2)}`;
                detailsDiv.innerHTML = `<div class="settlement-box owed">üí≥ Davide ${currentLanguage === 'en' ? 'still owes' : 'deve ancora'} Mattia: <strong>EUR ${amountOwed.toFixed(2)}</strong></div>`;
                document.getElementById('paymentFrom').innerHTML = `<option value="davide">${t.davidePayOpt}</option>`;
            } else if (balances.Mattia < -0.01) {
                debtor = 'mattia';
                amountOwed = Math.abs(balances.Mattia);
                banner.className = 'settlement-banner owed';
                banner.textContent = `Mattia ${currentLanguage === 'en' ? 'still owes' : 'deve ancora'} Davide: EUR ${amountOwed.toFixed(2)}`;
                detailsDiv.innerHTML = `<div class="settlement-box owed">üí≥ Mattia ${currentLanguage === 'en' ? 'still owes' : 'deve ancora'} Davide: <strong>EUR ${amountOwed.toFixed(2)}</strong></div>`;
                document.getElementById('paymentFrom').innerHTML = `<option value="mattia">${t.mattiaPayOpt}</option>`;
            }

            if (debtor) {
                progressContainer.style.display = 'block';
                updateProgressBar(amountOwed, debtor);
            } else {
                progressContainer.style.display = 'none';
            }

            // Overdue only last 3 days of month
            const today = new Date();
            const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            const daysLeft = lastDayOfMonth - today.getDate();
            if (daysLeft <= 3 && daysLeft >= 0 && amountOwed > 0.01) {
                const name = debtor === 'davide' ? 'Davide' : 'Mattia';
                showNotification(t.overdueNotif.replace('{person}', name).replace('{amount}', amountOwed.toFixed(2)));
            }
        }

        function updateProgressBar(currentDebt, debtor) {
            const payments = getPayments();
            let paidByDebtor = 0;
            payments.forEach(p => {
                if ((debtor === 'davide' && p.from === 'davide') ||
                    (debtor === 'mattia' && p.from === 'mattia')) {
                    paidByDebtor += p.amount;
                }
            });

            const totalObligation = paidByDebtor + currentDebt;
            const pct = totalObligation > 0 ? Math.min(100, Math.round((paidByDebtor / totalObligation) * 100)) : 0;

            document.getElementById('progressBar').style.width = pct + '%';
            document.getElementById('progressPercent').textContent = pct + '%';
        }

        function recordPayment() {
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const from = document.getElementById('paymentFrom').value;

            if (isNaN(amount) || amount <= 0) {
                showNotification('‚ùå ' + (currentLanguage === 'en' ? 'Enter a valid amount' : 'Inserisci un importo valido'));
                return;
            }

            // Recompute balances to know who is the real debtor
            const expenses = getExpenses();
            const payments = getPayments();
            const balances = { Davide: 0, Mattia: 0 };

            expenses.forEach(exp => {
                const v = exp.amount;
                if (exp.paidBy === 'Davide') balances.Davide += v;
                else if (exp.paidBy === 'Mattia') balances.Mattia += v;

                if (exp.splitBetween === 'Both') {
                    balances.Davide -= v / 2;
                    balances.Mattia -= v / 2;
                } else if (exp.splitBetween === 'Davide') {
                    balances.Davide -= v;
                } else if (exp.splitBetween === 'Mattia') {
                    balances.Mattia -= v;
                }
            });

            payments.forEach(p => {
                if (p.from === 'davide') {
                    balances.Davide += p.amount;
                    balances.Mattia -= p.amount;
                } else {
                    balances.Mattia += p.amount;
                    balances.Davide -= p.amount;
                }
            });

            const debtor = balances.Davide < -0.01 ? 'davide' : balances.Mattia < -0.01 ? 'mattia' : null;

            if (debtor && from !== debtor) {
                showNotification('‚ùå ' + translations[currentLanguage].onlyDebtorCanPay);
                return;
            }

            const newPayments = getPayments();
            newPayments.push({
                id: Date.now(),
                amount: amount,
                from: from,
                date: new Date().toISOString(),
                recordedBy: currentUser
            });

            savePayments(newPayments);
            document.getElementById('paymentAmount').value = '';
            showNotification(translations[currentLanguage].paymentRecordedNotif);
            displaySettlement();
            displayPaymentHistory();
        }

        function displayPaymentHistory() {
            const payments = getPayments();
            const historyDiv = document.getElementById('paymentHistory');

            if (payments.length === 0) {
                historyDiv.innerHTML = '';
                return;
            }

            payments.sort((a, b) => new Date(b.date) - new Date(a.date));
            historyDiv.innerHTML = '<strong>' + (currentLanguage === 'en' ? 'Recent Payments:' : 'Pagamenti Recenti:') + '</strong>' +
                payments.slice(0, 5).map(p => `
                <div class="payment-item">
                    ${p.from === 'davide' ? 'Davide' : 'Mattia'} ‚Üí EUR ${p.amount.toFixed(2)} (${new Date(p.date).toLocaleDateString()})
                </div>
            `).join('');
        }

        // ============ EXPENSE FUNCTIONS ============
        function addExpense(e) {
            e.preventDefault();
            const expense = {
                id: Date.now(),
                description: document.getElementById('description').value,
                amount: parseFloat(document.getElementById('amount').value),
                category: document.getElementById('category').value,
                paidBy: document.getElementById('paidBy').value,
                splitBetween: document.getElementById('splitBetween').value,
                date: document.getElementById('date').value,
                notes: document.getElementById('notes').value,
                receipt: receiptBase64 || null,
                addedBy: currentUser,
                timestamp: new Date().toISOString()
            };

            const expenses = getExpenses();
            expenses.push(expense);
            saveExpenses(expenses);

            document.getElementById('description').value = '';
            document.getElementById('amount').value = '';
            document.getElementById('category').value = '';
            document.getElementById('paidBy').value = '';
            document.getElementById('splitBetween').value = '';
            document.getElementById('notes').value = '';
            document.getElementById('receiptPreview').innerHTML = '';
            receiptBase64 = null;

            showNotification(translations[currentLanguage].addedNotif);
        }

        function displayExpenses() {
            const expenses = getExpenses();
            const listDiv = document.getElementById('expensesList');

            if (expenses.length === 0) {
                listDiv.innerHTML = '<div class="no-data">' + translations[currentLanguage].noExpenses + '</div>';
                return;
            }

            expenses.sort((a, b) => new Date(b.date) - new Date(a.date));
            listDiv.innerHTML = expenses.map(exp => `
                <div class="expense-item">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div class="expense-info">
                            <div class="expense-description">${exp.description}</div>
                            <div class="expense-details">
                                <span class="category-badge">${exp.category}</span>
                                ${new Date(exp.date).toLocaleDateString()} ‚Ä¢ ${exp.paidBy} paid, split ${exp.splitBetween}<span class="user-badge-inline">${exp.addedBy}</span>
                            </div>
                        </div>
                        <div class="expense-amount">EUR ${exp.amount.toFixed(2)}</div>
                    </div>
                    ${exp.receipt ? `<div class="expense-receipt"><img src="${exp.receipt}" alt="Receipt"></div>` : ''}
                    <div style="margin-top: 12px;">
                        <button class="btn-danger" onclick="deleteExpense(${exp.id})" style="width: 100%; padding: 8px;">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function deleteExpense(id) {
            if (confirm('Delete this expense?')) {
                let expenses = getExpenses();
                expenses = expenses.filter(e => e.id !== id);
                saveExpenses(expenses);
                showNotification(translations[currentLanguage].deletedNotif);
            }
        }

        function clearAllExpenses() {
            if (confirm(translations[currentLanguage].clearHistoryConfirm)) {
                localStorage.removeItem('expenses_shared');
                localStorage.removeItem('payments_shared');
                displayExpenses();
                displaySettlement();
                showNotification(translations[currentLanguage].historyCleared);
            }
        }

        function filterExpenses() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const category = document.getElementById('filterCategory').value;
            const month = document.getElementById('filterMonth').value;
            const year = document.getElementById('filterYear').value;

            const expenses = getExpenses();
            filteredExpenses = expenses.filter(exp => {
                const matchesSearch = exp.description.toLowerCase().includes(searchText);
                const matchesCategory = !category || exp.category === category;
                const expDate = new Date(exp.date);
                const matchesMonth = !month || (expDate.getMonth() + 1).toString() === month;
                const matchesYear = !year || expDate.getFullYear().toString() === year;

                return matchesSearch && matchesCategory && matchesMonth && matchesYear;
            });

            document.getElementById('expensesList').innerHTML = filteredExpenses.length === 0
                ? '<div class="no-data">' + translations[currentLanguage].noExpenses + '</div>'
                : filteredExpenses.map(exp => `
                    <div class="expense-item">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div class="expense-info">
                                <div class="expense-description">${exp.description}</div>
                                <div class="expense-details">
                                    <span class="category-badge">${exp.category}</span>
                                    ${new Date(exp.date).toLocaleDateString()} ‚Ä¢ ${exp.paidBy} paid, split ${exp.splitBetween}
                                </div>
                            </div>
                            <div class="expense-amount">EUR ${exp.amount.toFixed(2)}</div>
                        </div>
                        ${exp.receipt ? `<div class="expense-receipt"><img src="${exp.receipt}" alt="Receipt"></div>` : ''}
                        <div style="margin-top: 12px;">
                            <button class="btn-danger" onclick="deleteExpense(${exp.id})" style="width: 100%; padding: 8px;">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `).join('');
        }

        function populateMonthYearFilters() {
            const expenses = getExpenses();
            const months = new Set();
            const years = new Set();

            expenses.forEach(exp => {
                const date = new Date(exp.date);
                months.add(date.getMonth() + 1);
                years.add(date.getFullYear());
            });

            const monthSelect = document.getElementById('filterMonth');
            const yearSelect = document.getElementById('filterYear');

            monthSelect.innerHTML = '<option value="">All Months</option>' +
                Array.from(months).sort().map(m => `<option value="${m}">${new Date(2000, m - 1).toLocaleString('en-US', {month: 'long'})}</option>`).join('');

            yearSelect.innerHTML = '<option value="">All Years</option>' +
                Array.from(years).sort().map(y => `<option value="${y}">${y}</option>`).join('');
        }

        // ============ CAMERA FUNCTIONS ============
        function openCamera() {
            document.getElementById('cameraInput').click();
        }

        function handleCameraCapture() {
            const file = document.getElementById('cameraInput').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    receiptBase64 = e.target.result;
                    document.getElementById('receiptPreview').innerHTML = `<img src="${receiptBase64}" style="max-width: 200px; border-radius: 6px;">`;
                };
                reader.readAsDataURL(file);
            }
        }

        // ============ GUEST FUNCTIONS ============
        function openAddGuestModal() {
            currentEditingGuestId = null;
            guestPhotos = [];
            const t = translations[currentLanguage];
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.id = 'addGuestModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>${t.addGuestBtn}</h3>
                        <button class="modal-close" onclick="closeModal()">√ó</button>
                    </div>
                    <form onsubmit="saveGuest(event)">
                        <div class="form-group">
                            <label>${t.guestName}</label>
                            <input type="text" id="guestName" required placeholder="Full name">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>${t.guestEmail}</label>
                                <input type="email" id="guestEmail" placeholder="email@example.com">
                            </div>
                            <div class="form-group">
                                <label>${t.guestPhone}</label>
                                <input type="tel" id="guestPhone" placeholder="+39 xxx xxx xxxx">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>${t.checkIn}</label>
                                <input type="date" id="guestCheckIn" required onchange="updateTouristTaxPreview()">
                            </div>
                            <div class="form-group">
                                <label>${t.checkOut}</label>
                                <input type="date" id="guestCheckOut" required onchange="updateTouristTaxPreview()">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>${t.guestAccompanied}</label>
                            <input type="number" id="guestAccompanied" placeholder="0" min="0" max="10" value="0" onchange="updateAccompaniedGuestsForm(); updateTouristTaxPreview();">
                        </div>

                        <div id="accompaniedGuestsContainer"></div>

                        <div class="form-group">
                            <label>${t.guestPhotos}</label>
                            <button type="button" class="camera-btn" onclick="openGuestPhotoGallery()">üì∏ ${t.addPhotos}</button>
                            <input type="file" id="guestPhotoInput" accept="image/*" multiple onchange="handleGuestPhotos()">
                            <div id="guestPhotoPreview" class="image-gallery"></div>
                        </div>

                        <div class="tourist-tax-section">
                            <h4>${t.touristTaxSection}</h4>
                            <div class="tourist-tax-row">
                                <div>
                                    <label>${t.touristTaxAmount}</label>
                                    <input type="text" id="touristTaxAmount" readonly value="EUR 0.00">
                                    <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">${t.touristTaxCalculation}</div>
                                </div>
                                <div class="tourist-tax-paid">
                                    <label>${t.touristTaxPaid}</label>
                                    <input type="checkbox" id="touristTaxPaid">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>${t.guestNotes}</label>
                            <textarea id="guestNotes" placeholder="Any special requirements..." rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn-primary" style="width: 100%;">${t.saveGuest}</button>
                        </div>
                    </form>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = '';
            document.getElementById('modalContainer').appendChild(modal);
            modal.onclick = (e) => {
                if (e.target === modal) closeModal();
            };
        }

        function updateAccompaniedGuestsForm() {
            const count = parseInt(document.getElementById('guestAccompanied').value) || 0;
            const container = document.getElementById('accompaniedGuestsContainer');
            const t = translations[currentLanguage];

            let html = '';
            if (count > 0) {
                html = `<div class="accompanied-guests-section"><h4>${t.accompaniedGuestsInfo}</h4>`;
                for (let i = 0; i < count; i++) {
                    html += `
                        <div class="guest-info-row">
                            <input type="text" id="accompaniedGuestName${i}" placeholder="${t.accompaniedGuestName}">
                            <input type="text" id="accompaniedGuestSurname${i}" placeholder="${t.accompaniedGuestSurname}">
                        </div>
                    `;
                }
                html += '</div>';
            }
            container.innerHTML = html;
        }

        function openGuestPhotoGallery() {
            document.getElementById('guestPhotoInput').click();
        }

        function handleGuestPhotos() {
            const files = document.getElementById('guestPhotoInput').files;
            const reader = new FileReader();
            let filesProcessed = 0;

            Array.from(files).forEach((file) => {
                const fileReader = new FileReader();
                fileReader.onload = (e) => {
                    guestPhotos.push(e.target.result);
                    filesProcessed++;
                    if (filesProcessed === files.length) {
                        displayGuestPhotos();
                    }
                };
                fileReader.readAsDataURL(file);
            });
        }

        function displayGuestPhotos() {
            const preview = document.getElementById('guestPhotoPreview');
            preview.innerHTML = guestPhotos.map((photo, idx) => `
                <div class="gallery-item">
                    <img src="${photo}" alt="Guest photo">
                    <button class="gallery-item-remove" onclick="removeGuestPhoto(${idx})">√ó</button>
                </div>
            `).join('');
        }

        function removeGuestPhoto(idx) {
            guestPhotos.splice(idx, 1);
            displayGuestPhotos();
        }

        function saveGuest(e) {
            e.preventDefault();
            const t = translations[currentLanguage];
            const accompaniedCount = parseInt(document.getElementById('guestAccompanied').value) || 0;
            const accompaniedGuests = [];
            for (let i = 0; i < accompaniedCount; i++) {
                const name = document.getElementById(`accompaniedGuestName${i}`)?.value || '';
                const surname = document.getElementById(`accompaniedGuestSurname${i}`)?.value || '';
                if (name && surname) accompaniedGuests.push({ name, surname });
            }

            const guestBase = {
                id: currentEditingGuestId || Date.now(),
                name: document.getElementById('guestName').value,
                email: document.getElementById('guestEmail').value,
                phone: document.getElementById('guestPhone').value,
                accompanied: accompaniedCount,
                accompaniedGuests: accompaniedGuests,
                checkIn: document.getElementById('guestCheckIn').value,
                checkOut: document.getElementById('guestCheckOut').value,
                notes: document.getElementById('guestNotes').value,
                photos: guestPhotos,
                documents: currentEditingGuestId ? (getGuests().find(g => g.id === currentEditingGuestId)?.documents || {}) : {},
                createdBy: currentUser,
                createdAt: new Date().toISOString()
            };

            const { tax } = computeTouristTax(guestBase);
            guestBase.touristTax = tax;
            guestBase.touristTaxPaid = document.getElementById('touristTaxPaid')?.checked || false;

            let guests = getGuests();
            if (currentEditingGuestId) guests = guests.map(g => g.id === currentEditingGuestId ? guestBase : g);
            else guests.push(guestBase);

            guestPhotos = [];
            saveGuests(guests);
            closeModal();
            showNotification(t.guestAdded);
        }

        function editGuest(guestId) {
            const guest = getGuests().find(g => g.id === guestId);
            if (!guest) return;

            currentEditingGuestId = guestId;
            guestPhotos = guest.photos || [];
            const t = translations[currentLanguage];
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>${t.editGuest}</h3>
                        <button class="modal-close" onclick="closeModal()">√ó</button>
                    </div>
                    <form onsubmit="saveGuest(event)">
                        <div class="form-group">
                            <label>${t.guestName}</label>
                            <input type="text" id="guestName" value="${guest.name}" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>${t.guestEmail}</label>
                                <input type="email" id="guestEmail" value="${guest.email || ''}">
                            </div>
                            <div class="form-group">
                                <label>${t.guestPhone}</label>
                                <input type="tel" id="guestPhone" value="${guest.phone || ''}">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>${t.checkIn}</label>
                                <input type="date" id="guestCheckIn" value="${guest.checkIn}" required onchange="updateTouristTaxPreview()">
                            </div>
                            <div class="form-group">
                                <label>${t.checkOut}</label>
                                <input type="date" id="guestCheckOut" value="${guest.checkOut}" required onchange="updateTouristTaxPreview()">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>${t.guestAccompanied}</label>
                            <input type="number" id="guestAccompanied" value="${guest.accompanied}" min="0" max="10" onchange="updateAccompaniedGuestsForm(); updateTouristTaxPreview();">
                        </div>

                        <div id="accompaniedGuestsContainer"></div>

                        <div class="form-group">
                            <label>${t.guestPhotos}</label>
                            <button type="button" class="camera-btn" onclick="openGuestPhotoGallery()">üì∏ ${t.addPhotos}</button>
                            <input type="file" id="guestPhotoInput" accept="image/*" multiple onchange="handleGuestPhotos()">
                            <div id="guestPhotoPreview" class="image-gallery"></div>
                        </div>

                        <div class="tourist-tax-section">
                            <h4>${t.touristTaxSection}</h4>
                            <div class="tourist-tax-row">
                                <div>
                                    <label>${t.touristTaxAmount}</label>
                                    <input type="text" id="touristTaxAmount" readonly value="EUR 0.00">
                                    <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">${t.touristTaxCalculation}</div>
                                </div>
                                <div class="tourist-tax-paid">
                                    <label>${t.touristTaxPaid}</label>
                                    <input type="checkbox" id="touristTaxPaid">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>${t.guestNotes}</label>
                            <textarea id="guestNotes" rows="3">${guest.notes || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn-primary" style="width: 100%;">${t.saveGuest}</button>
                        </div>
                    </form>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = '';
            document.getElementById('modalContainer').appendChild(modal);
            modal.onclick = (e) => {
                if (e.target === modal) closeModal();
            };

            updateAccompaniedGuestsForm();
            displayGuestPhotos();
            updateTouristTaxPreview();
            document.getElementById('touristTaxPaid').checked = guest.touristTaxPaid || false;

            // Populate accompanied guests
            if (guest.accompaniedGuests && guest.accompaniedGuests.length > 0) {
                guest.accompaniedGuests.forEach((ag, idx) => {
                    const nameField = document.getElementById(`accompaniedGuestName${idx}`);
                    const surnameField = document.getElementById(`accompaniedGuestSurname${idx}`);
                    if (nameField) nameField.value = ag.name;
                    if (surnameField) surnameField.value = ag.surname;
                });
            }
        }

        function deleteGuest(guestId) {
            if (confirm('Delete this guest?')) {
                let guests = getGuests();
                guests = guests.filter(g => g.id !== guestId);
                saveGuests(guests);
                showNotification(translations[currentLanguage].guestDeleted);
            }
        }

        function filterGuests() {
            const searchText = document.getElementById('guestSearchInput').value.toLowerCase();
            const dateFilter = document.getElementById('guestDateFilter').value;
            const statusFilter = document.getElementById('guestStatusFilter').value;
            const today = new Date();

            const guests = getGuests();
            filteredGuests = guests.filter(guest => {
                const matchesSearch = guest.name.toLowerCase().includes(searchText);
                const checkIn = new Date(guest.checkIn);
                const checkOut = new Date(guest.checkOut);

                let matchesStatus = true;
                if (statusFilter) {
                    if (statusFilter === 'upcoming' && checkIn <= today) matchesStatus = false;
                    if (statusFilter === 'current' && (today < checkIn || today >= checkOut)) matchesStatus = false;
                    if (statusFilter === 'completed' && checkOut > today) matchesStatus = false;
                }

                const matchesDate = !dateFilter || (dateFilter >= guest.checkIn && dateFilter < guest.checkOut);

                return matchesSearch && matchesStatus && matchesDate;
            });

            displayFilteredGuests();
        }

        function displayGuests() {
            filteredGuests = getGuests();
            displayFilteredGuests();
        }

        function displayFilteredGuests() {
            const listDiv = document.getElementById('guestsList');
            const t = translations[currentLanguage];

            if (filteredGuests.length === 0) {
                listDiv.innerHTML = '<div class="no-data">' + t.noGuests + '</div>';
                return;
            }

            listDiv.innerHTML = filteredGuests.map(guest => {
                const checkIn = new Date(guest.checkIn);
                const checkOut = new Date(guest.checkOut);
                const today = new Date();

                let status = 'upcoming';
                if (today >= checkIn && today < checkOut) status = 'current';
                if (today >= checkOut) status = 'completed';

                const statusText = { upcoming: t.upcoming, current: t.current, completed: t.completed }[status];
                const accompaniedText = guest.accompanied > 0 ? `+ ${guest.accompanied} ${t.guestGuests}` : '';

                let accompaniedInfo = '';
                if (guest.accompaniedGuests && guest.accompaniedGuests.length > 0) {
                    accompaniedInfo = '<div style="margin-top: 8px; font-size: 12px; color: var(--text-secondary);"><strong>Additional Guests:</strong><br>' +
                        guest.accompaniedGuests.map(ag => `${ag.name} ${ag.surname}`).join('<br>') +
                        '</div>';
                }

                const { tax } = computeTouristTax(guest);
                const taxPaidText = guest.touristTaxPaid ? '‚úì Yes' : '‚úó No';

                return `
                    <div class="guest-card">
                        <div class="guest-header">
                            <div class="guest-info" style="flex: 1;">
                                <h3>${guest.name} ${accompaniedText}</h3>
                                <div class="guest-dates">
                                    üìÖ ${checkIn.toLocaleDateString()} ‚Üí ${checkOut.toLocaleDateString()}
                                </div>
                                ${accompaniedInfo}
                                <span class="guest-status ${status}">${statusText}</span>
                            </div>
                        </div>
                        ${guest.photos && guest.photos.length > 0 ? `
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                                <strong style="font-size: 13px;">${t.guestPhotos}:</strong>
                                <div class="image-gallery">
                                    ${guest.photos.map((photo, idx) => `
                                        <div class="gallery-item">
                                            <img src="${photo}" alt="Guest photo">
                                            <button class="gallery-item-remove" onclick="removeGuestPhoto2(${guest.id}, ${idx})">√ó</button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); font-size: 13px;">
                            <strong>${t.touristTaxSection}:</strong><br>
                            EUR ${tax.toFixed(2)} ‚Ä¢ ${t.touristTaxPaid}: ${taxPaidText}
                        </div>
                        <div class="guest-documents">
                            <strong style="font-size: 13px;">üìÑ Documents:</strong>
                            <div style="margin-top: 8px;">
                                ${Object.entries(guest.documents || {}).length > 0 ? Object.entries(guest.documents).map(([docType, docs]) => `
                                    <div style="margin-bottom: 8px;">
                                        <div style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px;">${docType}</div>
                                        <div class="image-gallery">
                                            ${docs.map((doc, idx) => `
                                                <div class="gallery-item">
                                                    <img src="${doc}" alt="${docType}">
                                                    <button class="gallery-item-remove" onclick="removeGuestDocument(${guest.id}, '${docType}', ${idx})">√ó</button>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('') : '<div style="font-size: 12px; color: var(--text-secondary);">No documents</div>'}
                            </div>
                        </div>
                        <div class="guest-actions">
                            <button class="btn-primary" style="padding: 8px;" onclick="openAddDocumentModal(${guest.id})">üìÅ ${t.addDocuments}</button>
                            <button class="btn-secondary" style="padding: 8px;" onclick="editGuest(${guest.id})">‚úèÔ∏è ${t.editGuest}</button>
                            <button class="btn-danger" onclick="deleteGuest(${guest.id})">üóëÔ∏è ${t.deleteGuest}</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function removeGuestPhoto2(guestId, photoIdx) {
            let guests = getGuests();
            const guest = guests.find(g => g.id === guestId);
            if (guest && guest.photos) {
                guest.photos.splice(photoIdx, 1);
                saveGuests(guests);
            }
        }

        function openAddDocumentModal(guestId) {
            const t = translations[currentLanguage];
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>${t.addDocuments}</h3>
                        <button class="modal-close" onclick="closeModal()">√ó</button>
                    </div>
                    <div class="form-group">
                        <label>Document Type</label>
                        <select id="documentType">
                            <option value="ID/Passport">${t.idDocument}</option>
                            <option value="Tourist Tax Receipt">${t.touristTaxReceipt}</option>
                            <option value="Payment Receipt">${t.paymentReceipt}</option>
                            <option value="Check-in Photo">${t.checkInPhoto}</option>
                            <option value="Other Documents">${t.otherDoc}</option>
                        </select>
                    </div>
                    <button class="camera-btn" onclick="openDocumentCamera(${guestId})">üì∏ ${t.uploadDocument}</button>
                    <input type="file" id="documentInput" accept="image/*" onchange="handleDocumentUpload(${guestId})">
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = '';
            document.getElementById('modalContainer').appendChild(modal);
            modal.onclick = (e) => {
                if (e.target === modal) closeModal();
            };
        }

        function openDocumentCamera(guestId) {
            document.getElementById('documentInput').click();
        }

        function handleDocumentUpload(guestId) {
            const file = document.getElementById('documentInput').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const docType = document.getElementById('documentType').value;
                    let guests = getGuests();
                    const guest = guests.find(g => g.id === guestId);
                    if (guest) {
                        if (!guest.documents) guest.documents = {};
                        if (!guest.documents[docType]) guest.documents[docType] = [];
                        guest.documents[docType].push(e.target.result);
                        saveGuests(guests);
                        closeModal();
                        showNotification(translations[currentLanguage].documentAdded);
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        function removeGuestDocument(guestId, docType, docIdx) {
            let guests = getGuests();
            const guest = guests.find(g => g.id === guestId);
            if (guest && guest.documents && guest.documents[docType]) {
                guest.documents[docType].splice(docIdx, 1);
                if (guest.documents[docType].length === 0) delete guest.documents[docType];
                saveGuests(guests);
            }
        }

        function closeModal() {
            document.getElementById('modalContainer').innerHTML = '';
        }

        // ============ CALENDAR FUNCTIONS ============
        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();

            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();

            const calendarDays = document.getElementById('calendarDays');
            calendarDays.innerHTML = '';

            for (let i = firstDay - 1; i >= 0; i--) {
                const day = daysInPrevMonth - i;
                const cell = document.createElement('div');
                cell.className = 'calendar-day other-month';
                cell.textContent = day;
                calendarDays.appendChild(cell);
            }

            const calendar = getCalendarData();
            const t = translations[currentLanguage];

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const status = calendar[dateStr] || 'available';

                const cell = document.createElement('div');
                cell.className = `calendar-day ${status}`;
                cell.innerHTML = `<div class="calendar-day-number">${day}</div><div class="calendar-day-status">${t[status] || status}</div>`;
                cell.onclick = () => openCalendarStatusModal(dateStr);
                calendarDays.appendChild(cell);
            }

            const nextMonthDays = 42 - (firstDay + daysInMonth);
            for (let day = 1; day <= nextMonthDays; day++) {
                const cell = document.createElement('div');
                cell.className = 'calendar-day other-month';
                cell.textContent = day;
                calendarDays.appendChild(cell);
            }
        }

        function openCalendarStatusModal(dateStr) {
            const calendar = getCalendarData();
            const currentStatus = calendar[dateStr] || 'available';
            const t = translations[currentLanguage];

            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Set Status for ${dateStr}</h3>
                        <button class="modal-close" onclick="closeModal()">√ó</button>
                    </div>
                    <div class="day-status-selector">
                        <button class="status-option ${currentStatus === 'available' ? 'selected' : ''}" onclick="setCalendarStatus('${dateStr}', 'available')">
                            ‚úÖ ${t.available}
                        </button>
                        <button class="status-option ${currentStatus === 'occupied' ? 'selected' : ''}" onclick="setCalendarStatus('${dateStr}', 'occupied')">
                            ‚ùå ${t.occupied}
                        </button>
                        <button class="status-option ${currentStatus === 'cleaning' ? 'selected' : ''}" onclick="setCalendarStatus('${dateStr}', 'cleaning')">
                            üßπ ${t.cleaning}
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = '';
            document.getElementById('modalContainer').appendChild(modal);
            modal.onclick = (e) => {
                if (e.target === modal) closeModal();
            };
        }

        function setCalendarStatus(dateStr, status) {
            const calendar = getCalendarData();
            calendar[dateStr] = status;
            saveCalendarData(calendar);
            closeModal();
        }

        function previousMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar();
        }

        // ============ EXPORT FUNCTIONS ============
        async function generateAndDownloadReport() {
            const now = new Date();
            const t = translations[currentLanguage];
            const expenses = getExpenses();
            const guests = getGuests();

            const bgColor = currentTheme === 'dark' ? '#1e1e1e' : '#ffffff';
            const textColor = currentTheme === 'dark' ? '#e0e0e0' : '#333';
            const accentColor = currentTheme === 'dark' ? '#64B5F6' : '#2196F3';

            const html = `
                <div style="background: ${bgColor}; color: ${textColor}; font-family: 'Segoe UI', Arial, sans-serif; padding: 60px 40px;">
                    <div style="text-align: center; margin-bottom: 50px; border-bottom: 3px solid ${accentColor}; padding-bottom: 30px;">
                        <h1 style="color: ${accentColor}; margin: 0 0 8px 0; font-size: 48px; font-weight: 700;">Chillinguito Lake Como</h1>
                        <p style="color: #999; margin: 0; font-size: 16px;">${currentLanguage === 'en' ? 'Financial Report' : 'Rapporto Finanziario'} ‚Ä¢ ${now.toLocaleDateString()}</p>
                    </div>
                    <div style="margin-bottom: 50px;">
                        <h2 style="color: ${accentColor}; margin: 0 0 20px 0; font-size: 28px; font-weight: 600;">üìä Summary</h2>
                        <p>Total expenses: EUR ${expenses.reduce((sum, e) => sum + e.amount, 0).toFixed(2)}</p>
                        <p>Total guests: ${guests.length}</p>
                    </div>
                </div>
            `;

            const reportDiv = document.getElementById('exportReport') || document.createElement('div');
            reportDiv.id = 'exportReport';
            reportDiv.innerHTML = html;
            reportDiv.style.display = 'block';
            document.body.appendChild(reportDiv);

            try {
                const canvas = await html2canvas(reportDiv, {
                    backgroundColor: bgColor,
                    scale: 2,
                    width: 1000,
                    logging: false
                });
                canvas.toBlob(blob => {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `Chillinguito-Report-${now.toISOString().split('T')[0]}.png`;
                    link.click();
                    showNotification(t.reportDownloadedNotif);
                    setTimeout(() => reportDiv.remove(), 1000);
                });
            } catch (error) {
                alert('Error creating report: ' + error.message);
            }
        }

        // ============ UI FUNCTIONS ============
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            if (tabName === 'calendar') {
                setTimeout(() => renderCalendar(), 50);
            }
            if (tabName === 'guests') {
                displayGuests();
            }
        }

        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('language', lang);
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            updateTranslations();
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            localStorage.setItem('theme', currentTheme);
            document.documentElement.setAttribute('data-theme', currentTheme);
            document.querySelector('.theme-btn').textContent = currentTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        // ============ TOTP ============
        function base32Decode(str) {
            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
            const bits = [];
            for (let i = 0; i < str.length; i++) {
                const val = alphabet.indexOf(str[i]);
                if (val === -1) throw new Error('Invalid base32');
                bits.push(...val.toString(2).padStart(5, '0').split('').map(Number));
            }
            const bytes = [];
            for (let i = 0; i + 8 <= bits.length; i += 8) {
                bytes.push(parseInt(bits.slice(i, i + 8).join(''), 2));
            }
            return new Uint8Array(bytes);
        }

        async function generateTOTPCode(secret, timeWindow = 0) {
            try {
                const decoded = base32Decode(secret);
                const epoch = Math.floor(Date.now() / 30000) + timeWindow;
                const msg = new ArrayBuffer(8);
                const view = new DataView(msg);
                view.setBigInt64(0, BigInt(epoch), false);
                const key = await crypto.subtle.importKey('raw', decoded, { name: 'HMAC', hash: 'SHA-1' }, false, ['sign']);
                const signature = await crypto.subtle.sign('HMAC', key, msg);
                const sig = new Uint8Array(signature);
                const offset = sig[sig.length - 1] & 0x0f;
                const p = ((sig[offset] & 0x7f) << 24) | ((sig[offset + 1] & 0xff) << 16) | ((sig[offset + 2] & 0xff) << 8) | (sig[offset + 3] & 0xff);
                return String(p % 1000000).padStart(6, '0');
            } catch (error) {
                return null;
            }
        }

        async function validateTOTPCode(inputCode) {
            for (let timeWindow of [-1, 0, 1]) {
                const code = await generateTOTPCode(TOTP_SECRET, timeWindow);
                if (code === inputCode) return true;
            }
            return false;
        }

        function setupTOTPInput() {
            const inputs = document.querySelectorAll('.totp-digit');
            inputs.forEach((input, index) => {
                input.addEventListener('keydown', (e) => {
                    if (!/[0-9]/.test(e.key) && !['Backspace', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                        e.preventDefault();
                    }
                    if (e.key === 'Backspace' && input.value === '' && index > 0) {
                        inputs[index - 1].focus();
                    }
                });
                input.addEventListener('input', (e) => {
                    if (e.target.value.length === 1 && index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    }
                });
            });
            inputs[0].focus();
        }

        function selectUser(user) {
            currentUser = user;
            document.querySelectorAll('.user-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.closest('.user-btn').classList.add('selected');
        }

        async function validateTOTP() {
            if (!currentUser) {
                document.getElementById('errorMessage').textContent = '‚ùå Select a user';
                return;
            }

            const inputs = document.querySelectorAll('.totp-digit');
            const code = Array.from(inputs).map(input => input.value).join('');

            if (code.length !== 6) {
                document.getElementById('errorMessage').textContent = '‚ùå Enter all 6 digits';
                return;
            }

            const btn = document.getElementById('unlockBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Verifying...';

            const isValid = await validateTOTPCode(code);
            if (isValid) {
                localStorage.setItem('currentUser', currentUser);
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                document.body.classList.remove('locked');
                initializeApp();
            } else {
                document.getElementById('errorMessage').textContent = '‚ùå Invalid code';
                inputs.forEach(input => input.value = '');
                btn.disabled = false;
                btn.textContent = translations[currentLanguage].unlockBtn;
            }
        }

        function logout() {
            if (confirm('üîí Lock the app?')) {
                localStorage.removeItem('currentUser');
                location.reload();
            }
        }

        // ============ DB & OTHER USER STATUS ============
        function setupDBStatusCheck() {
            if (!isFirebaseReady) return;
            db.ref('.info/connected').on('value', (snapshot) => {
                dbConnected = snapshot.val() === true;
                updateDBStatus();
            });
        }

        function updateDBStatus() {
            const indicator = document.getElementById('dbStatusIndicator');
            const dot = document.getElementById('dbStatusDot');
            const status = document.getElementById('dbStatus');
            const t = translations[currentLanguage];

            if (dbConnected) {
                indicator.style.display = 'flex';
                dot.className = 'status-dot';
                status.textContent = t.dbConnected;
            } else {
                indicator.style.display = 'flex';
                dot.className = 'status-dot offline';
                status.textContent = t.dbDisconnected;
            }
        }

        function checkOtherUserStatus() {
            setInterval(() => {
                const otherUser = currentUser === 'davide' ? 'mattia' : 'davide';
                const lastActivity = localStorage.getItem(`lastActivity_${otherUser}`);
                const now = Date.now();
                const threshold = 30000;

                if (lastActivity && now - parseInt(lastActivity) < threshold) {
                    otherUserOnline = true;
                } else {
                    otherUserOnline = false;
                }
                updateOtherUserStatus();
            }, 5000);
        }

        function updateOtherUserStatus() {
            const indicator = document.getElementById('otherUserStatusIndicator');
            const dot = document.getElementById('otherUserDot');
            const status = document.getElementById('otherUserStatus');
            const t = translations[currentLanguage];
            const otherUser = currentUser === 'davide' ? 'Mattia' : 'Davide';

            if (otherUserOnline) {
                indicator.style.display = 'flex';
                dot.className = 'status-dot';
                status.textContent = `${otherUser} ${t.userOnline}`;
            } else {
                indicator.style.display = 'none';
            }
        }

        function updateLastActivity() {
            localStorage.setItem(`lastActivity_${currentUser}`, Date.now().toString());
        }

        // ============ FIREBASE LISTENERS ============
        function setupListeners() {
            if (!isFirebaseReady || listenersSetup) return;

            console.log('üîÑ Setting up Firebase listeners...');
            listenersSetup = true;

            db.ref('shared/expenses').on('value', (snapshot) => {
                const expenses = snapshot.val() || [];
                localStorage.setItem('expenses_shared', JSON.stringify(expenses));
                displayExpenses();
                displaySettlement();
            });

            db.ref('shared/calendar').on('value', (snapshot) => {
                const calendar = snapshot.val() || {};
                localStorage.setItem('calendar_shared', JSON.stringify(calendar));
                renderCalendar();
            });

            db.ref('shared/payments').on('value', (snapshot) => {
                const payments = snapshot.val() || [];
                localStorage.setItem('payments_shared', JSON.stringify(payments));
                displaySettlement();
                displayPaymentHistory();
            });

            db.ref('shared/guests').on('value', (snapshot) => {
                const guests = snapshot.val() || [];
                localStorage.setItem('guests_shared', JSON.stringify(guests));
                displayGuests();
            });
        }

        // ============ INIT ============
        function initializeApp() {
            console.log('üöÄ App init for', currentUser);

            updateTranslations();
            document.getElementById('date').valueAsDate = new Date();

            const icon = currentUser === 'davide' ? 'üë®' : 'üë®‚Äçü¶±';
            const name = currentUser.charAt(0).toUpperCase() + currentUser.slice(1);
            document.getElementById('userIcon').textContent = icon;
            document.getElementById('userName').textContent = name;

            displayExpenses();
            displaySettlement();
            displayPaymentHistory();
            displayGuests();
            renderCalendar();
            setupDBStatusCheck();
            checkOtherUserStatus();
            updateLastActivity();

            setInterval(() => {
                updateLastActivity();
                updateOtherUserStatus();
            }, 5000);

            setTimeout(() => {
                setupListeners();
            }, 500);
        }

        window.addEventListener('load', () => {
            document.documentElement.setAttribute('data-theme', currentTheme);
            document.querySelector('.theme-btn').textContent = currentTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            updateTranslations();

            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = savedUser;
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                initializeApp();
            } else {
                document.body.classList.add('locked');
                document.getElementById('authScreen').style.display = 'flex';
                setupTOTPInput();
            }
        });
    </script>
</body>
</html>
