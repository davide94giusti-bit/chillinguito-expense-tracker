<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chillinguito Lake Como - v11 FINAL</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
 <style>
/* ============================================
   CHILLINGUITO LAKE COMO - MODERN UI v2.0
   Premium Design System with Lake Como Vibe
   ============================================ */

:root {
  /* Color Palette - Lake Como Inspired */
  --primary: #0066CC;
  --primary-light: #E3F2FD;
  --primary-lighter: #F3F9FF;
  --secondary: #00B4D8;
  --accent: #FF6B6B;
  --success: #4CAF50;
  --warning: #FF9800;
  --danger: #F44336;
  
  /* Lake Como Colors */
  --lake-dark: #1a3a52;
  --lake-water: #2E8B9E;
  --lake-light: #64D4FF;
  --sky-blue: #87CEEB;
  
  /* Neutrals */
  --white: #FFFFFF;
  --off-white: #F8FBFE;
  --gray-50: #F9FAFB;
  --gray-100: #F3F4F6;
  --gray-200: #E5E7EB;
  --gray-300: #D1D5DB;
  --gray-400: #9CA3AF;
  --gray-500: #6B7280;
  --gray-600: #4B5563;
  --gray-700: #374151;
  --gray-800: #1F2937;
  --gray-900: #111827;

  /* ============================================
   AUTH SCREEN - LAKE COMO DESIGN
   ============================================ */

#authScreen {
  background: linear-gradient(135deg, rgba(26, 58, 82, 0.8), rgba(46, 139, 158, 0.8)), 
              url('https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=1200&h=1200&fit=crop') center/cover no-repeat;
  background-attachment: scroll; /* Better for mobile */
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

/* Mobile optimization */
@media (max-width: 768px) {
  #authScreen {
    background-attachment: scroll !important;
    background-size: cover !important;
  }
}

.auth-container {
  background: white;
  border-radius: 24px;
  padding: 48px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
  max-width: 450px;
  width: 100%;
  text-align: center;
}

.auth-container h1 {
  color: #0066CC;
  font-size: 40px;
  font-weight: 700;
  margin: 0 0 12px 0;
  letter-spacing: -0.5px;
}

.auth-container p {
  color: #666;
  font-size: 15px;
  margin: 0 0 32px 0;
  line-height: 1.5;
}

.user-grid {
  display: flex;
  gap: 16px;
  margin-bottom: 28px;
  justify-content: center;
}

.user-choice {
  padding: 14px 28px;
  border: 2px solid #ddd;
  border-radius: 24px;
  background: white;
  cursor: pointer;
  font-weight: 600;
  font-size: 16px;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  min-width: 140px;
  color: #333;
}

.user-choice:hover {
  border-color: #0066CC;
  background: rgba(0, 102, 204, 0.05);
}

.user-choice.active {
  border-color: #0066CC;
  background: rgba(0, 102, 204, 0.1);
  color: #0066CC;
}

.user-choice span:first-child {
  font-size: 20px;
}

.code-input {
  display: flex;
  gap: 8px;
  justify-content: center;
  margin: 24px 0 32px 0;
  flex-wrap: wrap;
}

.code-box {
  width: 48px;
  height: 48px;
  font-size: 22px !important;
  font-weight: 600;
  text-align: center;
  border: 2px solid #ddd !important;
  border-radius: 10px;
  color: #333;
  background: white !important;
  padding: 0 !important;
  transition: all 0.2s ease;
}

.code-box:focus {
  outline: none;
  border-color: #0066CC !important;
  box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
}

.auth-step label {
  display: block;
  font-size: 14px;
  font-weight: 600;
  color: #333;
  margin-bottom: 12px;
}

.unlock-btn {
  width: 100%;
  padding: 16px;
  background: linear-gradient(135deg, #0066CC, #2E8B9E);
  color: white;
  border: none;
  border-radius: 24px;
  font-size: 18px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  min-height: 56px;
  box-shadow: 0 4px 15px rgba(0, 102, 204, 0.3);
  margin-bottom: 16px;
}

.unlock-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0, 102, 204, 0.4);
}

.unlock-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.error-message {
  color: #F44336;
  font-size: 13px;
  margin-bottom: 16px;
  min-height: 18px;
}

.auth-info {
  background: rgba(255, 193, 7, 0.08);
  border: 1px solid rgba(255, 193, 7, 0.2);
  padding: 14px;
  border-radius: 12px;
  font-size: 13px;
  color: #555;
  line-height: 1.5;
}
  
  /* Shadows */
  --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  
  /* Spacing */
  --spacing-1: 4px;
  --spacing-2: 8px;
  --spacing-3: 12px;
  --spacing-4: 16px;
  --spacing-5: 20px;
  --spacing-6: 24px;
  --spacing-7: 28px;
  --spacing-8: 32px;
  --spacing-9: 36px;
  --spacing-10: 40px;
  
  /* Border Radius */
  --radius-none: 0;
  --radius-sm: 6px;
  --radius-md: 8px;
  --radius-lg: 12px;
  --radius-xl: 16px;
  --radius-2xl: 20px;
  --radius-full: 9999px;
  
  /* Typography */
  --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  --font-size-xs: 12px;
  --font-size-sm: 14px;
  --font-size-base: 16px;
  --font-size-lg: 18px;
  --font-size-xl: 20px;
  --font-size-2xl: 24px;
  --font-size-3xl: 30px;
  --font-size-4xl: 36px;
  
  /* Transitions */
  --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
  --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
  --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html, body {
  width: 100%;
  height: 100vh;
  height: 100dvh;  /* For modern phones */
  margin: 0;
  padding: 0;
  overflow: hidden;
}

@supports (height: 100dvh) {
  html, body {
    height: 100dvh;
  }
}

body {
  font-family: var(--font-sans);
  background-color: var(--off-white);
  color: var(--gray-800);
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#mainApp {
  display: flex;
  flex-direction: column;
  height: 100vh;
  background-color: var(--off-white);
}

header {
  background: linear-gradient(135deg, var(--lake-dark) 0%, var(--lake-water) 100%);
  color: var(--white);
  padding: var(--spacing-6) 0;
  box-shadow: var(--shadow-lg);
  position: sticky;
  top: 0;
  z-index: 100;
}

.container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 var(--spacing-6);
  width: 100%;
}

.header-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--spacing-4);
  flex-wrap: wrap;
  gap: var(--spacing-4);
}

.header-top h1 {
  font-size: var(--font-size-3xl);
  font-weight: 700;
  margin: 0;
  letter-spacing: -0.5px;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.header-top p {
  font-size: var(--font-size-sm);
  opacity: 0.9;
  margin: 0;
}

.header-status {
  display: flex;
  gap: var(--spacing-4);
  align-items: center;
  flex-wrap: wrap;
}

.status-badge {
  display: inline-flex;
  align-items: center;
  gap: var(--spacing-2);
  background: rgba(255, 255, 255, 0.15);
  padding: var(--spacing-2) var(--spacing-3);
  border-radius: var(--radius-full);
  font-size: var(--font-size-xs);
  font-weight: 600;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.status-dot {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: var(--radius-full);
  background-color: var(--success);
  animation: pulse 2s infinite;
}

.status-dot.syncing {
  animation: pulse-fast 0.8s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

@keyframes pulse-fast {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.7; transform: scale(0.9); }
}

.sync-status-indicator {
  display: none;
}

.user-badge {
  display: inline-flex;
  align-items: center;
  gap: var(--spacing-2);
  background: rgba(255, 255, 255, 0.15);
  padding: var(--spacing-2) var(--spacing-4);
  border-radius: var(--radius-full);
  font-size: var(--font-size-sm);
  font-weight: 600;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.user-badge span:first-child {
  font-size: var(--font-size-lg);
}

.lang-btn, .theme-btn, .logout-btn {
  background: rgba(255, 255, 255, 0.15);
  color: var(--white);
  border: 1px solid rgba(255, 255, 255, 0.2);
  padding: var(--spacing-2) var(--spacing-4);
  border-radius: var(--radius-lg);
  font-size: var(--font-size-xs);
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition-base);
  backdrop-filter: blur(10px);
}

.lang-btn:hover:not(.logout-btn), .theme-btn:hover:not(.logout-btn) {
  background: rgba(255, 255, 255, 0.25);
  transform: translateY(-2px);
}

.lang-btn.active {
  background: var(--white);
  color: var(--lake-dark);
}

.logout-btn {
  background: rgba(244, 67, 54, 0.2);
  border-color: rgba(244, 67, 54, 0.3);
}

.logout-btn:hover {
  background: rgba(244, 67, 54, 0.3);
  transform: translateY(-2px);
}

.tabs {
  display: flex;
  gap: var(--spacing-2);
  background-color: var(--white);
  padding: 0;
  border-bottom: 2px solid var(--gray-200);
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

.tab-btn {
  background: none;
  border: none;
  color: var(--gray-500);
  padding: var(--spacing-4) var(--spacing-5);
  font-size: var(--font-size-base);
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition-base);
  border-bottom: 3px solid transparent;
  white-space: nowrap;
  position: relative;
}

.tab-btn:hover {
  color: var(--primary);
}

.tab-btn.active {
  color: var(--primary);
  border-bottom-color: var(--primary);
}

#notificationContainer {
  padding: var(--spacing-4);
  max-width: 500px;
  margin: 0 auto;
}

.notification-banner {
  background: var(--success);
  color: var(--white);
  padding: var(--spacing-3) var(--spacing-4);
  border-radius: var(--radius-lg);
  margin-bottom: var(--spacing-3);
  font-size: var(--font-size-sm);
  font-weight: 600;
  animation: slideDown var(--transition-base);
  box-shadow: var(--shadow-md);
}

.notification-banner.warning {
  background: var(--warning);
}

.notification-banner.error {
  background: var(--danger);
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.tab-content {
  display: none;
  padding: var(--spacing-6);
  animation: fadeIn var(--transition-base);
  flex: 1;
  overflow-y: auto;
}

.tab-content.active {
  display: block;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.card {
  background: var(--white);
  border-radius: var(--radius-xl);
  padding: var(--spacing-6);
  box-shadow: var(--shadow-md);
  border: 1px solid var(--gray-200);
  transition: all var(--transition-base);
}

.card:hover {
  box-shadow: var(--shadow-lg);
  border-color: var(--gray-300);
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--spacing-6);
  padding-bottom: var(--spacing-4);
  border-bottom: 1px solid var(--gray-200);
}

.card-header h2 {
  font-size: var(--font-size-2xl);
  font-weight: 700;
  color: var(--gray-900);
  margin: 0;
}

.form-group {
  margin-bottom: var(--spacing-5);
}

label {
  display: block;
  font-size: var(--font-size-sm);
  font-weight: 600;
  color: var(--gray-700);
  margin-bottom: var(--spacing-2);
  transition: color var(--transition-base);
}

input[type="text"],
input[type="email"],
input[type="number"],
input[type="date"],
input[type="tel"],
select,
textarea {
  width: 100%;
  padding: var(--spacing-3) var(--spacing-4);
  font-size: var(--font-size-base);
  border: 1.5px solid var(--gray-300);
  border-radius: var(--radius-lg);
  background-color: var(--white);
  color: var(--gray-900);
  font-family: inherit;
  transition: all var(--transition-base);
  outline: none;
}

input:focus,
select:focus,
textarea:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
  background-color: var(--primary-lighter);
}

input::placeholder {
  color: var(--gray-400);
}

select {
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right var(--spacing-3) center;
  padding-right: var(--spacing-10);
}

textarea {
  resize: vertical;
  min-height: 100px;
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: var(--spacing-4);
}

.btn-primary,
.btn-secondary,
.btn-danger,
.camera-btn {
  padding: var(--spacing-3) var(--spacing-5);
  border: none;
  border-radius: var(--radius-lg);
  font-size: var(--font-size-base);
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition-base);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: var(--spacing-2);
  font-family: inherit;
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary) 0%, var(--lake-water) 100%);
  color: var(--white);
  box-shadow: var(--shadow-md);
}

.btn-primary:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.btn-primary:active:not(:disabled) {
  transform: translateY(0);
}

.btn-primary:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.btn-secondary {
  background: var(--gray-200);
  color: var(--gray-800);
  border: 1px solid var(--gray-300);
}

.btn-secondary:hover:not(:disabled) {
  background: var(--gray-300);
  transform: translateY(-2px);
}

.btn-danger {
  background: rgba(244, 67, 54, 0.1);
  color: var(--danger);
  border: 1px solid rgba(244, 67, 54, 0.2);
}

.btn-danger:hover:not(:disabled) {
  background: rgba(244, 67, 54, 0.2);
  transform: translateY(-2px);
}

.camera-btn {
  background: var(--secondary);
  color: var(--white);
  box-shadow: var(--shadow-md);
}

.camera-btn:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.expense-item {
  background: var(--gray-50);
  border: 1px solid var(--gray-200);
  border-radius: var(--radius-lg);
  padding: var(--spacing-4);
  margin-bottom: var(--spacing-3);
  transition: all var(--transition-base);
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: var(--spacing-4);
}

.expense-item:hover {
  background: var(--white);
  border-color: var(--primary);
  box-shadow: var(--shadow-md);
}

.expense-info {
  flex: 1;
}

.expense-description {
  font-size: var(--font-size-base);
  font-weight: 600;
  color: var(--gray-900);
  margin-bottom: var(--spacing-2);
}

.expense-details {
  display: flex;
  gap: var(--spacing-3);
  flex-wrap: wrap;
  font-size: var(--font-size-xs);
  color: var(--gray-500);
}

.category-badge {
  display: inline-block;
  background: var(--primary-light);
  color: var(--primary);
  padding: var(--spacing-1) var(--spacing-3);
  border-radius: var(--radius-full);
  font-weight: 600;
}

.user-badge-inline {
  display: inline-block;
  background: var(--gray-200);
  color: var(--gray-700);
  padding: var(--spacing-1) var(--spacing-3);
  border-radius: var(--radius-full);
  font-weight: 600;
  font-size: var(--font-size-xs);
}

.expense-amount {
  font-size: var(--font-size-lg);
  font-weight: 700;
  color: var(--primary);
  min-width: 100px;
  text-align: right;
}

.expense-receipt {
  max-width: 200px;
  max-height: 200px;
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-md);
  margin-top: var(--spacing-3);
}

.settlement-banner {
  background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(76, 175, 80, 0.05));
  border: 1px solid rgba(76, 175, 80, 0.2);
  color: #2e7d32;
  padding: var(--spacing-4);
  border-radius: var(--radius-lg);
  margin-bottom: var(--spacing-6);
  font-weight: 600;
  text-align: center;
}

.settlement-banner.owed {
  background: linear-gradient(135deg, rgba(255, 152, 0, 0.1), rgba(255, 152, 0, 0.05));
  border-color: rgba(255, 152, 0, 0.2);
  color: #f57c00;
}

.settlement-summary {
  background: var(--white);
  border-radius: var(--radius-xl);
  padding: var(--spacing-6);
  box-shadow: var(--shadow-md);
  border: 1px solid var(--gray-200);
  margin-bottom: var(--spacing-6);
}

.stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: var(--spacing-4);
  margin-bottom: var(--spacing-6);
}

.stat-box {
  background: var(--gray-50);
  padding: var(--spacing-4);
  border-radius: var(--radius-lg);
  border: 1px solid var(--gray-200);
}

.stat-box-large {
  background: linear-gradient(135deg, var(--primary-light), var(--primary-lighter));
  border: 1px solid var(--primary);
}

.stat-label {
  font-size: var(--font-size-xs);
  font-weight: 600;
  color: var(--gray-600);
  margin-bottom: var(--spacing-2);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.stat-value {
  font-size: var(--font-size-3xl);
  font-weight: 700;
  color: var(--primary);
}

.progress-bar-container {
  background: var(--gray-200);
  height: 8px;
  border-radius: var(--radius-full);
  overflow: hidden;
  margin-bottom: var(--spacing-2);
}

.progress-bar {
  background: linear-gradient(90deg, var(--success), var(--lake-light));
  height: 100%;
  border-radius: var(--radius-full);
  transition: width var(--transition-base);
}

.payment-input-group {
  display: flex;
  gap: var(--spacing-3);
  margin-bottom: var(--spacing-4);
}

.payment-input-group input {
  flex: 1;
}

.payment-input-group select {
  flex: 1;
  min-width: 120px;
}

.payment-input-group button {
  flex-shrink: 0;
}

.payment-history {
  margin-top: var(--spacing-4);
}

.filter-section {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: var(--spacing-4);
  margin-bottom: var(--spacing-6);
  background: var(--white);
  padding: var(--spacing-4);
  border-radius: var(--radius-lg);
  border: 1px solid var(--gray-200);
}

.filter-input {
  position: relative;
}

.filter-input input,
.filter-input select {
  width: 100%;
}

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  padding: var(--spacing-4);
  backdrop-filter: blur(2px);
}

.modal.show {
  display: flex;
}

.modal-content {
  background: var(--white);
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-xl);
  max-width: 600px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  animation: slideUp var(--transition-base);
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: var(--spacing-6);
  border-bottom: 1px solid var(--gray-200);
  position: sticky;
  top: 0;
  background: var(--white);
  z-index: 10;
}

.modal-header h3 {
  font-size: var(--font-size-xl);
  font-weight: 700;
  margin: 0;
  color: var(--gray-900);
}

.modal-close {
  background: none;
  border: none;
  font-size: 24px;
  color: var(--gray-400);
  cursor: pointer;
  padding: 0;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all var(--transition-base);
}

.modal-close:hover {
  color: var(--gray-600);
  transform: rotate(90deg);
}

.modal-content > form,
.modal-content > div:not(.modal-header) {
  padding: var(--spacing-6);
}

/* CALENDAR - Dark Theme with Green/Orange/Red Status */
.calendar-container {
  background: #1a1a1a;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
  border: 1px solid #333;
}

.calendar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 25px;
  padding-bottom: 15px;
  border-bottom: 1px solid #333;
}

.calendar-header h2 {
  font-size: 24px;
  font-weight: 700;
  color: #64D4FF;
  margin: 0;
}

.calendar-nav button {
  background: #0066CC;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
}

.calendar-nav button:hover {
  background: #2E8B9E;
  transform: translateY(-2px);
}

.calendar-nav span {
  padding: 0 20px;
  font-weight: 600;
  min-width: 150px;
  text-align: center;
  color: white;
  font-size: 16px;
}

.calendar-weekdays {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 8px;
  margin-bottom: 15px;
  text-align: center;
}

.weekday {
  font-weight: 700;
  color: #aaa;
  font-size: 12px;
  padding: 8px;
  text-transform: uppercase;
}

.calendar-days {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 8px;
}

.calendar-day {
  aspect-ratio: 1;
  border-radius: 8px;
  padding: 8px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s ease;
  border: 1px solid transparent;
  min-height: 60px;
  text-align: center;
  color: white;
}

/* Available Days - Green */
.calendar-day.available {
  background: #4CAF50;
  border-color: #45a049;
  color: white;
}

.calendar-day.available:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
}

/* Occupied Days - Red */
.calendar-day.occupied {
  background: #F44336;
  border-color: #da190b;
  color: white;
}

.calendar-day.occupied:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4);
}

/* Cleaning Days - Orange */
.calendar-day.cleaning {
  background: #FF9800;
  border-color: #e68900;
  color: white;
}

.calendar-day.cleaning:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4);
}

/* Other month days - Darker */
.calendar-day.other-month {
  color: #555;
  background: #2a2a2a;
  border-color: #333;
  cursor: default;
}

.calendar-day.other-month:hover {
  transform: none;
}

@media (max-width: 768px) {
  .calendar-day {
    min-height: 50px;
    font-size: 12px;
  }
  
  .calendar-header h2 {
    font-size: 20px;
  }
}

.no-data {
  text-align: center;
  padding: var(--spacing-10) var(--spacing-4);
  color: var(--gray-500);
  font-size: var(--font-size-base);
}

.no-data::before {
  content: "üì≠";
  display: block;
  font-size: 48px;
  margin-bottom: var(--spacing-4);
  opacity: 0.5;
}

.export-section {
  background: var(--white);
  border-radius: var(--radius-xl);
  padding: var(--spacing-6);
  box-shadow: var(--shadow-md);
  border: 1px solid var(--gray-200);
}

.image-gallery {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
  gap: var(--spacing-3);
  margin-bottom: var(--spacing-4);
}

.gallery-item {
  position: relative;
  border-radius: var(--radius-lg);
  overflow: hidden;
  box-shadow: var(--shadow-sm);
}

.gallery-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.guest-info-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: var(--spacing-3);
  margin-bottom: var(--spacing-4);
  padding: var(--spacing-4);
  background: var(--gray-50);
  border-radius: var(--radius-lg);
}

.accompanied-guests-section {
  background: var(--gray-50);
  border-radius: var(--radius-lg);
  padding: var(--spacing-4);
  margin-bottom: var(--spacing-4);
}

.accompanied-guests-section h4 {
  margin-bottom: var(--spacing-3);
  color: var(--gray-700);
}

.tourist-tax-section {
  background: var(--gray-50);
  border-radius: var(--radius-lg);
  padding: var(--spacing-4);
  margin-bottom: var(--spacing-4);
}

.tourist-tax-section h4 {
  margin-bottom: var(--spacing-3);
  color: var(--gray-700);
}

.tourist-tax-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: var(--spacing-3);
  margin-bottom: var(--spacing-3);
  align-items: center;
}

.tourist-tax-row input[type="text"] {
  background: var(--white);
}

.tourist-tax-row input[type="checkbox"] {
  width: auto;
  margin-right: var(--spacing-2);
}

@media (max-width: 768px) {
  .header-top {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .header-status {
    width: 100%;
    flex-direction: column;
    align-items: flex-start;
  }
  
  .tab-content {
    padding: var(--spacing-4);
  }
  
  .card {
    padding: var(--spacing-4);
  }
  
  .form-row {
    grid-template-columns: 1fr;
  }
  
  .filter-section {
    grid-template-columns: 1fr;
  }
  
  .stats {
    grid-template-columns: 1fr;
  }
  
  .expense-item {
    flex-direction: column;
  }
  
  .expense-amount {
    text-align: left;
  }
  
  .guest-info-row {
    grid-template-columns: 1fr;
  }
  
  .tourist-tax-row {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 480px) {
  html, body {
    width: 100%;
    height: 100vh;
    height: 100dvh;
  }
  
  #appBody {
    width: 100%;
    height: 100%;
    min-height: 100%;
    overflow: hidden;
  }
  
  #authScreen {
    min-height: 100%;
    height: 100%;
  }
  
  .auth-container {
    padding: 24px;
  }
  
  header {
    padding: var(--spacing-4) 0;
  }
  
  /* THEN THE REST OF YOUR 480px STYLES: */

@media (max-width: 480px) {
  .header-top h1 {
    font-size: var(--font-size-2xl);
  }
  
  .tab-btn {
    padding: var(--spacing-3) var(--spacing-4);
    font-size: var(--font-size-sm);
  }
  
  .card {
    padding: var(--spacing-3);
  }
  
  .modal-content {
    max-height: 100vh;
    border-radius: var(--radius-lg);
  }
}
</style>

</head>
<body id="appBody">
    <!-- AUTH SCREEN -->
<div id="authScreen" class="auth-screen">
    <div class="auth-container">
        <div class="auth-icon">üè†</div>
        <h1 id="authTitle">Chillinguito</h1>
        <p id="authSubtitle">Select your account & enter 2FA code</p>
        
        <div class="auth-step">
            <div class="user-grid">
                <button class="user-choice" data-user="davide" onclick="selectUser('davide')">
                    <span>üë®</span>
                    <span>Davide</span>
                </button>
                <button class="user-choice" data-user="mattia" onclick="selectUser('mattia')">
                    <span>üë®</span>
                    <span>Mattia</span>
                </button>
            </div>
        </div>

        <div class="auth-step">
            <label id="authCodeLabel">Enter 6-digit code:</label>
            <div class="code-input">
                <input type="text" class="code-box" maxlength="1" inputmode="numeric">
                <input type="text" class="code-box" maxlength="1" inputmode="numeric">
                <input type="text" class="code-box" maxlength="1" inputmode="numeric">
                <input type="text" class="code-box" maxlength="1" inputmode="numeric">
                <input type="text" class="code-box" maxlength="1" inputmode="numeric">
                <input type="text" class="code-box" maxlength="1" inputmode="numeric">
            </div>
        </div>

        <button id="unlockBtn" class="unlock-btn">Unlock</button>
        <div id="errorMsg" class="error-message"></div>
        <div id="authInfo" class="auth-info">üí° Both users use the same code from Microsoft Authenticator</div>
    </div>
</div>

    <!-- MAIN APP -->
    <div id="mainApp">
        <header>
            <div class="container">
                <div class="header-top">
                    <div>
                        <h1 id="appTitle">üè† Chillinguito Lake Como</h1>
                        <p id="appSubtitle">Expense Tracker & Guest Manager</p>
                    </div>
                    
                    <div class="header-status">
                        <div id="syncStatusIndicator" class="sync-status-indicator">
                            <div class="sync-dot" id="syncDot"></div>
                            <span id="syncStatus">Syncing...</span>
                        </div>

                        <div id="dbStatusIndicator" class="status-badge">
                            <span class="status-dot" id="dbStatusDot"></span>
                            <span id="dbStatus">DB Connected</span>
                        </div>

                        <div id="otherUserStatusIndicator" class="status-badge">
                            <span class="status-dot" id="otherUserDot"></span>
                            <span id="otherUserStatus">Mattia online</span>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <div class="user-badge" id="userBadge">
                            <span id="userIcon">üë®</span>
                            <span id="userName">Davide</span>
                        </div>
                        <button class="lang-btn active" onclick="setLanguage('en')" id="langEnBtn">üá¨üáß EN</button>
                        <button class="lang-btn" onclick="setLanguage('it')" id="langItBtn">üáÆüáπ IT</button>
                        <button class="theme-btn" onclick="toggleTheme()">üåô</button>
                        <button class="logout-btn" onclick="logout()" id="logoutBtn">üîí Logout</button>
                    </div>
                </div>
            </div>
        </header>

        <div class="container">
            <div id="notificationContainer"></div>

            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('add-expense')" id="tabAddExpense">Add Expense</button>
                <button class="tab-btn" onclick="switchTab('expenses-list')" id="tabExpensesList">All Expenses</button>
                <button class="tab-btn" onclick="switchTab('settlement')" id="tabSettlement">Settlement</button>
                <button class="tab-btn" onclick="switchTab('guests')" id="tabGuests">üë• Guests</button>
                <button class="tab-btn" onclick="switchTab('calendar')" id="tabCalendar">Calendar</button>
                <button class="tab-btn" onclick="switchTab('export')" id="tabExport">Export</button>
            </div>

            <!-- ADD EXPENSE TAB -->
            <div id="add-expense" class="tab-content active">
                <div class="card">
                    <h2 id="addExpenseTitle" style="margin-bottom: 20px;">Add New Expense</h2>
                    <form onsubmit="addExpense(event)">
                        <div class="form-group">
                            <label for="description" id="descLabel">Description</label>
                            <input type="text" id="description" placeholder="e.g., Cleaning supplies, Groceries" required>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="amount" id="amountLabel">Amount (EUR)</label>
                                <input type="number" id="amount" placeholder="0.00" step="0.01" min="0" required>
                            </div>
                            <div class="form-group">
                                <label for="category" id="categoryLabel">Category</label>
                                <select id="category" required>
                                    <option value=""></option>
                                    <option value="Cleaning" id="catCleaning">Cleaning & Maintenance</option>
                                    <option value="Utilities" id="catUtilities">Utilities (Water, Gas, Electric)</option>
                                    <option value="Groceries" id="catGroceries">Groceries & Food</option>
                                    <option value="Repairs" id="catRepairs">Repairs & Equipment</option>
                                    <option value="Other" id="catOther">Other</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="paidBy" id="paidByLabel">Paid By</label>
                                <select id="paidBy" required>
                                    <option value=""></option>
                                    <option value="Davide">Davide</option>
                                    <option value="Mattia">Mattia</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="splitBetween" id="splitLabel">Split Between</label>
                                <select id="splitBetween" required>
                                    <option value=""></option>
                                    <option value="Both" id="splitBoth">Both (50/50)</option>
                                    <option value="Davide" id="splitDavide">Davide Only</option>
                                    <option value="Mattia" id="splitMattia">Mattia Only</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="date" id="dateLabel">Date</label>
                            <input type="date" id="date" required style="width: 100%;">
                        </div>

                        <div class="form-group">
                            <label for="notes" id="notesLabel">Notes (optional)</label>
                            <textarea id="notes" placeholder="Add notes..." rows="3"></textarea>
                        </div>

                        <div class="form-group">
                            <button type="button" class="camera-btn" onclick="openCamera()" id="cameraBtn">üì∑ Take Receipt Photo</button>
                            <input type="file" id="cameraInput" accept="image/" capture="environment" onchange="handleCameraCapture()">
                            <div id="receiptPreview" style="margin-top: 10px;"></div>
                        </div>

                        <button type="submit" class="btn-primary" id="addExpenseBtn" style="width: 100%; padding: 12px;">Add Expense</button>
                    </form>
                </div>
            </div>

            <!-- EXPENSES LIST TAB -->
            <div id="expenses-list" class="tab-content">
                <div class="filter-section">
                    <div class="filter-input">
                        <input type="text" id="searchInput" placeholder="Search by description..." onkeyup="filterExpenses()">
                    </div>
                    <div class="filter-input">
                        <select id="filterCategory" onchange="filterExpenses()">
                            <option value="">All Categories</option>
                            <option value="Cleaning">Cleaning</option>
                            <option value="Utilities">Utilities</option>
                            <option value="Groceries">Groceries</option>
                            <option value="Repairs">Repairs</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="filter-input">
                        <select id="filterMonth" onchange="filterExpenses()">
                            <option value="">All Months</option>
                        </select>
                    </div>
                    <div class="filter-input">
                        <select id="filterYear" onchange="filterExpenses()">
                            <option value="">All Years</option>
                        </select>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h2 id="allExpensesTitle">All Expenses</h2>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn-secondary" onclick="clearAllExpenses()" id="clearAllBtn" style="color: var(--danger);">Clear All</button>
                        </div>
                    </div>
                    <div id="expensesList"></div>
                </div>
            </div>

            <!-- SETTLEMENT TAB -->
            <div id="settlement" class="tab-content">
                <div class="settlement-summary">
                    <div class="settlement-banner" id="settlementBanner"></div>
                    
                    <div class="summary-title" id="settlementTitle">Current Settlement Status</div>
                    
                    <div class="stats">
                        <div class="stat-box-large">
                            <div class="stat-label" id="totalLabel">Total Expenses</div>
                            <div class="stat-value" id="totalExpenses">EUR 0.00</div>
                        </div>
                    </div>

                    <div class="stats-secondary">
                        <div class="stat-box">
                            <div class="stat-label" id="davidePaidLabel">Davide Paid</div>
                            <div class="stat-value" id="davidePaid">EUR 0.00</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label" id="mattiaPaidLabel">Mattia Paid</div>
                            <div class="stat-value" id="mattiaPaid">EUR 0.00</div>
                        </div>
                    </div>

                    <div style="margin-top: 20px;">
                        <h3 id="whoOwesLabel" style="margin-bottom: 15px; color: var(--primary);">üí∏ Who Owes Whom</h3>
                        <div id="settlementDetails"></div>
                    </div>

                    <div class="settlement-payments">
                        <h4 id="recordPaymentLabel" style="margin-bottom: 15px; color: var(--primary);">üí∞ Record Partial Payment</h4>
                        
                        <div id="progressContainer">
                            <div style="margin-bottom: 8px; display: flex; justify-content: space-between; font-size: 12px; color: var(--text-secondary);">
                                <span id="progressLabel">Payment Progress</span>
                                <span id="progressPercent">0%</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                            </div>
                        </div>

                        <div class="payment-input-group">
                            <input type="number" id="paymentAmount" placeholder="Amount (EUR)" step="0.01" min="0">
                            <select id="paymentFrom" style="flex: 1; min-width: 120px;">
                                <option value="davide" id="davidePayOpt">Davide pays</option>
                                <option value="mattia" id="mattiaPayOpt">Mattia pays</option>
                            </select>
                            <button type="button" class="btn-primary" onclick="recordPayment()" id="recordPaymentBtn" style="flex-shrink: 0;">Record</button>
                        </div>
                        <div id="paymentHistory" class="payment-history"></div>
                    </div>
                </div>
            </div>

            <!-- GUESTS TAB -->
            <div id="guests" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2 id="guestsTitle">üë• Guests Management</h2>
                        <button class="btn-primary" onclick="openAddGuestModal()" id="addGuestBtn">‚ûï Add Guest</button>
                    </div>

                    <div class="filter-section">
                        <div class="filter-input">
                            <input type="text" id="guestSearchInput" placeholder="Search by guest name..." onkeyup="filterGuests()">
                        </div>
                        <div class="filter-input">
                            <input type="date" id="guestDateFilter" onchange="filterGuests()">
                        </div>
                        <div class="filter-input">
                            <select id="guestStatusFilter" onchange="filterGuests()">
                                <option value="">All Status</option>
                                <option value="upcoming">Upcoming</option>
                                <option value="current">Current</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                    </div>

                    <div id="guestsList"></div>
                </div>
            </div>

            <!-- CALENDAR TAB -->
            <div id="calendar" class="tab-content">
                <div class="calendar-container">
                    <div class="calendar-header">
                        <h2 id="calendarTitle">Airbnb Calendar</h2>
                        <div class="calendar-nav">
                            <button onclick="previousMonth()" id="prevBtn">Previous</button>
                            <span id="currentMonth" style="padding: 0 20px; font-weight: 600; min-width: 150px; text-align: center;"></span>
                            <button onclick="nextMonth()" id="nextBtn">Next</button>
                        </div>
                    </div>

                    <div class="calendar-weekdays">
                        <div class="weekday" id="weekdaySun">Sun</div>
                        <div class="weekday" id="weekdayMon">Mon</div>
                        <div class="weekday" id="weekdayTue">Tue</div>
                        <div class="weekday" id="weekdayWed">Wed</div>
                        <div class="weekday" id="weekdayThu">Thu</div>
                        <div class="weekday" id="weekdayFri">Fri</div>
                        <div class="weekday" id="weekdaySat">Sat</div>
                    </div>

                    <div id="calendarDays" class="calendar-days"></div>
                </div>
            </div>

            <!-- EXPORT TAB -->
            <div id="export" class="tab-content">
                <div class="export-section">
                    <h2 id="exportTitle" style="margin-bottom: 20px;">Monthly Summary & Export</h2>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 id="expensePeriodLabel" style="margin-bottom: 10px;">Expense Period</h4>
                        <select id="expensePeriod" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 15px;">
                            <option value="1">Current Month</option>
                            <option value="3">Last 3 Months</option>
                            <option value="6">Last 6 Months</option>
                            <option value="9">Last 9 Months</option>
                            <option value="12">Last 12 Months</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h4 id="cleaningPeriodLabel" style="margin-bottom: 10px;">Cleaning Dates Period</h4>
                        <select id="cleaningPeriod" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 15px;">
                            <option value="1">Current Month</option>
                            <option value="3">Next 3 Months</option>
                            <option value="6">Next 6 Months</option>
                            <option value="9">Next 9 Months</option>
                            <option value="12">Next 12 Months</option>
                        </select>
                    </div>

                    <button class="btn-primary" id="downloadReportBtn" style="width: 100%; margin-top: 20px; font-size: 18px;" onclick="generateAndDownloadReport()">üìä Download Report</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modalContainer"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // ============ STATE ============
        const TOTP_SECRET = 'JBSWY3DPEHPK3PXP';
        let currentUser = null;
        let selectedUsername = null;
        let listenersSetup = false;
        let currentTheme = localStorage.getItem('theme') || 'light';
        let currentLanguage = localStorage.getItem('language') || 'en';
        let currentCalendarDate = new Date();
        let filteredExpenses = [];
        let filteredGuests = [];
        let receiptBase64 = null;
        let dbConnected = false;
        let otherUserOnline = false;
        let currentEditingGuestId = null;
        let guestPhotos = [];

        const firebaseConfig = {
            apiKey: "AIzaSyCwF7bvS12h3AM14gmAEKV16BjH4Bq6TWU",
            authDomain: "airbnb-expense-tracker-7f531.firebaseapp.com",
            databaseURL: "https://airbnb-expense-tracker-7f531-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "airbnb-expense-tracker-7f531",
            storageBucket: "airbnb-expense-tracker-7f531.firebasestorage.app",
            messagingSenderId: "466998817774",
            appId: "1:466998817774:web:f4b244ac7cfa1723dbd4ff"
        };

        let firebaseApp = null;
        let db = null;
        let isFirebaseReady = false;
        
 // ‚úÖ SHOW AUTH INSTANTLY - don't wait for Firebase
document.getElementById('authScreen').style.display = 'flex'
document.getElementById('mainApp').style.display = 'none'

// ‚úÖ Initialize Firebase in BACKGROUND - non-blocking
setTimeout(() => {
  try {
    firebaseApp = firebase.initializeApp(firebaseConfig)
    db = firebase.database()
    isFirebaseReady = true
    console.log('‚úÖ Firebase ready')
  } catch (e) {
    console.warn('‚ö†Ô∏è Firebase offline', e.message)
  }
}, 0)

// Force ready after 5 seconds max (for slow networks)
setTimeout(() => {
  isFirebaseReady = true
  console.log('‚è±Ô∏è Forcing Firebase ready after timeout')
}, 5000)     

        // ============ TRANSLATIONS ============
        const translations = {
    en: {
        authTitle: "Chillinguito",
        authSubtitle: "Select your account & enter 2FA code",
        authCodeLabel: "Enter 6-digit code:",
        unlockBtn: "Unlock",
        authInfo: "üí° Both users use the same code from Microsoft Authenticator",
        appTitle: "üè† Chillinguito Lake Como",
        appSubtitle: "Expense Tracker & Guest Manager",
        langEnBtn: "üá¨üáß EN",
        langItBtn: "üáÆüáπ IT",
        logoutBtn: "üîí Logout",
        tabAddExpense: "Add Expense",
        tabExpensesList: "All Expenses",
        tabSettlement: "Settlement",
        tabGuests: "üë• Guests",
        tabCalendar: "Calendar",
        tabExport: "Export",
        addExpenseTitle: "Add New Expense",
        descLabel: "Description",
        amountLabel: "Amount (EUR)",
        categoryLabel: "Category",
        paidByLabel: "Paid By",
        splitLabel: "Split Between",
        dateLabel: "Date",
        notesLabel: "Notes (optional)",
        cameraBtn: "üì∑ Take Receipt Photo",
        addExpenseBtn: "Add Expense",
        catCleaning: "Cleaning & Maintenance",
        catUtilities: "Utilities (Water, Gas, Electric)",
        catGroceries: "Groceries & Food",
        catRepairs: "Repairs & Equipment",
        catOther: "Other",
        splitBoth: "Both (50/50)",
        splitDavide: "Davide Only",
        splitMattia: "Mattia Only",
        allExpensesTitle: "All Expenses",
        clearAllBtn: "Clear All",
        settlementTitle: "Current Settlement Status",
        totalLabel: "Total Expenses",
        davidePaidLabel: "Davide Paid",
        mattiaPaidLabel: "Mattia Paid",
        whoOwesLabel: "üí∏ Who Owes Whom",
        recordPaymentLabel: "üí∞ Record Partial Payment",
        recordPaymentBtn: "Record",
        davidePayOpt: "Davide pays",
        mattiaPayOpt: "Mattia pays",
        guestsTitle: "üë• Guests Management",
        addGuestBtn: "‚ûï Add Guest",
        checkIn: "Check-in Date",
        checkOut: "Check-out Date",
        guestNotes: "Special Notes & Requirements",
        addDocuments: "üìÅ Add Documents",
        saveGuest: "Save Guest",
        editGuest: "Edit Guest",
        deleteGuest: "Delete Guest",
        guestAdded: "‚úÖ Guest added successfully",
        guestDeleted: "üóëÔ∏è Guest deleted",
        documentAdded: "‚úÖ Document added",
        upcoming: "Upcoming",
        current: "Current",
        completed: "Completed",
        noGuests: "No guests found",
        clearHistoryConfirm: "‚ö†Ô∏è Delete ALL expenses and payments? This cannot be undone!",
        historyCleared: "üóëÔ∏è All history cleared",
        guestPhotos: "Guest Photos",
        addPhotos: "üì∏ Add Photos",
        touristTaxSection: "Tourist Tax (Como Decree)",
        touristTaxAmount: "Tourist tax amount",
        touristTaxPaid: "Paid",
        calendarTitle: "Airbnb Calendar",
        prevBtn: "Previous",
        nextBtn: "Next",
        exportTitle: "Monthly Summary & Export",
        expensePeriodLabel: "Expense Period",
        cleaningPeriodLabel: "Cleaning Dates Period",
        downloadReportBtn: "üìä Download Report",
        addedNotif: "‚úÖ Expense added",
        deletedNotif: "üóëÔ∏è Expense deleted",
        allSettledMsg: "‚úÖ All settled!",
        owesMsg: "{person} owes {other}: EUR {amount}",
        noExpenses: "No expenses found"
    },
    it: {
        authTitle: "Chillinguito",
        authSubtitle: "Seleziona il tuo account e inserisci il codice 2FA",
        authCodeLabel: "Inserisci codice a 6 cifre:",
        unlockBtn: "Sblocca",
        authInfo: "üí° Entrambi gli utenti usano lo stesso codice da Microsoft Authenticator",
        appTitle: "üè† Chillinguito Lake Como",
        appSubtitle: "Tracker Spese e Gestore Ospiti",
        langEnBtn: "üá¨üáß EN",
        langItBtn: "üáÆüáπ IT",
        logoutBtn: "üîí Esci",
        tabAddExpense: "Aggiungi Spesa",
        tabExpensesList: "Tutte le Spese",
        tabSettlement: "Saldo",
        tabGuests: "üë• Ospiti",
        tabCalendar: "Calendario",
        tabExport: "Esporta",
        addExpenseTitle: "Aggiungi Nuova Spesa",
        descLabel: "Descrizione",
        amountLabel: "Importo (EUR)",
        categoryLabel: "Categoria",
        paidByLabel: "Pagato Da",
        splitLabel: "Dividi Tra",
        dateLabel: "Data",
        notesLabel: "Note (opzionale)",
        cameraBtn: "üì∑ Scatta Foto Ricevuta",
        addExpenseBtn: "Aggiungi Spesa",
        catCleaning: "Pulizia e Manutenzione",
        catUtilities: "Utenze (Acqua, Gas, Elettricit√†)",
        catGroceries: "Alimentari e Cibo",
        catRepairs: "Riparazioni e Attrezzature",
        catOther: "Altro",
        splitBoth: "Entrambi (50/50)",
        splitDavide: "Solo Davide",
        splitMattia: "Solo Mattia",
        allExpensesTitle: "Tutte le Spese",
        clearAllBtn: "Cancella Tutto",
        settlementTitle: "Stato Saldo Attuale",
        totalLabel: "Spese Totali",
        davidePaidLabel: "Davide ha Pagato",
        mattiaPaidLabel: "Mattia ha Pagato",
        whoOwesLabel: "üí∏ Chi Deve a Chi",
        recordPaymentLabel: "üí∞ Registra Pagamento Parziale",
        recordPaymentBtn: "Registra",
        davidePayOpt: "Davide paga",
        mattiaPayOpt: "Mattia paga",
        guestsTitle: "üë• Gestione Ospiti",
        addGuestBtn: "‚ûï Aggiungi Ospite",
        checkIn: "Data Check-in",
        checkOut: "Data Check-out",
        guestNotes: "Note Speciali & Esigenze",
        addDocuments: "üìÅ Aggiungi Documenti",
        saveGuest: "Salva Ospite",
        editGuest: "Modifica Ospite",
        deleteGuest: "Elimina Ospite",
        guestAdded: "‚úÖ Ospite aggiunto con successo",
        guestDeleted: "üóëÔ∏è Ospite eliminato",
        documentAdded: "‚úÖ Documento aggiunto",
        upcoming: "Imminente",
        current: "Attuale",
        completed: "Completato",
        noGuests: "Nessun ospite trovato",
        clearHistoryConfirm: "‚ö†Ô∏è Eliminare TUTTE le spese e i pagamenti? Non √® possibile annullare!",
        historyCleared: "üóëÔ∏è Tutto lo storico cancellato",
        guestPhotos: "Foto Ospiti",
        addPhotos: "üì∏ Aggiungi Foto",
        touristTaxSection: "Imposta Turistica (Decreto Como)",
        touristTaxAmount: "Importo imposta turistica",
        touristTaxPaid: "Pagata",
        calendarTitle: "Calendario Airbnb",
        prevBtn: "Precedente",
        nextBtn: "Successivo",
        exportTitle: "Riepilogo Mensile & Esporta",
        expensePeriodLabel: "Periodo Spese",
        cleaningPeriodLabel: "Periodo Date Pulizia",
        downloadReportBtn: "üìä Scarica Report",
        addedNotif: "‚úÖ Spesa aggiunta",
        deletedNotif: "üóëÔ∏è Spesa eliminata",
        allSettledMsg: "‚úÖ Tutto pagato!",
        owesMsg: "{person} deve a {other}: EUR {amount}",
        noExpenses: "Nessuna spesa trovata"
    }
};

        // ============ HELPER FUNCTIONS ============
        function computeTouristTax(guest) {
            const persons = 1 + (guest.accompanied || 0);
            const checkIn = new Date(guest.checkIn);
            const checkOut = new Date(guest.checkOut);
            const msPerDay = 24 * 60 * 60 * 1000;
            let nights = Math.ceil((checkOut - checkIn) / msPerDay);
            if (isNaN(nights) || nights < 0) nights = 0;
            nights = Math.min(nights, 4);
            const tax = persons * nights * 3;
            return { tax, nights, persons };
        }

        function updateTouristTaxPreview() {
            const guestTemp = {
                accompanied: parseInt(document.getElementById('guestAccompanied').value) || 0,
                checkIn: document.getElementById('guestCheckIn').value,
                checkOut: document.getElementById('guestCheckOut').value
            };
            const { tax } = computeTouristTax(guestTemp);
            const el = document.getElementById('touristTaxAmount');
            if (el) el.value = `EUR ${tax.toFixed(2)}`;
        }

        // ============ TRANSLATIONS UPDATE ============
        function updateTranslations() {
            const t = translations[currentLanguage];
            
            // Auth screen elements
            const authTitle = document.getElementById('authTitle');
            const authSubtitle = document.getElementById('authSubtitle');
            const authCodeLabel = document.getElementById('authCodeLabel');
            const authInfo = document.getElementById('authInfo');
            const unlockBtn = document.querySelector('.unlock-btn');
            
            if (authTitle) authTitle.textContent = t.authTitle;
            if (authSubtitle) authSubtitle.textContent = t.authSubtitle;
            if (authCodeLabel) authCodeLabel.textContent = t.authCodeLabel;
            if (authInfo) authInfo.textContent = t.authInfo;
            if (unlockBtn) unlockBtn.textContent = t.unlockBtn;
            
            // Main app header
            const appTitle = document.getElementById('appTitle');
            const appSubtitle = document.getElementById('appSubtitle');
            const logoutBtn = document.getElementById('logoutBtn');
            
            if (appTitle) appTitle.textContent = t.appTitle;
            if (appSubtitle) appSubtitle.textContent = t.appSubtitle;
            if (logoutBtn) logoutBtn.textContent = t.logoutBtn;
            
            // Tabs
            const tabAddExpense = document.getElementById('tabAddExpense');
            const tabExpensesList = document.getElementById('tabExpensesList');
            const tabSettlement = document.getElementById('tabSettlement');
            const tabGuests = document.getElementById('tabGuests');
            const tabCalendar = document.getElementById('tabCalendar');
            const tabExport = document.getElementById('tabExport');
            
            if (tabAddExpense) tabAddExpense.textContent = t.tabAddExpense;
            if (tabExpensesList) tabExpensesList.textContent = t.tabExpensesList;
            if (tabSettlement) tabSettlement.textContent = t.tabSettlement;
            if (tabGuests) tabGuests.textContent = t.tabGuests;
            if (tabCalendar) tabCalendar.textContent = t.tabCalendar;
            if (tabExport) tabExport.textContent = t.tabExport;
        }
        

        function showNotification(msg) {
            const container = document.getElementById('notificationContainer');
            const div = document.createElement('div');
            div.className = 'notification-banner';
            if (msg.includes('‚ö†Ô∏è')) div.classList.add('warning');
            if (msg.includes('‚ùå')) div.classList.add('error');
            div.textContent = msg;
            container.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        function showSync() {
            const badge = document.getElementById('syncStatusIndicator');
            const dot = document.getElementById('syncDot');
            badge.style.display = 'flex';
            dot.classList.add('syncing');
        }

        function hideSync() {
            const badge = document.getElementById('syncStatusIndicator');
            const dot = document.getElementById('syncDot');
            dot.classList.remove('syncing');
            setTimeout(() => {
                badge.style.display = 'none';
            }, 1500);
        }

        // ============ FIREBASE DATA FUNCTIONS ============
        function getExpenses() {
            const data = localStorage.getItem('expenses_shared');
            return data ? JSON.parse(data) : [];
        }

        async function saveExpenses(expenses) {
            localStorage.setItem('expenses_shared', JSON.stringify(expenses));
            if (isFirebaseReady) {
                showSync();
                try {
                    await db.ref('shared/expenses').set(expenses);
                    console.log('‚úÖ Expenses synced to Firebase');
                    hideSync();
                } catch (error) {
                    console.error('‚ùå Firebase error:', error);
                }
            }
            displayExpenses();
            displaySettlement();
        }

        function getPayments() {
            const data = localStorage.getItem('payments_shared');
            return data ? JSON.parse(data) : [];
        }

        async function savePayments(payments) {
            localStorage.setItem('payments_shared', JSON.stringify(payments));
            if (isFirebaseReady) {
                showSync();
                try {
                    await db.ref('shared/payments').set(payments);
                    console.log('‚úÖ Payments synced to Firebase');
                    hideSync();
                } catch (error) {
                    console.error('‚ùå Firebase error:', error);
                }
            }
        }

        function getGuests() {
            const data = localStorage.getItem('guests_shared');
            return data ? JSON.parse(data) : [];
        }

        async function saveGuests(guests) {
            localStorage.setItem('guests_shared', JSON.stringify(guests));
            if (isFirebaseReady) {
                showSync();
                try {
                    await db.ref('shared/guests').set(guests);
                    console.log('‚úÖ Guests synced to Firebase');
                    hideSync();
                } catch (error) {
                    console.error('‚ùå Firebase error:', error);
                }
            }
            displayGuests();
        }

        function getCalendarData() {
            const data = localStorage.getItem('calendar_shared');
            return data ? JSON.parse(data) : {};
        }

        async function saveCalendarData(calendar) {
            localStorage.setItem('calendar_shared', JSON.stringify(calendar));
            if (isFirebaseReady) {
                showSync();
                try {
                    await db.ref('shared/calendar').set(calendar);
                    console.log('‚úÖ Calendar synced to Firebase');
                    hideSync();
                } catch (error) {
                    console.error('‚ùå Firebase error:', error);
                }
            }
            renderCalendar();
        }

        // ============ SETTLEMENT FUNCTIONS (v7 FIXED) ============
        function displaySettlement() {
            const expenses = getExpenses();
            const payments = getPayments();
            const balances = { Davide: 0, Mattia: 0 };
            let total = 0;

            // 1) Base balances from expenses
            expenses.forEach(exp => {
                const amount = exp.amount;
                total += amount;

                if (exp.paidBy === 'Davide') balances.Davide += amount;
                else if (exp.paidBy === 'Mattia') balances.Mattia += amount;

                if (exp.splitBetween === 'Both') {
                    balances.Davide -= amount / 2;
                    balances.Mattia -= amount / 2;
                } else if (exp.splitBetween === 'Davide') {
                    balances.Davide -= amount;
                } else if (exp.splitBetween === 'Mattia') {
                    balances.Mattia -= amount;
                }
            });

            // 2) APPLY PAYMENTS (FIXED)
            payments.forEach(p => {
                if (p.from === 'davide') {
                    balances.Davide += p.amount;
                    balances.Mattia -= p.amount;
                } else if (p.from === 'mattia') {
                    balances.Mattia += p.amount;
                    balances.Davide -= p.amount;
                }
            });

            document.getElementById('totalExpenses').textContent = `EUR ${total.toFixed(2)}`;

            let davidePaid = 0, mattiaPaid = 0;
            expenses.forEach(exp => {
                if (exp.paidBy === 'Davide') davidePaid += exp.amount;
                if (exp.paidBy === 'Mattia') mattiaPaid += exp.amount;
            });
            document.getElementById('davidePaid').textContent = `EUR ${davidePaid.toFixed(2)}`;
            document.getElementById('mattiaPaid').textContent = `EUR ${mattiaPaid.toFixed(2)}`;

            const banner = document.getElementById('settlementBanner');
            const detailsDiv = document.getElementById('settlementDetails');
            const progressContainer = document.getElementById('progressContainer');
            const t = translations[currentLanguage];

            if (total === 0) {
                banner.style.display = 'none';
                progressContainer.style.display = 'none';
                detailsDiv.innerHTML = '<div class="no-data">' + (currentLanguage === 'en' ? 'No expenses yet' : 'Nessuna spesa ancora') + '</div>';
                return;
            }

            banner.style.display = 'block';

            if (Math.abs(balances.Davide) < 0.01 && Math.abs(balances.Mattia) < 0.01) {
                banner.className = 'settlement-banner paid';
                banner.textContent = t.allSettledMsg;
                detailsDiv.innerHTML = '<div class="settlement-box" style="background:rgba(76,175,80,0.1);color:#2e7d32;border:none;">' + t.allSettledMsg + '</div>';
                progressContainer.style.display = 'none';
                document.getElementById('paymentFrom').innerHTML =
                    `<option value="davide">${t.davidePayOpt}</option><option value="mattia">${t.mattiaPayOpt}</option>`;
                return;
            }

            let debtor = null;
            let amountOwed = 0;

            if (balances.Davide < -0.01) {
                debtor = 'davide';
                amountOwed = Math.abs(balances.Davide);
                banner.className = 'settlement-banner owed';
                banner.textContent = `Davide ${currentLanguage === 'en' ? 'still owes' : 'deve ancora'} Mattia: EUR ${amountOwed.toFixed(2)}`;
                detailsDiv.innerHTML = `<div class="settlement-box owed">üí≥ Davide ${currentLanguage === 'en' ? 'still owes' : 'deve ancora'} Mattia: <strong>EUR ${amountOwed.toFixed(2)}</strong></div>`;
                document.getElementById('paymentFrom').innerHTML = `<option value="davide">${t.davidePayOpt}</option>`;
            } else if (balances.Mattia < -0.01) {
                debtor = 'mattia';
                amountOwed = Math.abs(balances.Mattia);
                banner.className = 'settlement-banner owed';
                banner.textContent = `Mattia ${currentLanguage === 'en' ? 'still owes' : 'deve ancora'} Davide: EUR ${amountOwed.toFixed(2)}`;
                detailsDiv.innerHTML = `<div class="settlement-box owed">üí≥ Mattia ${currentLanguage === 'en' ? 'still owes' : 'deve ancora'} Davide: <strong>EUR ${amountOwed.toFixed(2)}</strong></div>`;
                document.getElementById('paymentFrom').innerHTML = `<option value="mattia">${t.mattiaPayOpt}</option>`;
            }

            if (debtor) {
                progressContainer.style.display = 'block';
                updateProgressBar(amountOwed, debtor);
            } else {
                progressContainer.style.display = 'none';
            }
        }

        function updateProgressBar(amount, debtor) {
            const total = getExpenses().reduce((sum, e) => sum + e.amount, 0);
            const paid = getPayments().reduce((sum, p) => p.from === debtor ? sum + p.amount : sum, 0);
            const percent = Math.min((paid / amount) * 100, 100);
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressPercent').textContent = Math.round(percent) + '%';
        }

        function recordPayment() {
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const from = document.getElementById('paymentFrom').value;
            const t = translations[currentLanguage];

            if (!amount || amount <= 0) {
                showNotification('‚ùå Enter amount');
                return;
            }

            let payments = getPayments();
            payments.push({ from, amount, date: new Date().toISOString() });
            savePayments(payments);
            document.getElementById('paymentAmount').value = '';
            showNotification(t.paymentRecordedNotif);
            displaySettlement();
        }

        function addExpense(event) {
            event.preventDefault();
            const t = translations[currentLanguage];

            const expense = {
                id: Date.now(),
                description: document.getElementById('description').value,
                amount: parseFloat(document.getElementById('amount').value),
                category: document.getElementById('category').value,
                paidBy: document.getElementById('paidBy').value,
                splitBetween: document.getElementById('splitBetween').value,
                date: document.getElementById('date').value,
                notes: document.getElementById('notes').value,
                receipt: receiptBase64 || null,
                addedBy: currentUser
            };

            let expenses = getExpenses();
            expenses.push(expense);
            saveExpenses(expenses);

            document.getElementById('description').value = '';
            document.getElementById('amount').value = '';
            document.getElementById('category').value = '';
            document.getElementById('paidBy').value = '';
            document.getElementById('splitBetween').value = '';
            document.getElementById('date').value = '';
            document.getElementById('notes').value = '';
            document.getElementById('receiptPreview').innerHTML = '';
            receiptBase64 = null;

            showNotification(t.addedNotif);
        }

        function displayExpenses() {
            const expenses = getExpenses();
            const listDiv = document.getElementById('expensesList');

            if (expenses.length === 0) {
                listDiv.innerHTML = '<div class="no-data">' + translations[currentLanguage].noExpenses + '</div>';
                return;
            }

            expenses.sort((a, b) => new Date(b.date) - new Date(a.date));
            listDiv.innerHTML = expenses.map(exp => `
                <div class="expense-item">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div class="expense-info">
                            <div class="expense-description">${exp.description}</div>
                            <div class="expense-details">
                                <span class="category-badge">${exp.category}</span>
                                ${new Date(exp.date).toLocaleDateString()} ‚Ä¢ ${exp.paidBy} paid, split ${exp.splitBetween}<span class="user-badge-inline">${exp.addedBy}</span>
                            </div>
                        </div>
                        <div class="expense-amount">EUR ${exp.amount.toFixed(2)}</div>
                    </div>
                    ${exp.receipt ? `<div class="expense-receipt"><img src="${exp.receipt}" alt="Receipt"></div>` : ''}
                    <div style="margin-top: 12px;">
                        <button class="btn-danger" onclick="deleteExpense(${exp.id})" style="width: 100%; padding: 8px;">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function deleteExpense(id) {
            if (confirm('Delete this expense?')) {
                let expenses = getExpenses();
                expenses = expenses.filter(e => e.id !== id);
                saveExpenses(expenses);
                showNotification(translations[currentLanguage].deletedNotif);
            }
        }

        function clearAllExpenses() {
            if (confirm(translations[currentLanguage].clearHistoryConfirm)) {
                localStorage.removeItem('expenses_shared');
                localStorage.removeItem('payments_shared');
                displayExpenses();
                displaySettlement();
                showNotification(translations[currentLanguage].historyCleared);
            }
        }

        function filterExpenses() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const category = document.getElementById('filterCategory').value;
            const month = document.getElementById('filterMonth').value;
            const year = document.getElementById('filterYear').value;

            const expenses = getExpenses();
            filteredExpenses = expenses.filter(exp => {
                const matchesSearch = exp.description.toLowerCase().includes(searchText);
                const matchesCategory = !category || exp.category === category;
                const expDate = new Date(exp.date);
                const matchesMonth = !month || (expDate.getMonth() + 1).toString() === month;
                const matchesYear = !year || expDate.getFullYear().toString() === year;

                return matchesSearch && matchesCategory && matchesMonth && matchesYear;
            });

            document.getElementById('expensesList').innerHTML = filteredExpenses.length === 0
                ? '<div class="no-data">' + translations[currentLanguage].noExpenses + '</div>'
                : filteredExpenses.map(exp => `
                    <div class="expense-item">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div class="expense-info">
                                <div class="expense-description">${exp.description}</div>
                                <div class="expense-details">
                                    <span class="category-badge">${exp.category}</span>
                                    ${new Date(exp.date).toLocaleDateString()} ‚Ä¢ ${exp.paidBy} paid, split ${exp.splitBetween}
                                </div>
                            </div>
                            <div class="expense-amount">EUR ${exp.amount.toFixed(2)}</div>
                        </div>
                        ${exp.receipt ? `<div class="expense-receipt"><img src="${exp.receipt}" alt="Receipt"></div>` : ''}
                        <div style="margin-top: 12px;">
                            <button class="btn-danger" onclick="deleteExpense(${exp.id})" style="width: 100%; padding: 8px;">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `).join('');
        }

        function populateMonthYearFilters() {
            const expenses = getExpenses();
            const months = new Set();
            const years = new Set();

            expenses.forEach(exp => {
                const date = new Date(exp.date);
                months.add(date.getMonth() + 1);
                years.add(date.getFullYear());
            });

            const monthSelect = document.getElementById('filterMonth');
            const yearSelect = document.getElementById('filterYear');

            monthSelect.innerHTML = '<option value="">All Months</option>' +
                Array.from(months).sort().map(m => `<option value="${m}">${new Date(2000, m - 1).toLocaleString('en-US', {month: 'long'})}</option>`).join('');

            yearSelect.innerHTML = '<option value="">All Years</option>' +
                Array.from(years).sort().map(y => `<option value="${y}">${y}</option>`).join('');
        }

        // ============ CAMERA FUNCTIONS ============
        function openCamera() {
            document.getElementById('cameraInput').click();
        }

        function handleCameraCapture() {
            const file = document.getElementById('cameraInput').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    receiptBase64 = e.target.result;
                    document.getElementById('receiptPreview').innerHTML = `<img src="${receiptBase64}" style="max-width: 200px; border-radius: 6px;">`;
                };
                reader.readAsDataURL(file);
            }
        }

        // ============ CALENDAR AUTO-FILL (v10 NEW) ============
        function markGuestDatesOnCalendar(guest) {
            const calendar = getCalendarData();
            const checkIn = new Date(guest.checkIn);
            const checkOut = new Date(guest.checkOut);
           
            // Mark each night as occupied (from checkin to day before checkout)
            let currentDate = new Date(checkIn);
            while (currentDate < checkOut) {
               const dateStr = currentDate.toISOString().split('T')[0];
               calendar[dateStr] = 'occupied';
               currentDate.setDate(currentDate.getDate() + 1);
           }
           
            // Save and refresh calendar
            saveCalendarData(calendar);
        }

        // ============ CALENDAR CLEANUP (v11 NEW) ============
        function unmarkGuestDatesOnCalendar(guest) {
            const calendar = getCalendarData();
            const checkIn = new Date(guest.checkIn);
            const checkOut = new Date(guest.checkOut);
            
            // Remove occupancy for each night (from checkin to day before checkout)
            let currentDate = new Date(checkIn);
            while (currentDate < checkOut) {
                const dateStr = currentDate.toISOString().split('T')[0];
                // Delete the occupied status, making it available
                delete calendar[dateStr];
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // Save and refresh calendar
            saveCalendarData(calendar);
        }

        // ============ GUEST FUNCTIONS ============
        function openAddGuestModal() {
            currentEditingGuestId = null;
            guestPhotos = [];
            const t = translations[currentLanguage];
            const guest = {};
            
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.id = 'addGuestModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>${t.addGuestBtn}</h3>
                        <button class="modal-close" onclick="closeModal()">√ó</button>
                    </div>
                    <form onsubmit="saveGuest(event)">
                        <div class="form-group">
                            <label>${t.guestName}</label>
                            <input type="text" id="guestName" required placeholder="Full name">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>${t.guestEmail}</label>
                                <input type="email" id="guestEmail" placeholder="email@example.com">
                            </div>
                            <div class="form-group">
                                <label>${t.guestPhone}</label>
                                <input type="tel" id="guestPhone" placeholder="+39 xxx xxx xxxx">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>${t.checkIn}</label>
                                <input type="date" id="guestCheckIn" required onchange="updateTouristTaxPreview()">
                            </div>
                            <div class="form-group">
                                <label>${t.checkOut}</label>
                                <input type="date" id="guestCheckOut" required onchange="updateTouristTaxPreview()">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>${t.guestAccompanied}</label>
                            <input type="number" id="guestAccompanied" placeholder="0" min="0" max="10" value="0" onchange="updateAccompaniedGuestsForm(); updateTouristTaxPreview();">
                        </div>

                        <div id="accompaniedGuestsContainer"></div>

                        <div class="form-group">
                            <label>${t.guestPhotos}</label>
                            <button type="button" class="camera-btn" onclick="openGuestPhotoGallery()">üì∏ ${t.addPhotos}</button>
                            <input type="file" id="guestPhotoInput" accept="image/*" multiple onchange="handleGuestPhotos()">
                            <div id="guestPhotoPreview" class="image-gallery"></div>
                        </div>

                        <div class="tourist-tax-section">
                            <h4>${t.touristTaxSection}</h4>
                            <div class="tourist-tax-row">
                                <div>
                                    <label>${t.touristTaxAmount}</label>
                                    <input type="text" id="touristTaxAmount" disabled>
                                </div>
                                <div class="tourist-tax-paid">
                                    <input type="checkbox" id="touristTaxPaid">
                                    <label style="margin: 0;">${t.touristTaxPaid}</label>
                                </div>
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">${t.touristTaxCalculation}</div>
                        </div>

                        <div class="form-group">
                            <label>${t.guestNotes}</label>
                            <textarea id="guestNotes" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn-primary" style="width: 100%;">${t.saveGuest}</button>
                        </div>
                    </form>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = '';
            document.getElementById('modalContainer').appendChild(modal);
            modal.onclick = (e) => {
                if (e.target === modal) closeModal();
            };

            updateAccompaniedGuestsForm();
            displayGuestPhotos();
            updateTouristTaxPreview();
            document.getElementById('touristTaxPaid').checked = guest.touristTaxPaid || false;

            // Populate accompanied guests
            if (guest.accompaniedGuests && guest.accompaniedGuests.length > 0) {
                guest.accompaniedGuests.forEach((ag, idx) => {
                    const nameField = document.getElementById(`accompaniedGuestName${idx}`);
                    const surnameField = document.getElementById(`accompaniedGuestSurname${idx}`);
                    if (nameField) nameField.value = ag.name;
                    if (surnameField) surnameField.value = ag.surname;
                });
            }
        }

        function updateAccompaniedGuestsForm() {
            const count = parseInt(document.getElementById('guestAccompanied').value) || 0;
            const container = document.getElementById('accompaniedGuestsContainer');
            const t = translations[currentLanguage];
            
            container.innerHTML = '';
            if (count > 0) {
                container.innerHTML = `<div class="accompanied-guests-section">
                    <h4>${t.accompaniedGuestsInfo}</h4>`;
                for (let i = 0; i < count; i++) {
                    container.innerHTML += `
                        <div class="guest-info-row">
                            <input type="text" id="accompaniedGuestName${i}" placeholder="${t.accompaniedGuestName}" value="">
                            <input type="text" id="accompaniedGuestSurname${i}" placeholder="${t.accompaniedGuestSurname}" value="">
                        </div>
                    `;
                }
                container.innerHTML += '</div>';
            }
        }

        function openGuestPhotoGallery() {
            document.getElementById('guestPhotoInput').click();
        }

        function handleGuestPhotos() {
            const files = document.getElementById('guestPhotoInput').files;
            guestPhotos = [];
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    guestPhotos.push(e.target.result);
                    displayGuestPhotos();
                };
                reader.readAsDataURL(file);
            });
        }

        function displayGuestPhotos() {
            const preview = document.getElementById('guestPhotoPreview');
            preview.innerHTML = guestPhotos.map((photo, idx) => `
                <div class="gallery-item">
                    <img src="${photo}" alt="Guest photo">
                    <button class="gallery-item-remove" onclick="removeLocalPhoto(${idx})">√ó</button>
                </div>
            `).join('');
        }

        function removeLocalPhoto(idx) {
            guestPhotos.splice(idx, 1);
            displayGuestPhotos();
        }

        function saveGuest(event) {
            event.preventDefault();
            const t = translations[currentLanguage];
            
            const guest = {
                id: currentEditingGuestId || Date.now(),
                name: document.getElementById('guestName').value,
                email: document.getElementById('guestEmail').value,
                phone: document.getElementById('guestPhone').value,
                checkIn: document.getElementById('guestCheckIn').value,
                checkOut: document.getElementById('guestCheckOut').value,
                accompanied: parseInt(document.getElementById('guestAccompanied').value) || 0,
                photos: guestPhotos,
                notes: document.getElementById('guestNotes').value,
                touristTaxPaid: document.getElementById('touristTaxPaid').checked,
                documents: {},
                accompaniedGuests: []
            };

            const count = parseInt(document.getElementById('guestAccompanied').value) || 0;
            for (let i = 0; i < count; i++) {
                const name = document.getElementById(`accompaniedGuestName${i}`).value;
                const surname = document.getElementById(`accompaniedGuestSurname${i}`).value;
                if (name || surname) {
                    guest.accompaniedGuests.push({ name, surname });
                }
            }

            let guests = getGuests();
            if (currentEditingGuestId) {
                const idx = guests.findIndex(g => g.id === currentEditingGuestId);
                if (idx !== -1) guests[idx] = guest;
            } else {
                guests.push(guest);
                // Mark calendar dates for new guest
                markGuestDatesOnCalendar(guest);
            }

            saveGuests(guests);
            closeModal();
            showNotification(t.guestAdded);
        }

        function deleteGuest(guestId) {
            if (confirm('Delete this guest?')) {
                // Get the guest BEFORE deleting (so we know which dates to free up)
                const guests = getGuests();
                const guestToDelete = guests.find(g => g.id === guestId);
                
                // Remove from guests list
                const updatedGuests = guests.filter(g => g.id !== guestId);
                
                // Clear calendar dates for this guest
                if (guestToDelete && guestToDelete.checkIn && guestToDelete.checkOut) {
                    unmarkGuestDatesOnCalendar(guestToDelete);
                }
                
                // Save updated guests
                saveGuests(updatedGuests);
                
                // Show notification
                const t = translations[currentLanguage];
                showNotification(t.guestDeleted);
            }
        }

        function editGuest(guestId) {
            const guests = getGuests();
            const guest = guests.find(g => g.id === guestId);
            if (!guest) return;

            currentEditingGuestId = guestId;
            guestPhotos = guest.photos || [];
            const t = translations[currentLanguage];

            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.id = 'addGuestModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>${t.editGuest}</h3>
                        <button class="modal-close" onclick="closeModal()">√ó</button>
                    </div>
                    <form onsubmit="saveGuest(event)">
                        <div class="form-group">
                            <label>${t.guestName}</label>
                            <input type="text" id="guestName" required placeholder="Full name" value="${guest.name}">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>${t.guestEmail}</label>
                                <input type="email" id="guestEmail" placeholder="email@example.com" value="${guest.email || ''}">
                            </div>
                            <div class="form-group">
                                <label>${t.guestPhone}</label>
                                <input type="tel" id="guestPhone" placeholder="+39 xxx xxx xxxx" value="${guest.phone || ''}">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>${t.checkIn}</label>
                                <input type="date" id="guestCheckIn" required value="${guest.checkIn}" onchange="updateTouristTaxPreview()">
                            </div>
                            <div class="form-group">
                                <label>${t.checkOut}</label>
                                <input type="date" id="guestCheckOut" required value="${guest.checkOut}" onchange="updateTouristTaxPreview()">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>${t.guestAccompanied}</label>
                            <input type="number" id="guestAccompanied" placeholder="0" min="0" max="10" value="${guest.accompanied || 0}" onchange="updateAccompaniedGuestsForm(); updateTouristTaxPreview();">
                        </div>

                        <div id="accompaniedGuestsContainer"></div>

                        <div class="form-group">
                            <label>${t.guestPhotos}</label>
                            <button type="button" class="camera-btn" onclick="openGuestPhotoGallery()">üì∏ ${t.addPhotos}</button>
                            <input type="file" id="guestPhotoInput" accept="image/*" multiple onchange="handleGuestPhotos()">
                            <div id="guestPhotoPreview" class="image-gallery"></div>
                        </div>

                        <div class="tourist-tax-section">
                            <h4>${t.touristTaxSection}</h4>
                            <div class="tourist-tax-row">
                                <div>
                                    <label>${t.touristTaxAmount}</label>
                                    <input type="text" id="touristTaxAmount" disabled>
                                </div>
                                <div class="tourist-tax-paid">
                                    <input type="checkbox" id="touristTaxPaid">
                                    <label style="margin: 0;">${t.touristTaxPaid}</label>
                                </div>
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">${t.touristTaxCalculation}</div>
                        </div>

                        <div class="form-group">
                            <label>${t.guestNotes}</label>
                            <textarea id="guestNotes" rows="3">${guest.notes || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn-primary" style="width: 100%;">${t.saveGuest}</button>
                        </div>
                    </form>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = '';
            document.getElementById('modalContainer').appendChild(modal);
            modal.onclick = (e) => {
                if (e.target === modal) closeModal();
            };

            updateAccompaniedGuestsForm();
            displayGuestPhotos();
            updateTouristTaxPreview();
            document.getElementById('touristTaxPaid').checked = guest.touristTaxPaid || false;

            // Populate accompanied guests
            if (guest.accompaniedGuests && guest.accompaniedGuests.length > 0) {
                guest.accompaniedGuests.forEach((ag, idx) => {
                    const nameField = document.getElementById(`accompaniedGuestName${idx}`);
                    const surnameField = document.getElementById(`accompaniedGuestSurname${idx}`);
                    if (nameField) nameField.value = ag.name;
                    if (surnameField) surnameField.value = ag.surname;
                });
            }
        }

        function filterGuests() {
            const searchText = document.getElementById('guestSearchInput').value.toLowerCase();
            const dateFilter = document.getElementById('guestDateFilter').value;
            const statusFilter = document.getElementById('guestStatusFilter').value;
            const today = new Date();

            const guests = getGuests();
            filteredGuests = guests.filter(guest => {
                const matchesSearch = guest.name.toLowerCase().includes(searchText);
                const checkIn = new Date(guest.checkIn);
                const checkOut = new Date(guest.checkOut);

                let matchesStatus = true;
                if (statusFilter) {
                    if (statusFilter === 'upcoming' && checkIn <= today) matchesStatus = false;
                    if (statusFilter === 'current' && (today < checkIn || today >= checkOut)) matchesStatus = false;
                    if (statusFilter === 'completed' && checkOut > today) matchesStatus = false;
                }

                const matchesDate = !dateFilter || (dateFilter >= guest.checkIn && dateFilter < guest.checkOut);

                return matchesSearch && matchesStatus && matchesDate;
            });

            displayFilteredGuests();
        }

        function displayGuests() {
            filteredGuests = getGuests();
            displayFilteredGuests();
        }

        function displayFilteredGuests() {
            const listDiv = document.getElementById('guestsList');
            const t = translations[currentLanguage];

            if (filteredGuests.length === 0) {
                listDiv.innerHTML = '<div class="no-data">' + t.noGuests + '</div>';
                return;
            }

            listDiv.innerHTML = filteredGuests.map(guest => {
                const checkIn = new Date(guest.checkIn);
                const checkOut = new Date(guest.checkOut);
                const today = new Date();

                let status = 'upcoming';
                if (today >= checkIn && today < checkOut) status = 'current';
                if (today >= checkOut) status = 'completed';

                const statusText = { upcoming: t.upcoming, current: t.current, completed: t.completed }[status];
                const accompaniedText = guest.accompanied > 0 ? `+ ${guest.accompanied} ${t.guestGuests}` : '';

                let accompaniedInfo = '';
                if (guest.accompaniedGuests && guest.accompaniedGuests.length > 0) {
                    accompaniedInfo = '<div style="margin-top: 8px; font-size: 12px; color: var(--text-secondary);"><strong>Additional Guests:</strong><br>' +
                        guest.accompaniedGuests.map(ag => `${ag.name} ${ag.surname}`).join('<br>') +
                        '</div>';
                }

                const { tax } = computeTouristTax(guest);
                const taxPaidText = guest.touristTaxPaid ? '‚úì Yes' : '‚úó No';

                return `
                    <div class="guest-card">
                        <div class="guest-header">
                            <div class="guest-info" style="flex: 1;">
                                <h3>${guest.name} ${accompaniedText}</h3>
                                <div class="guest-dates">
                                    üìÖ ${checkIn.toLocaleDateString()} ‚Üí ${checkOut.toLocaleDateString()}
                                </div>
                                ${accompaniedInfo}
                                <span class="guest-status ${status}">${statusText}</span>
                            </div>
                        </div>
                        ${guest.photos && guest.photos.length > 0 ? `
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                                <strong style="font-size: 13px;">${t.guestPhotos}:</strong>
                                <div class="image-gallery">
                                    ${guest.photos.map((photo, idx) => `
                                        <div class="gallery-item">
                                            <img src="${photo}" alt="Guest photo">
                                            <button class="gallery-item-remove" onclick="removeGuestPhoto2(${guest.id}, ${idx})">√ó</button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); font-size: 13px;">
                            <strong>${t.touristTaxSection}:</strong><br>
                            EUR ${tax.toFixed(2)} ‚Ä¢ ${t.touristTaxPaid}: ${taxPaidText}
                        </div>
                        <div class="guest-documents">
                            <strong style="font-size: 13px;">üìÑ Documents:</strong>
                            <div style="margin-top: 8px;">
                                ${Object.entries(guest.documents || {}).length > 0 ? Object.entries(guest.documents).map(([docType, docs]) => `
                                    <div style="margin-bottom: 8px;">
                                        <div style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px;">${docType}</div>
                                        <div class="image-gallery">
                                            ${docs.map((doc, idx) => `
                                                <div class="gallery-item">
                                                    <img src="${doc}" alt="${docType}">
                                                    <button class="gallery-item-remove" onclick="removeGuestDocument(${guest.id}, '${docType}', ${idx})">√ó</button>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('') : '<div style="font-size: 12px; color: var(--text-secondary);">No documents</div>'}
                            </div>
                        </div>
                        <div class="guest-actions">
                            <button class="btn-primary" style="padding: 8px;" onclick="openAddDocumentModal(${guest.id})">üìÅ ${t.addDocuments}</button>
                            <button class="btn-secondary" style="padding: 8px;" onclick="editGuest(${guest.id})">‚úèÔ∏è ${t.editGuest}</button>
                            <button class="btn-danger" onclick="deleteGuest(${guest.id})">üóëÔ∏è ${t.deleteGuest}</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function removeGuestPhoto2(guestId, photoIdx) {
            let guests = getGuests();
            const guest = guests.find(g => g.id === guestId);
            if (guest && guest.photos) {
                guest.photos.splice(photoIdx, 1);
                saveGuests(guests);
            }
        }

        function openAddDocumentModal(guestId) {
            const t = translations[currentLanguage];
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>${t.addDocuments}</h3>
                        <button class="modal-close" onclick="closeModal()">√ó</button>
                    </div>
                    <div class="form-group">
                        <label>Document Type</label>
                        <select id="documentType">
                            <option value="ID/Passport">${t.idDocument}</option>
                            <option value="Tourist Tax Receipt">${t.touristTaxReceipt}</option>
                            <option value="Payment Receipt">${t.paymentReceipt}</option>
                            <option value="Check-in Photo">${t.checkInPhoto}</option>
                            <option value="Other Documents">${t.otherDoc}</option>
                        </select>
                    </div>
                    <button class="camera-btn" onclick="openDocumentCamera(${guestId})">üì∏ ${t.uploadDocument}</button>
                    <input type="file" id="documentInput" accept="image/*" onchange="handleDocumentUpload(${guestId})">
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = '';
            document.getElementById('modalContainer').appendChild(modal);
            modal.onclick = (e) => {
                if (e.target === modal) closeModal();
            };
        }

        function openDocumentCamera(guestId) {
            document.getElementById('documentInput').click();
        }

        function handleDocumentUpload(guestId) {
            const file = document.getElementById('documentInput').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const docType = document.getElementById('documentType').value;
                    let guests = getGuests();
                    const guest = guests.find(g => g.id === guestId);
                    if (guest) {
                        if (!guest.documents) guest.documents = {};
                        if (!guest.documents[docType]) guest.documents[docType] = [];
                        guest.documents[docType].push(e.target.result);
                        saveGuests(guests);
                        closeModal();
                        showNotification(translations[currentLanguage].documentAdded);
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        function removeGuestDocument(guestId, docType, docIdx) {
            let guests = getGuests();
            const guest = guests.find(g => g.id === guestId);
            if (guest && guest.documents && guest.documents[docType]) {
                guest.documents[docType].splice(docIdx, 1);
                if (guest.documents[docType].length === 0) delete guest.documents[docType];
                saveGuests(guests);
            }
        }

        function closeModal() {
            document.getElementById('modalContainer').innerHTML = '';
        }

        // ============ CALENDAR FUNCTIONS ============
        function renderCalendar() {
          // ... code ...
          const calendarDays = document.getElementById('calendarDays')
          calendarDays.innerHTML = ''
          
          // Loop through days
          for (let i = 0; i < firstDay; i++) {
            const emptyDay = document.createElement('div')
            emptyDay.className = 'calendar-day other-month'
            emptyDay.textContent = ''
            calendarDays.appendChild(emptyDay)
          }
          
          for (let day = 1; day <= daysInMonth; day++) {
            const dayElement = document.createElement('div')
            dayElement.className = 'calendar-day'
            
            // ‚úÖ ADD THIS LOGIC ‚úÖ
            // Check if day is occupied, cleaning, or available
            const dateString = `${currentCalendarDate.getFullYear()}-${String(currentCalendarDate.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`
            
            if (occupiedDates && occupiedDates.includes(dateString)) {
              dayElement.classList.add('occupied')
            } else if (cleaningDates && cleaningDates.includes(dateString)) {
              dayElement.classList.add('cleaning')
            } else {
              dayElement.classList.add('available')
            }
            // ‚úÖ END NEW CODE ‚úÖ
            
            dayElement.textContent = day
            calendarDays.appendChild(dayElement)
          }
        }
        

        function openCalendarStatusModal(dateStr) {
            const calendar = getCalendarData();
            const currentStatus = calendar[dateStr] || 'available';
            const t = translations[currentLanguage];

            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Set Status for ${dateStr}</h3>
                        <button class="modal-close" onclick="closeModal()">√ó</button>
                    </div>
                    <div class="day-status-selector">
                        <div class="status-option ${currentStatus === 'available' ? 'selected' : ''}" onclick="updateCalendarStatus('${dateStr}', 'available')">
                            üü¢ ${t.available}
                        </div>
                        <div class="status-option ${currentStatus === 'occupied' ? 'selected' : ''}" onclick="updateCalendarStatus('${dateStr}', 'occupied')">
                            üî¥ ${t.occupied}
                        </div>
                        <div class="status-option ${currentStatus === 'cleaning' ? 'selected' : ''}" onclick="updateCalendarStatus('${dateStr}', 'cleaning')">
                            üü† ${t.cleaning}
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = '';
            document.getElementById('modalContainer').appendChild(modal);
            modal.onclick = (e) => {
                if (e.target === modal) closeModal();
            };
        }

        function updateCalendarStatus(dateStr, status) {
            const calendar = getCalendarData();
            if (status === 'available') {
                delete calendar[dateStr];
            } else {
                calendar[dateStr] = status;
            }
            saveCalendarData(calendar);
            closeModal();
        }

        function previousMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar();
        }

        // ============ AUTH & UI FUNCTIONS ============

        function validateTOTP() {
            const inputs = document.querySelectorAll('.totp-digit');
            const code = Array.from(inputs).map(i => i.value).join('');
            const errorEl = document.getElementById('errorMessage');
        
            if (!selectedUsername) {
                if (errorEl) errorEl.textContent = '‚ùå Select a user first';
                return;
            }
        
            if (code.length !== 6) {
                if (errorEl) errorEl.textContent = '‚ùå Enter all 6 digits';
                return;
            }
        
            const username = selectedUsername; // 'davide' or 'mattia'
            const ok = verifyTOTP(code, username);
        
            if (!ok) {
                if (errorEl) errorEl.textContent = '‚ùå Invalid code ‚Äì try again';
                return;
            }
        
            // SUCCESS: unlock app
            currentUser = username === 'davide' ? 'Davide' : 'Mattia';
        
            const authScreen = document.getElementById('authScreen');
            const mainApp = document.getElementById('mainApp');
            if (authScreen) authScreen.style.display = 'none';
            if (mainApp) mainApp.style.display = 'block';
            document.body.classList.remove('locked');
        
            // header user badge
            const userIconEl = document.getElementById('userIcon');
            const userNameEl = document.getElementById('userName');
            if (userIconEl) userIconEl.textContent = username === 'davide' ? 'üë®' : 'üë®‚Äçü¶±';
            if (userNameEl) userNameEl.textContent = currentUser;
        
            if (errorEl) errorEl.textContent = '';
        }

        function selectUser(username, ev) {
            const e = ev || window.event;
            document.querySelectorAll('.user-btn').forEach(btn => btn.classList.remove('selected'));
            if (e && e.currentTarget) {
                e.currentTarget.classList.add('selected');
            }
            selectedUsername = username;
            const errorEl = document.getElementById('errorMessage');
            if (errorEl) errorEl.textContent = '';
        }
        
        function verifyTOTP(token, username) {
    const TOTP_SECRET_DAVIDE = 'JBSWY3DPEHPK3PXP';
    const TOTP_SECRET_MATTIA = 'JBSWY3DPEHPK3PXP';
    
    const secret = username === 'davide' ? TOTP_SECRET_DAVIDE : TOTP_SECRET_MATTIA;
    
    try {
        const secretBytes = base32Decode(secret);
        const now = Math.floor(Date.now() / 1000);
        
        // Check current time window and ¬±1 window (¬±30 seconds tolerance)
        for (let i = -1; i <= 1; i++) {
            const counter = Math.floor(now / 30) + i;
            const counterHex = ('0000000000000000' + counter.toString(16)).slice(-16);
            const counterBytes = hexToBytes(counterHex);
            
            // Use CryptoJS correctly
            const hmacObj = CryptoJS.HmacSHA1(
                CryptoJS.enc.Hex.parse(counterHex),
                CryptoJS.enc.Hex.parse(bytesToHex(secretBytes))
            );
            
            const hmacBytes = hexToBytes(hmacObj.toString());
            const offset = hmacBytes[hmacBytes.length - 1] & 0x0f;
            const value = (
                ((hmacBytes[offset] & 0x7f) << 24) |
                ((hmacBytes[offset + 1] & 0xff) << 16) |
                ((hmacBytes[offset + 2] & 0xff) << 8) |
                (hmacBytes[offset + 3] & 0xff)
            );
            
            const code = (value % 1000000).toString().padStart(6, '0');
            
            if (code === token) {
                console.log('‚úÖ TOTP code verified');
                return true;
            }
        }
        
        console.log('‚ùå TOTP code did not match any time window');
        return false;
    } catch (e) {
        console.error('‚ùå TOTP verification error:', e.message);
        return false;
    }
}

function bytesToHex(bytes) {
    let hex = '';
    for (let i = 0; i < bytes.length; i++) {
        hex += ('0' + bytes[i].toString(16)).slice(-2);
    }
    return hex;
}

        // ============ TOTP SETUP ============
function setupTOTPInput() {
    const inputs = document.querySelectorAll('.totp-digit');
    inputs.forEach((input, index) => {
        input.addEventListener('input', (e) => {
            if (e.target.value && index < inputs.length - 1) {
                inputs[index + 1].focus();
            }
        });
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace' && !e.target.value && index > 0) {
                inputs[index - 1].focus();
            }
            if (e.key === 'Enter') {
                validateTOTP();
            }
        });
    });
}

function validateTOTP() {
    const inputs = document.querySelectorAll('.totp-digit');
    const code = Array.from(inputs).map(i => i.value).join('');
    const errorEl = document.getElementById('errorMessage');

    if (!selectedUsername) {
        if (errorEl) errorEl.textContent = '‚ùå Select a user first';
        return;
    }

    if (code.length !== 6) {
        if (errorEl) errorEl.textContent = '‚ùå Enter all 6 digits';
        return;
    }

    const ok = verifyTOTP(code, selectedUsername);

    if (!ok) {
        if (errorEl) errorEl.textContent = '‚ùå Invalid code ‚Äì try again';
        // Clear inputs
        inputs.forEach(i => i.value = '');
        inputs[0].focus();
        return;
    }

// SUCCESS: unlock app - SHOW APP INSTANTLY
currentUser = selectedUsername === 'Davide' ? 'Davide' : 'Mattia';

const authScreen = document.getElementById('authScreen');
const mainApp = document.getElementById('mainApp');
if (authScreen) authScreen.style.display = 'none';
if (mainApp) {
  mainApp.style.display = 'block';
  mainApp.style.zIndex = '10';
}
document.body.classList.remove('locked');

// Update header user badge
const userIconEl = document.getElementById('userIcon');
const userNameEl = document.getElementById('userName');
if (userIconEl) userIconEl.textContent = selectedUsername === 'Davide' ? 'üë®' : 'üë®‚Äçü¶±';
if (userNameEl) userNameEl.textContent = currentUser;

if (errorEl) errorEl.textContent = '';

console.log('‚úÖ App loaded from localStorage');

// Load data from localStorage INSTANTLY
displayExpenses()
displaySettlement()
displayGuests()

// Start Firebase sync in BACKGROUND (don't wait)
console.log('üîÑ Starting Firebase sync...')
if (isFirebaseReady) {
  setTimeout(() => setupFirebaseListeners(), 100)
}

    
    // Load data
    displayExpenses();
    displaySettlement();
    displayGuests();
    setTimeout(() => setupFirebaseListeners(), 100)
}        
        function verifyTOTP(token, username) {
            const TOTP_SECRET_DAVIDE = 'JBSWY3DPEHPK3PXP';
            const TOTP_SECRET_MATTIA = 'JBSWY3DPEHPK3PXP';
            
            const secret = username === 'davide' ? TOTP_SECRET_DAVIDE : TOTP_SECRET_MATTIA;
            
            try {
                const secretBytes = base32Decode(secret);
                const now = Math.floor(Date.now() / 1000);
                
                // Check current time window and ¬±1 window (¬±30 seconds tolerance)
                for (let i = -1; i <= 1; i++) {
                    const counter = Math.floor(now / 30) + i;
                    const counterHex = ('0000000000000000' + counter.toString(16)).slice(-16);
                    const counterBytes = hexToBytes(counterHex);
                    
                    const hmac = CryptoJS.HmacSHA1(
                        CryptoJS.enc.Latin1.parse(String.fromCharCode(...counterBytes)),
                        CryptoJS.enc.Latin1.parse(base32DecodeToString(secret))
                    );
                    
                    const hmacBytes = hexToBytes(hmac.toString());
                    const offset = hmacBytes[hmacBytes.length - 1] & 0x0f;
                    const value = (
                        ((hmacBytes[offset] & 0x7f) << 24) |
                        ((hmacBytes[offset + 1] & 0xff) << 16) |
                        ((hmacBytes[offset + 2] & 0xff) << 8) |
                        (hmacBytes[offset + 3] & 0xff)
                    );
                    
                    const code = (value % 1000000).toString().padStart(6, '0');
                    
                    if (code === token) {
                        console.log('‚úÖ TOTP code verified');
                        return true;
                    }
                }
                
                return false;
            } catch (e) {
                console.error('‚ùå TOTP verification error:', e.message);
                return false;
            }
        }
        
        function base32Decode(str) {
            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
            let bits = 0;
            let value = 0;
            const result = [];
            
            for (let i = 0; i < str.length; i++) {
                const index = alphabet.indexOf(str[i].toUpperCase());
                if (index === -1) throw new Error('Invalid base32 character');
                
                value = (value << 5) | index;
                bits += 5;
                
                if (bits >= 8) {
                    bits -= 8;
                    result.push((value >> bits) & 0xff);
                }
            }
            
            return result;
        }
        
        function base32DecodeToString(str) {
            return String.fromCharCode(...base32Decode(str));
        }
        
        function hexToBytes(hex) {
            const bytes = [];
            for (let i = 0; i < hex.length; i += 2) {
                bytes.push(parseInt(hex.substr(i, 2), 16));
            }
            return bytes;
        }
        
        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.querySelectorAll('.totp-digit').forEach(input => input.value = '');
            document.getElementById('errorMessage').textContent = '';
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'guests') displayGuests();
            if (tabName === 'calendar') renderCalendar();
        }

        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('language', lang);
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            if (lang === 'en') document.getElementById('langEnBtn').classList.add('active');
            else document.getElementById('langItBtn').classList.add('active');
            updateTranslations();
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', currentTheme);
            localStorage.setItem('theme', currentTheme);
        }

        function setupFirebaseListeners() {
            if (!isFirebaseReady || listenersSetup) return;

            db.ref('shared/expenses').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    localStorage.setItem('expenses_shared', JSON.stringify(data));
                    displayExpenses();
                    displaySettlement();
                }
            });

            db.ref('shared/guests').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    localStorage.setItem('guests_shared', JSON.stringify(data));
                    displayGuests();
                }
            });

            db.ref('shared/calendar').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    localStorage.setItem('calendar_shared', JSON.stringify(data));
                    renderCalendar();
                }
            });

            listenersSetup = true;
        }

        function generateAndDownloadReport() {
            const period = document.getElementById('expensePeriod').value;
            const expenses = getExpenses();
            const cutoffDate = new Date();
            cutoffDate.setMonth(cutoffDate.getMonth() - parseInt(period));

            const filtered = expenses.filter(e => new Date(e.date) >= cutoffDate);
            let report = 'CHILLINGUITO LAKE COMO - EXPENSE REPORT\n\n';
            report += filtered.map(e => `${e.date}: ${e.description} - EUR ${e.amount.toFixed(2)} (${e.paidBy})`).join('\n');

            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'chillinguito-report.txt';
            a.click();
        }

        // ============ INIT ============
        document.addEventListener('DOMContentLoaded', function() {
            const theme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', theme);
            
            // Setup TOTP input
            setupTOTPInput();
            // Setup button event listeners
document.querySelectorAll('.user-choice').forEach(button => {
    button.addEventListener('click', function() {
        selectedUsername = this.dataset.user;
        
        // Update active state
        document.querySelectorAll('.user-choice').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        // Auto-focus first code input
        document.querySelector('.code-box').focus();
    });
});

// Setup unlock button
document.getElementById('unlockBtn').addEventListener('click', function() {
    const inputs = document.querySelectorAll('.code-box');
    const code = Array.from(inputs).map(i => i.value).join('');
    
    if (!selectedUsername) {
        document.getElementById('errorMsg').textContent = 'Select a user first';
        return;
    }
    
    if (code.length !== 6) {
        document.getElementById('errorMsg').textContent = 'Enter all 6 digits';
        return;
    }
    
    const username = selectedUsername === 'davide' ? 'Davide' : 'Mattia';
    const ok = verifyTOTP(code, username);
    
    if (!ok) {
        document.getElementById('errorMsg').textContent = 'Invalid code, try again';
        return;
    }
    
    // SUCCESS - unlock app
    currentUser = username;
    const authScreen = document.getElementById('authScreen');
    const mainApp = document.getElementById('mainApp');
    
    if (authScreen) authScreen.style.display = 'none';
    if (mainApp) mainApp.style.display = 'block';
    document.body.classList.remove('locked');
    
    // Update header user badge
    const userIconEl = document.getElementById('userIcon');
    const userNameEl = document.getElementById('userName');
    if (userIconEl) userIconEl.textContent = selectedUsername === 'davide' ? 'üë®' : 'üë®';
    if (userNameEl) userNameEl.textContent = currentUser;
    
    displayExpenses();
    displaySettlement();
    displayGuests();
    setTimeout(() => setupFirebaseListeners(), 100);
});

// Setup code input auto-advance
document.querySelectorAll('.code-box').forEach((input, index) => {
    input.addEventListener('input', function() {
        if (this.value.length === 1 && index < 5) {
            document.querySelectorAll('.code-box')[index + 1].focus();
        }
    });
    
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Backspace' && !this.value && index > 0) {
            document.querySelectorAll('.code-box')[index - 1].focus();
        }
    });
});
            // Auth screen shown by default
            const authScreen = document.getElementById('authScreen');
            const mainApp = document.getElementById('mainApp');
            
            authScreen.style.display = 'flex';  // Show auth
            mainApp.style.display = 'none';      // Hide main until authenticated
            document.body.classList.add('locked');
        }); 
    </script>
</body>
</html>
